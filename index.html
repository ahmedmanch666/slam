<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مدير المناقصات والعقود والمبيعات</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%236366f1' rx='20' width='100' height='100'/%3E%3Ctext x='50' y='65' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3Eم%3C/text%3E%3C/svg%3E" />
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      color-scheme: light;
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-gradient-soft: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.3);
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg-gradient-soft);
    }

    /* Premium Shadows */
    .shadow-soft {
      box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .shadow-glow {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    .shadow-card {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.02);
    }

    /* Glassmorphism */
    .glass {
      background: var(--glass-bg);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .glass-dark {
      background: rgba(15, 23, 42, 0.85);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
    }

    /* Gradient Text */
    .gradient-text {
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient Buttons */
    .btn-gradient {
      background: var(--bg-gradient);
      color: white;
      border: none;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-gradient:hover::before {
      left: 100%;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse-soft {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .animate-fadeInUp {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    .animate-slideInRight {
      animation: slideInRight 0.4s ease-out forwards;
    }

    .animate-pulse-soft {
      animation: pulse-soft 2s ease-in-out infinite;
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    /* Hover Effects */
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
    }

    /* Card Styles */
    .card-modern {
      background: white;
      border-radius: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .card-modern:hover {
      border-color: rgba(99, 102, 241, 0.2);
    }

    /* Input Styles */
    .input-modern {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      outline: none;
    }

    /* Badge Styles */
    .badge-gradient {
      background: var(--bg-gradient);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Table Styles */
    .table-modern {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-modern th {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
    }

    .table-modern tr:hover td {
      background: #f8fafc;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4f46e5;
    }

    /* Other utilities */
    .grid-autofit {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    input[type="date"],
    input[type="datetime-local"],
    select {
      color-scheme: light;
    }

    textarea {
      resize: vertical;
    }

    /* Loading Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="app" class="min-h-screen"></div>

  <template id="tpl-shell">
    <div class="min-h-screen flex flex-row-reverse" data-shell>
      <aside id="sidebar"
        class="hidden md:flex w-80 max-w-[85vw] bg-white border-l border-slate-200 p-4 flex-col gap-4 nav-aside">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-lg font-bold">مدير المناقصات والعقود</h1>
            <p class="text-xs text-slate-500 mt-1">نسخة أوفلاين (نموذج + مولّد مشروع Android)</p>
          </div>
          <span
            class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">محلي</span>
        </div>

        <div class="relative">
          <input id="navSearch" type="search" placeholder="بحث في القائمة..."
            class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300" />
        </div>

        <div id="navSidebar" class="flex flex-col gap-2 overflow-auto nav-scroll"></div>

        <div class="mt-auto text-xs text-slate-500 leading-6">
          <div class="flex items-center justify-between">
            <span>حالة التخزين:</span>
            <span id="storageState" class="font-semibold">—</span>
          </div>
          <div class="flex items-center justify-between">
            <span>آخر حفظ:</span>
            <span id="lastSaved" class="font-semibold">—</span>
          </div>
          <div class="mt-2 p-2 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">
            هذا نموذج ويب لتجربة الفكرة. زر <b>مشروع Android</b> يقوم بتوليد هيكل مشروع Kotlin/Compose/Room قابل
            للتشغيل.
          </div>
        </div>
      </aside>

      <main class="flex-1 p-4 pb-24 md:p-8 md:pb-8 md:mr-80 nav-main overflow-x-hidden">
        <div class="w-full max-w-full min-w-0 md:max-w-6xl mx-auto">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 id="pageTitle" class="text-xl font-bold"></h2>
              <p id="pageSubtitle" class="text-sm text-slate-600 mt-1"></p>
            </div>
            <div id="pageActions" class="flex items-center gap-2"></div>
          </div>

          <div id="content" class="mt-6"></div>

          <footer class="mt-10 text-xs text-slate-500">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>واجهة عربية RTL • تخزين محلي • بدون حسابات • بدون سيرفر</div>
              <div class="kbd">v1.0-prototype</div>
            </div>
          </footer>
        </div>
      </main>

      <div id="navMobile" class="md:hidden"></div>
    </div>
  </template>

  <template id="tpl-modal">
    <div class="fixed inset-0 z-[9999]" data-app-modal>
      <div class="absolute inset-0 bg-slate-900/40" data-close></div>
      <div class="absolute inset-0 flex items-end md:items-center justify-center p-0 md:p-6">
        <div
          class="w-full md:w-[560px] md:max-w-[92vw] bg-white shadow-soft border border-slate-200 rounded-t-2xl md:rounded-2xl flex flex-col"
          data-app-modal-card>
          <div class="p-4 border-b border-slate-200 flex items-start justify-between gap-3 min-w-0">
            <div class="min-w-0">
              <h3 class="text-base font-bold" data-title></h3>
              <p class="text-xs text-slate-500 mt-1" data-subtitle></p>
            </div>
            <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-close>إغلاق</button>
          </div>
          <div class="p-4 overflow-auto" data-body></div>
          <div class="p-4 border-t border-slate-200 flex items-center justify-between gap-2 min-w-0"
            data-app-modal-footer>
            <div class="text-xs text-slate-500" data-hint></div>
            <div class="flex items-center gap-2">
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-cancel>إلغاء</button>
              <button class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" data-ok>حفظ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-empty">
    <div class="border border-dashed border-slate-300 rounded-2xl p-8 bg-white text-center">
      <div class="text-lg font-bold">لا توجد بيانات بعد</div>
      <div class="text-sm text-slate-600 mt-2" data-msg></div>
      <div class="mt-5" data-actions></div>
    </div>
  </template>

  <script>
    // =============================
    // Utilities
    // =============================
    const $ = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

    const nowTs = () => Date.now();
    const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + "_" + Date.now()));

    const pad2 = (n) => String(n).padStart(2, '0');
    const toISODate = (ts) => {
      if (!ts) return '';
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    };
    const fromISODate = (s) => {
      if (!s) return null;
      const [y, m, d] = s.split('-').map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
    };
    const toISODatetimeLocal = (ts) => {
      if (!ts) return '';
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };
    const fromISODatetimeLocal = (s) => {
      if (!s) return null;
      const d = new Date(s);
      const t = d.getTime();
      return Number.isFinite(t) ? t : null;
    };

    const fmtDate = (ts) => ts ? new Intl.DateTimeFormat('ar', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(ts)) : '—';
    const fmtDateTime = (ts) => ts ? new Intl.DateTimeFormat('ar', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).format(new Date(ts)) : '—';

    const startOfDay = (ts) => {
      const d = new Date(ts);
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    };

    const daysFromNow = (n) => startOfDay(Date.now() + n * 24 * 60 * 60 * 1000);

    const escapeHtml = (s) => (s ?? '').toString().replace(/[&<>"']+/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c] || c));

    // =============================
    // Local store (LocalStorage JSON)
    // =============================
    const STORE_KEY = 'tcrm_offline_v1';
    const AUTH_KEY = 'tcrm_auth_v1';
    const defaultState = () => ({
      meta: { lastSavedAt: null },
      companies: [],
      contacts: [],
      tenders: [],
      contracts: [],
      tasks: [],
      followups: [],
      settings: {
        // Android generator settings
        android: {
          appName: 'مدير المناقصات والعقود',
          applicationId: 'com.example.tendercrm',
          packageName: 'com.example.tendercrm',
          minSdk: 26,
          targetSdk: 35,
          kotlinVersion: '2.0.21',
          agpVersion: '8.5.2',
          composeBom: '2024.10.00',
          roomVersion: '2.6.1',
          workVersion: '2.9.1',
          navVersion: '2.8.4',
          serializationVersion: '1.7.3'
        }
      }
    });

    function loadState() {
      try {
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return defaultState();
        const st = JSON.parse(raw);
        return { ...defaultState(), ...st, settings: { ...defaultState().settings, ...(st.settings || {}) } };
      } catch {
        return defaultState();
      }
    }

    function saveState(st) {
      st.meta = st.meta || {};
      st.meta.lastSavedAt = nowTs();
      localStorage.setItem(STORE_KEY, JSON.stringify(st));
      renderShellMeta();
    }

    let syncTimeout = null;
    function scheduleSyncToServer() {
      if (syncTimeout) clearTimeout(syncTimeout);
      syncTimeout = setTimeout(() => syncAllToServer(), 2000);
    }

    async function syncAllToServer() {
      if (!authState?.accessToken) return;

      const types = ['companies', 'tenders', 'contracts', 'tasks', 'contacts', 'followups'];
      for (const type of types) {
        const items = state[type] || [];
        for (const item of items) {
          try {
            await apiFetch(`/api/data/${type}`, {
              method: 'POST',
              body: JSON.stringify(convertToServerFormat(type, item))
            });
          } catch (err) {
            console.error(`Sync error for ${type}:`, err);
          }
        }
      }
      console.log('Synced to server');
    }

    let state = loadState();

    function loadAuth() {
      try {
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) return { accessToken: null, refreshToken: null, role: null, email: null };
        const a = JSON.parse(raw);
        return { accessToken: a.accessToken || null, refreshToken: a.refreshToken || null, role: a.role || null, email: a.email || null };
      } catch {
        return { accessToken: null, refreshToken: null, role: null, email: null };
      }
    }

    function saveAuth(auth) {
      localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    }

    function clearAuth() {
      try { localStorage.removeItem(AUTH_KEY); } catch { }
    }

    let authState = loadAuth();

    const API_BASE = window.__API_BASE__ || "http://localhost:4000";

    async function apiFetch(path, opts = {}) {
      const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
      const headers = new Headers(opts.headers || {});
      if (!headers.has('Content-Type') && opts.body) headers.set('Content-Type', 'application/json');
      if (authState?.accessToken) headers.set('Authorization', `Bearer ${authState.accessToken}`);

      const doReq = async () => {
        const res = await fetch(url, { ...opts, headers, credentials: 'include' });
        return res;
      };

      let res = await doReq();
      if (res.status !== 401) return res;

      if (!authState?.refreshToken) return res;
      const refreshed = await refreshAccessToken();
      if (!refreshed) return res;
      headers.set('Authorization', `Bearer ${authState.accessToken}`);
      return await doReq();
    }

    async function refreshAccessToken() {
      try {
        const res = await fetch(`${API_BASE}/api/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ refreshToken: authState.refreshToken })
        });
        if (!res.ok) return false;
        const data = await res.json();
        if (!data?.accessToken) return false;
        authState = { ...authState, accessToken: data.accessToken };
        saveAuth(authState);
        return true;
      } catch {
        return false;
      }
    }

    async function logoutServer() {
      try {
        if (!authState?.refreshToken) return;
        await fetch(`${API_BASE}/api/auth/logout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ refreshToken: authState.refreshToken })
        });
      } catch { }
    }

    // =============================
    // Server Sync Functions
    // =============================
    let syncInProgress = false;

    async function loadDataFromServer() {
      if (!authState?.accessToken) return;

      try {
        const endpoints = ['companies', 'tenders', 'contracts', 'tasks', 'contacts', 'followups'];
        const results = await Promise.all(
          endpoints.map(async (type) => {
            const res = await apiFetch(`/api/data/${type}`);
            if (res.ok) {
              const data = await res.json();
              return { type, data: data[type] || [] };
            }
            return { type, data: [] };
          })
        );

        results.forEach(({ type, data }) => {
          state[type] = data;
        });

        saveState(state);
        console.log('Data loaded from server');
      } catch (err) {
        console.error('Failed to load data from server:', err);
      }
    }

    async function saveItemToServer(type, item, method = 'POST') {
      if (!authState?.accessToken) return false;

      try {
        const res = await apiFetch(`/api/data/${type}`, {
          method,
          body: JSON.stringify(item)
        });
        return res.ok;
      } catch (err) {
        console.error(`Failed to save ${type}:`, err);
        return false;
      }
    }

    async function deleteItemFromServer(type, id) {
      if (!authState?.accessToken) return false;

      try {
        const res = await apiFetch(`/api/data/${type}`, {
          method: 'DELETE',
          body: JSON.stringify({ id })
        });
        return res.ok;
      } catch (err) {
        console.error(`Failed to delete ${type}:`, err);
        return false;
      }
    }

    // Enhanced save functions that sync with server
    async function addItem(type, item) {
      item.id = item.id || uuid();
      item.createdAt = item.createdAt || nowTs();
      state[type].push(item);
      saveState(state);

      // Sync to server in background
      saveItemToServer(type, convertToServerFormat(type, item));
      return item;
    }

    async function updateItem(type, id, updates) {
      const idx = state[type].findIndex(x => x.id === id);
      if (idx === -1) return null;

      state[type][idx] = { ...state[type][idx], ...updates, updatedAt: nowTs() };
      saveState(state);

      // Sync to server in background
      saveItemToServer(type, convertToServerFormat(type, state[type][idx]), 'PUT');
      return state[type][idx];
    }

    async function removeItem(type, id) {
      state[type] = state[type].filter(x => x.id !== id);
      saveState(state);

      // Sync to server in background
      deleteItemFromServer(type, id);
    }

    function convertToServerFormat(type, item) {
      // Convert camelCase to snake_case for server
      const result = { id: item.id };

      if (type === 'companies') {
        result.name = item.name;
        result.phone = item.phone1 || item.phone;
        result.phone1 = item.phone1;
        result.phone2 = item.phone2;
        result.email = item.email;
        result.address = item.address;
        result.notes = item.notes;
        result.sector = item.sector;
      } else if (type === 'tenders') {
        result.company_id = item.companyId;
        result.title = item.title;
        result.type = item.type;
        result.status = item.status;
        result.value = item.value;
        result.submission_date = item.submissionDate;
        result.notes = item.notes;
      } else if (type === 'contracts') {
        result.company_id = item.companyId;
        result.tender_id = item.tenderId;
        result.title = item.title;
        result.status = item.status;
        result.value = item.value;
        result.start_date = item.startDate;
        result.end_date = item.endDate;
        result.notes = item.notes;
      } else if (type === 'tasks') {
        result.related_type = item.relatedType;
        result.related_id = item.relatedId;
        result.title = item.title;
        result.priority = item.priority;
        result.status = item.status;
        result.due_date = item.dueDate;
        result.notes = item.notes;
      } else if (type === 'contacts') {
        result.company_id = item.companyId;
        result.name = item.name;
        result.position = item.position;
        result.phone = item.phone;
        result.email = item.email;
        result.notes = item.notes;
      } else if (type === 'followups') {
        result.related_type = item.relatedType;
        result.related_id = item.relatedId;
        result.type = item.type;
        result.date = item.date;
        result.notes = item.notes;
      }

      return result;
    }

    function convertFromServerFormat(type, item) {
      // Convert snake_case to camelCase from server
      const result = { id: item.id, createdAt: item.created_at };

      if (type === 'companies') {
        result.name = item.name;
        result.phone = item.phone;
        result.email = item.email;
        result.address = item.address;
        result.notes = item.notes;
        result.updatedAt = item.updated_at;
      } else if (type === 'tenders') {
        result.companyId = item.company_id;
        result.title = item.title;
        result.type = item.type;
        result.status = item.status;
        result.value = item.value;
        result.submissionDate = item.submission_date;
        result.notes = item.notes;
      } else if (type === 'contracts') {
        result.companyId = item.company_id;
        result.tenderId = item.tender_id;
        result.title = item.title;
        result.status = item.status;
        result.value = item.value;
        result.startDate = item.start_date;
        result.endDate = item.end_date;
        result.notes = item.notes;
      } else if (type === 'tasks') {
        result.relatedType = item.related_type;
        result.relatedId = item.related_id;
        result.title = item.title;
        result.priority = item.priority;
        result.status = item.status;
        result.dueDate = item.due_date;
        result.notes = item.notes;
      } else if (type === 'contacts') {
        result.companyId = item.company_id;
        result.name = item.name;
        result.position = item.position;
        result.phone = item.phone;
        result.email = item.email;
        result.notes = item.notes;
      } else if (type === 'followups') {
        result.relatedType = item.related_type;
        result.relatedId = item.related_id;
        result.type = item.type;
        result.date = item.date;
        result.notes = item.notes;
      }

      return result;
    }

    async function loadDataFromServerFormatted() {
      if (!authState?.accessToken) return;

      try {
        const endpoints = ['companies', 'tenders', 'contracts', 'tasks', 'contacts', 'followups'];
        const results = await Promise.all(
          endpoints.map(async (type) => {
            const res = await apiFetch(`/api/data/${type}`);
            if (res.ok) {
              const data = await res.json();
              const items = data[type] || [];
              return { type, data: items.map(item => convertFromServerFormat(type, item)) };
            }
            return { type, data: [] };
          })
        );

        results.forEach(({ type, data }) => {
          if (data.length > 0) {
            state[type] = data;
          }
        });

        saveState(state);
        console.log('Data loaded from server');
      } catch (err) {
        console.error('Failed to load data from server:', err);
      }
    }

    function renderShellMeta() {
      const size = new Blob([localStorage.getItem(STORE_KEY) || '']).size;
      const storageState = $('#storageState');
      const lastSaved = $('#lastSaved');
      if (storageState) storageState.textContent = `${(size / 1024).toFixed(1)} KB`;
      if (lastSaved) lastSaved.textContent = state?.meta?.lastSavedAt ? fmtDateTime(state.meta.lastSavedAt) : '—';
    }

    // =============================
    // Domain helpers
    // =============================
    const Enums = {
      TenderType: ['TENDER', 'PRACTICE', 'CONTRACT', 'DIRECT_SALE'],
      TenderStatus: ['PREPARATION', 'OFFER_IN_PROGRESS', 'SUBMITTED', 'AWARDED', 'LOST', 'IN_PROGRESS', 'COMPLETED'],
      ContractStatus: ['ACTIVE', 'EXPIRED', 'SUSPENDED'],
      TaskPriority: ['HIGH', 'MEDIUM', 'LOW'],
      TaskStatus: ['NEW', 'IN_PROGRESS', 'DONE', 'OVERDUE'],
      RelatedType: ['COMPANY', 'TENDER', 'CONTRACT'],
      FollowUpType: ['CALL', 'VISIT', 'EMAIL', 'WHATSAPP', 'OTHER']
    };

    const labels = {
      TenderType: { TENDER: 'مناقصة', PRACTICE: 'ممارسة', CONTRACT: 'تعاقد', DIRECT_SALE: 'بيع مباشر' },
      TenderStatus: {
        PREPARATION: 'تحضير',
        OFFER_IN_PROGRESS: 'إعداد العرض',
        SUBMITTED: 'تم التقديم',
        AWARDED: 'ترسية',
        LOST: 'خسارة',
        IN_PROGRESS: 'قيد التنفيذ',
        COMPLETED: 'مكتمل'
      },
      ContractStatus: { ACTIVE: 'ساري', EXPIRED: 'منتهي', SUSPENDED: 'موقوف' },
      TaskPriority: { HIGH: 'عالية', MEDIUM: 'متوسطة', LOW: 'منخفضة' },
      TaskStatus: { NEW: 'جديدة', IN_PROGRESS: 'قيد التنفيذ', DONE: 'منتهية', OVERDUE: 'متأخرة' },
      RelatedType: { COMPANY: 'شركة', TENDER: 'مناقصة', CONTRACT: 'عقد' },
      FollowUpType: { CALL: 'اتصال', VISIT: 'زيارة', EMAIL: 'بريد', WHATSAPP: 'واتساب', OTHER: 'أخرى' }
    };

    function getCompanyName(companyId) {
      return state.companies.find(c => c.id === companyId)?.name || '—';
    }
    function getTenderTitle(tenderId) {
      return state.tenders.find(t => t.id === tenderId)?.title || '—';
    }
    function getContractTitle(contractId) {
      return state.contracts.find(c => c.id === contractId)?.title || '—';
    }

    function computeTaskStatus(task) {
      if (task.status === 'DONE') return 'DONE';
      const due = task.dueDate;
      if (!due) return task.status || 'NEW';
      if (startOfDay(due) < startOfDay(nowTs())) return 'OVERDUE';
      return task.status || 'NEW';
    }

    function normalizeTasksStatuses() {
      let changed = false;
      state.tasks = state.tasks.map(t => {
        const s = computeTaskStatus(t);
        if (t.status !== s) { changed = true; return { ...t, status: s, updatedAt: nowTs() }; }
        return t;
      });
      if (changed) saveState(state);
    }

    // =============================
    // UI components helpers
    // =============================
    function setPage(title, subtitle, actions = []) {
      $('#pageTitle').textContent = title;
      $('#pageSubtitle').textContent = subtitle || '';
      const wrap = $('#pageActions');
      wrap.innerHTML = '';
      actions.forEach(a => wrap.appendChild(a));
    }

    function mkBtn(label, variant = 'primary', onClick) {
      const btn = document.createElement('button');
      btn.type = 'button';
      const base = 'px-3 py-2 rounded-lg text-sm border transition';
      const styles = {
        primary: 'bg-slate-900 text-white border-slate-900 hover:bg-slate-800',
        secondary: 'bg-white text-slate-900 border-slate-200 hover:bg-slate-50',
        danger: 'bg-rose-600 text-white border-rose-600 hover:bg-rose-700',
        ghost: 'bg-transparent text-slate-700 border-transparent hover:bg-slate-100'
      };
      btn.className = `${base} ${styles[variant] || styles.primary}`;
      btn.textContent = label;
      btn.addEventListener('click', onClick);
      return btn;
    }

    function mkBadge(text, color = 'slate') {
      const span = document.createElement('span');
      const map = {
        slate: 'bg-slate-100 text-slate-700 border-slate-200',
        emerald: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        amber: 'bg-amber-50 text-amber-800 border-amber-200',
        rose: 'bg-rose-50 text-rose-700 border-rose-200',
        blue: 'bg-blue-50 text-blue-700 border-blue-200'
      };
      span.className = `text-xs px-2 py-1 rounded-full border ${map[color] || map.slate}`;
      span.textContent = text;
      return span;
    }

    function mkCard(title, subtitle, bodyEl) {
      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const h = document.createElement('div');
      h.className = 'flex items-start justify-between gap-3';
      const left = document.createElement('div');
      left.innerHTML = `<div class="text-sm font-bold">${escapeHtml(title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(subtitle || '')}</div>`;
      h.appendChild(left);
      card.appendChild(h);
      if (bodyEl) {
        const b = document.createElement('div');
        b.className = 'mt-4';
        b.appendChild(bodyEl);
        card.appendChild(b);
      }
      return card;
    }

    function mkTable(headers, rows) {
      const wrap = document.createElement('div');
      wrap.className = 'overflow-auto border border-slate-200 rounded-2xl bg-white';
      const table = document.createElement('table');
      table.className = 'min-w-[900px] w-full text-sm';
      const thead = document.createElement('thead');
      thead.className = 'bg-slate-50 border-b border-slate-200';
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.className = 'text-right px-4 py-3 font-semibold text-slate-700';
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      const tbody = document.createElement('tbody');
      rows.forEach(r => tbody.appendChild(r));
      table.appendChild(thead);
      table.appendChild(tbody);
      wrap.appendChild(table);
      return wrap;
    }

    function mkTr(cells) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-100 hover:bg-slate-50';
      cells.forEach(c => {
        const td = document.createElement('td');
        td.className = 'px-4 py-3 align-top';
        if (c instanceof Node) td.appendChild(c); else td.innerHTML = c;
        tr.appendChild(td);
      });
      return tr;
    }

    function mkField({ label, type = 'text', value = '', placeholder = '', options = null, rows = 3, help = '' }) {
      const wrap = document.createElement('div');
      wrap.className = 'flex flex-col gap-1';
      const l = document.createElement('label');
      l.className = 'text-xs font-semibold text-slate-700';
      l.textContent = label;
      wrap.appendChild(l);

      let input;
      if (type === 'select') {
        input = document.createElement('select');
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        (options || []).forEach(opt => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          input.appendChild(o);
        });
        input.value = value ?? '';
      } else if (type === 'textarea') {
        input = document.createElement('textarea');
        input.rows = rows;
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        input.placeholder = placeholder;
        input.value = value ?? '';
      } else {
        input = document.createElement('input');
        input.type = type;
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        input.placeholder = placeholder;
        input.value = value ?? '';
      }

      wrap.appendChild(input);

      if (help) {
        const h = document.createElement('div');
        h.className = 'text-[11px] text-slate-500';
        h.textContent = help;
        wrap.appendChild(h);
      }
      return { wrap, input };
    }

    function mkTwoCols(...nodes) {
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';
      nodes.forEach(n => grid.appendChild(n));
      return grid;
    }

    function openModal({ title, subtitle = '', hint = '', okText = 'حفظ', cancelText = 'إلغاء', body, onOk }) {
      document.body.classList.remove('drawer-open');
      const tpl = $('#tpl-modal');
      const node = tpl.content.cloneNode(true);
      const root = node.firstElementChild;
      $('[data-title]', root).textContent = title;
      $('[data-subtitle]', root).textContent = subtitle;
      $('[data-hint]', root).textContent = hint;
      const okBtn = $('[data-ok]', root);
      okBtn.textContent = okText;
      const cancelBtn = $('[data-cancel]', root);
      cancelBtn.textContent = cancelText;
      $('[data-body]', root).appendChild(body);

      const close = () => root.remove();
      $$('[data-close]', root).forEach(b => b.addEventListener('click', close));
      cancelBtn.addEventListener('click', close);
      okBtn.addEventListener('click', async () => {
        try {
          okBtn.disabled = true;
          okBtn.classList.add('opacity-60');
          await onOk?.(close);
        } finally {
          okBtn.disabled = false;
          okBtn.classList.remove('opacity-60');
        }
      });

      const card = $('[data-app-modal-card]', root);
      if (card) {
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        if (isMobile) {
          card.style.maxHeight = 'calc(100vh - 72px)';
          card.style.width = '100vw';
          card.style.borderBottomLeftRadius = '0px';
          card.style.borderBottomRightRadius = '0px';
          card.style.paddingBottom = 'env(safe-area-inset-bottom)';
        } else {
          card.style.maxHeight = '80vh';
        }
      }

      document.body.appendChild(root);
      return root;
    }

    function confirmDialog({ title = 'تأكيد', message = 'هل أنت متأكد؟', confirmText = 'حذف', danger = true }) {
      return new Promise((resolve) => {
        const body = document.createElement('div');
        body.className = 'text-sm text-slate-700 leading-7';
        body.textContent = message;
        openModal({
          title,
          subtitle: danger ? 'لا يمكن التراجع عن هذه العملية.' : '',
          hint: '',
          okText: confirmText,
          cancelText: 'إلغاء',
          body,
          onOk: async (close) => { resolve(true); close(); }
        });
        // Cancel returns false
        const modals = $$('#tpl-modal');
        // no-op; handled by user
        setTimeout(() => {
          // If user closes without OK
          const onRemove = () => resolve(false);
          // Not reliable to detect; we keep false until ok.
          // We'll resolve false only when cancel pressed by hooking? We'll do in openModal cancel.
        }, 0);
      });
    }

    function mkEmpty(msg, actions = []) {
      const tpl = $('#tpl-empty');
      const node = tpl.content.cloneNode(true);
      const root = node.firstElementChild;
      $('[data-msg]', root).textContent = msg;
      const actionsWrap = $('[data-actions]', root);
      actions.forEach(a => actionsWrap.appendChild(a));
      return root;
    }

    // =============================
    // Shell + routing
    // =============================
    function mountShell() {
      const shell = $('#tpl-shell').content.cloneNode(true);
      $('#app').innerHTML = '';
      $('#app').appendChild(shell);
      // Style hooks
      const style = document.createElement('style');
      style.textContent = `
        .nav-item { text-align: right; padding: .65rem .75rem; border-radius: .75rem; border: 1px solid transparent; color: rgb(15 23 42); }
        .nav-item:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .nav-item.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .btn-nav { padding: .6rem .7rem; border-radius: .75rem; border: 1px solid rgb(226 232 240); background: white; font-size: .8rem; }
        .btn-nav:hover { background: rgb(248 250 252); }
        .chip { padding: .25rem .55rem; border-radius: 999px; border: 1px solid rgb(226 232 240); background: white; font-size: .75rem; color: rgb(51 65 85); }
        .nav-aside { position: fixed; top: 0; bottom: 0; right: 0; z-index: 40; }
        .nav-main { padding-bottom: calc(120px + env(safe-area-inset-bottom)); }
        .nav-scroll { max-height: calc(100vh - 260px); }
        .nav-link { width: 100%; text-align: right; display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .7rem .75rem; border-radius: .9rem; border: 1px solid transparent; color: rgb(15 23 42); background: transparent; }
        .nav-link:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .nav-link.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .nav-link:focus-visible { outline: 2px solid rgb(148 163 184); outline-offset: 2px; }
        .nav-badge { min-width: 28px; height: 20px; padding: 0 8px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; border: 1px solid rgb(226 232 240); background: rgb(248 250 252); color: rgb(51 65 85); }
        .nav-link.active .nav-badge { border-color: rgba(255,255,255,.25); background: rgba(255,255,255,.15); color: white; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 50; background: white; border-top: 1px solid rgb(226 232 240); padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); }
        .bottom-nav-inner { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; }
        .bottom-nav-btn { height: 44px; border-radius: 14px; border: 1px solid transparent; background: transparent; color: rgb(15 23 42); font-size: 13px; font-weight: 600; }
        .bottom-nav-btn:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .bottom-nav-btn.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .drawer { position: fixed; inset: 0; z-index: 60; pointer-events: none; }
        .drawer-overlay { position: absolute; inset: 0; background: rgba(15,23,42,.45); opacity: 0; transition: opacity 180ms ease; }
        .drawer-sheet { position: absolute; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 18px; border-top-right-radius: 18px; border-top: 1px solid rgb(226 232 240); transform: translateY(12px) translateY(100%); transition: transform 220ms ease; max-height: 78vh; overflow: auto; padding: 12px 14px 16px; }
        body.drawer-open .drawer { pointer-events: auto; }
        body.drawer-open .drawer-overlay { opacity: 1; }
        body.drawer-open .drawer-sheet { transform: translateY(0); }
        .drawer-title { font-weight: 800; font-size: 14px; color: rgb(15 23 42); }
        .drawer-close { height: 44px; padding: 0 14px; border-radius: 14px; border: 1px solid rgb(226 232 240); background: white; font-size: 13px; font-weight: 700; }
        @media (min-width: 768px) {
          .nav-main { padding-bottom: 0; }
        }
      `;
      document.head.appendChild(style);

      if (!window.__navDelegationInstalled) {
        window.__navDelegationInstalled = true;
        document.addEventListener('click', (e) => {
          const navBtn = e.target.closest('[data-nav]');
          if (navBtn) {
            const to = navBtn.getAttribute('data-nav');
            if (to) location.hash = to;
            return;
          }
          const moreBtn = e.target.closest('[data-nav-more]');
          if (moreBtn) {
            document.body.classList.add('drawer-open');
            return;
          }
          const closeBtn = e.target.closest('[data-nav-drawer-close]');
          if (closeBtn) {
            document.body.classList.remove('drawer-open');
            return;
          }
          const logoutBtn = e.target.closest('[data-nav-logout]');
          if (logoutBtn) {
            logout();
            return;
          }
        });
      }

      renderShellMeta();
      window.addEventListener('hashchange', renderRoute);
      document.addEventListener('keydown', (e) => {
        if (!e.altKey) return;
        const map = {
          '1': '#/home', '2': '#/companies', '3': '#/tenders', '4': '#/contracts', '5': '#/tasks', '6': '#/followups', '7': '#/android'
        };
        if (map[e.key]) {
          e.preventDefault();
          location.hash = map[e.key];
        }
      });
      renderRoute();
    }

    async function logout() {
      document.body.classList.remove('drawer-open');
      await logoutServer();
      authState = { accessToken: null, refreshToken: null, role: null, email: null };
      clearAuth();
      location.hash = '#/login';
    }

    function renderNav(activeRoute, userRole, counts) {
      const items = [
        { key: 'home', label: 'لوحة التحكم', href: '#/home', group: 'main' },
        { key: 'companies', label: 'الشركات', href: '#/companies', group: 'main', badge: Number(counts?.companies || 0), badgeColor: 'slate' },
        { key: 'tenders', label: 'المناقصات', href: '#/tenders', group: 'more' },
        { key: 'contracts', label: 'العقود', href: '#/contracts', group: 'more' },
        { key: 'tasks', label: 'المهام', href: '#/tasks', group: 'main', badge: Number(counts?.overdueTasks || 0), badgeColor: 'rose' },
        { key: 'followups', label: 'المتابعات', href: '#/followups', group: 'more' },
        { key: 'backup', label: 'نسخ/استعادة', href: '#/backup', group: 'more' },
        { key: 'settings', label: 'الإعدادات', href: '#/settings', group: 'more' },
        ...(userRole === 'admin' ? [{ key: 'android', label: 'مولّد Android', href: '#/android', group: 'more' }] : [])
      ];

      const isActive = (href) => (activeRoute || '#/home') === href;
      const badgeHtml = (n, variant = 'slate') => {
        if (!Number.isFinite(n) || n <= 0) return '';
        const extra = variant === 'rose' ? 'style="border-color: rgb(254 202 202); background: rgb(254 242 242); color: rgb(159 18 57);"' : '';
        return `<span class="nav-badge" ${extra}>${escapeHtml(n)}</span>`;
      };

      const link = (it) => {
        const active = isActive(it.href);
        return `
          <button class="nav-link ${active ? 'active' : ''}" data-nav="${it.href}" data-nav-item data-nav-title="${escapeHtml(it.label)}" aria-current="${active ? 'page' : 'false'}">
            <span class="font-semibold">${escapeHtml(it.label)}</span>
            ${badgeHtml(it.badge || 0, it.badgeColor)}
          </button>
        `;
      };

      const sidebarHtml = `
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-extrabold">القائمة</div>
            <div class="text-xs text-slate-500">Alt+1..7</div>
          </div>
          <div class="flex flex-col gap-1 mt-3">
            ${items.map(link).join('')}
          </div>
          <button class="nav-link mt-2" data-nav-logout data-nav-title="تسجيل الخروج">
            <span class="font-semibold text-rose-700">تسجيل الخروج</span>
            <span class="text-xs text-rose-700">↩</span>
          </button>
        </div>
      `;

      const bottomHtml = `
        <div class="bottom-nav" role="navigation" aria-label="التنقل">
          <div class="bottom-nav-inner">
            <button class="bottom-nav-btn ${isActive('#/home') ? 'active' : ''}" data-nav="#/home">الرئيسية</button>
            <button class="bottom-nav-btn ${isActive('#/companies') ? 'active' : ''}" data-nav="#/companies">الشركات</button>
            <button class="bottom-nav-btn ${isActive('#/tasks') ? 'active' : ''}" data-nav="#/tasks">المهام</button>
            <button class="bottom-nav-btn" data-nav-more>المزيد</button>
          </div>
        </div>

        <div class="drawer" aria-hidden="false">
          <div class="drawer-overlay" data-nav-drawer-close></div>
          <div class="drawer-sheet" role="dialog" aria-label="المزيد">
            <div class="flex items-center justify-between gap-3">
              <div class="drawer-title">المزيد</div>
              <button class="drawer-close" data-nav-drawer-close>إغلاق</button>
            </div>
            <div class="mt-3 flex flex-col gap-1">
              ${items.filter(it => it.group === 'more').map(link).join('')}
              <button class="nav-link mt-2" data-nav-logout data-nav-title="تسجيل الخروج">
                <span class="font-semibold text-rose-700">تسجيل الخروج</span>
                <span class="text-xs text-rose-700">↩</span>
              </button>
            </div>
          </div>
        </div>
      `;

      return { sidebarHtml, bottomHtml };
    }

    function applyNav(activeRoute) {
      const userRole = authState?.role || null;
      const companiesCount = Array.isArray(state?.companies) ? state.companies.length : 0;
      const overdueTasksCount = Array.isArray(state?.tasks) ? state.tasks.filter(t => computeTaskStatus(t) === 'OVERDUE').length : 0;
      const counts = { companies: companiesCount, overdueTasks: overdueTasksCount };

      const nav = renderNav(activeRoute, userRole, counts);

      const sidebar = $('#navSidebar');
      if (sidebar) sidebar.innerHTML = nav.sidebarHtml;

      const mobile = $('#navMobile');
      if (mobile) mobile.innerHTML = nav.bottomHtml;

      const search = $('#navSearch');
      if (search && !search.__bound) {
        search.__bound = true;
        search.addEventListener('input', () => {
          const q = (search.value || '').trim().toLowerCase();
          const nodes = $$('[data-nav-item]');
          nodes.forEach(n => {
            const title = (n.getAttribute('data-nav-title') || '').toLowerCase();
            const hit = !q || title.includes(q);
            n.classList.toggle('hidden', !hit);
          });
        });
      }
    }

    function renderRoute() {
      normalizeTasksStatuses();

      const hashFull = location.hash || '#/home';
      const activeHash = hashFull.split('?')[0] || '#/home';
      const [pathOnly] = hashFull.replace('#', '').split('?');

      const isAuthRoute = pathOnly === '/login' || pathOnly === '/register';
      const isAuthed = !!authState?.accessToken;

      if (!isAuthed && !isAuthRoute) {
        location.hash = '#/login';
        return;
      }

      if (isAuthed) {
        applyNav(activeHash);
      } else {
        const sidebar = $('#navSidebar');
        if (sidebar) sidebar.innerHTML = '';
        const mobile = $('#navMobile');
        if (mobile) mobile.innerHTML = '';
      }

      const [path, qStr] = hashFull.replace('#', '').split('?');
      const q = new URLSearchParams(qStr || '');

      const content = $('#content');
      content.innerHTML = '';

      if (path === '/login') return renderLogin(content, q);
      if (path === '/register') return renderRegister(content, q);

      if (path === '/home') return renderHome(content);
      if (path === '/companies') return renderCompanies(content, q);
      if (path === '/company') return renderCompanyDetails(content, q.get('id'));
      if (path === '/tenders') return renderTenders(content, q);
      if (path === '/tender') return renderTenderDetails(content, q.get('id'));
      if (path === '/contracts') return renderContracts(content, q);
      if (path === '/contract') return renderContractDetails(content, q.get('id'));
      if (path === '/tasks') return renderTasks(content, q);
      if (path === '/followups') return renderFollowups(content, q);
      if (path === '/backup') return renderBackup(content);
      if (path === '/settings') return renderSettings(content);
      if (path === '/android') return renderAndroidGenerator(content);

      location.hash = '#/home';
    }

    function renderSettings(root) {
      setPage('الإعدادات', 'إعدادات التطبيق (قريباً).');
      const box = document.createElement('div');
      box.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      box.innerHTML = `
        <div class="text-sm font-bold">هذه الصفحة قيد الإنشاء</div>
        <div class="text-sm text-slate-600 mt-2 leading-7">سيتم إضافة إعدادات إضافية لاحقاً. حالياً يمكنك استخدام صفحات النسخ الاحتياطي و مولّد Android.</div>
      `;
      root.appendChild(box);
    }

    function renderLogin(root, q) {
      // Hide sidebar and footer for login page
      const sidebar = $('#sidebar');
      const navMobile = $('#navMobile');
      if (sidebar) sidebar.style.display = 'none';
      if (navMobile) navMobile.style.display = 'none';

      setPage('', '');

      // Create full-page login container
      root.innerHTML = `
        <div class="min-h-[80vh] flex items-center justify-center animate-fadeInUp">
          <div class="w-full max-w-md">
            <!-- Logo & Header -->
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-glow animate-float">
                <span class="text-3xl font-bold text-white">م</span>
              </div>
              <h1 class="text-2xl font-bold gradient-text">مدير المناقصات والعقود</h1>
              <p class="text-slate-500 mt-2">نظام إدارة متكامل للمناقصات والعقود والمبيعات</p>
            </div>
            
            <!-- Login Card -->
            <div class="card-modern p-8 shadow-soft hover-lift">
              <form id="loginForm" class="space-y-5">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">البريد الإلكتروني</label>
                  <input 
                    id="loginEmail" 
                    type="email" 
                    value="${escapeHtml(q.get('email') || authState?.email || '')}"
                    placeholder="name@example.com" 
                    class="input-modern w-full"
                    autocomplete="email"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">كلمة المرور</label>
                  <input 
                    id="loginPassword" 
                    type="password" 
                    placeholder="••••••••" 
                    class="input-modern w-full"
                    autocomplete="current-password"
                  />
                </div>
                
                <button 
                  type="submit" 
                  id="loginBtn"
                  class="w-full py-3 px-4 rounded-xl btn-gradient font-bold text-lg flex items-center justify-center gap-2"
                >
                  <span>تسجيل الدخول</span>
                  <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                  </svg>
                </button>
                
                <div class="relative my-6">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200"></div>
                  </div>
                  <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-slate-500">أو</span>
                  </div>
                </div>
                
                <button 
                  type="button" 
                  id="registerBtn"
                  class="w-full py-3 px-4 rounded-xl border-2 border-indigo-100 bg-indigo-50/50 text-indigo-600 font-semibold hover:bg-indigo-100 transition-all"
                >
                  إنشاء حساب جديد
                </button>
              </form>
              
              <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200">
                <div class="flex items-start gap-3">
                  <span class="text-xl">💡</span>
                  <div>
                    <div class="text-sm font-semibold text-amber-800">ملاحظة</div>
                    <div class="text-xs text-amber-700 mt-1 leading-relaxed">أول حساب يتم إنشاؤه يصبح مدير (admin) تلقائياً.</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-xs text-slate-400">
              <span>نسخة 2.0</span>
              <span class="mx-2">•</span>
              <span>تخزين سحابي آمن</span>
            </div>
          </div>
        </div>
      `;

      // Attach event listeners
      const form = $('#loginForm', root);
      const btnLogin = $('#loginBtn', root);
      const btnRegister = $('#registerBtn', root);

      btnRegister.addEventListener('click', () => {
        const email = ($('#loginEmail', root)?.value || '').trim();
        location.hash = email ? `#/register?email=${encodeURIComponent(email)}` : '#/register';
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        const email = $('#loginEmail', root).value.trim();
        const password = $('#loginPassword', root).value;

        if (!email || !password) return alert('أدخل البريد وكلمة المرور.');

        btnLogin.disabled = true;
        btnLogin.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) return alert(data?.error || 'فشل تسجيل الدخول');

          authState = { accessToken: data.accessToken, refreshToken: data.refreshToken, role: data.role || null, email };
          saveAuth(authState);

          // Load data from server after login
          await loadDataFromServerFormatted();

          location.hash = '#/home';
          renderRoute();
        } finally {
          btnLogin.disabled = false;
          btnLogin.innerHTML = `
            <span>تسجيل الدخول</span>
            <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
          `;
        };
      };
    }

    function renderRegister(root, q) {
      // Hide sidebar and footer for register page
      const sidebar = $('#sidebar');
      const navMobile = $('#navMobile');
      if (sidebar) sidebar.style.display = 'none';
      if (navMobile) navMobile.style.display = 'none';

      setPage('', '');

      root.innerHTML = `
        <div class="min-h-[80vh] flex items-center justify-center animate-fadeInUp">
          <div class="w-full max-w-md">
            <!-- Logo & Header -->
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-glow animate-float">
                <span class="text-3xl font-bold text-white">+</span>
              </div>
              <h1 class="text-2xl font-bold gradient-text">إنشاء حساب جديد</h1>
              <p class="text-slate-500 mt-2">سجّل بريدك وكلمة مرور (8 أحرف على الأقل)</p>
            </div>
            
            <!-- Register Card -->
            <div class="card-modern p-8 shadow-soft hover-lift">
              <form id="registerForm" class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">البريد الإلكتروني</label>
                  <input 
                    id="regEmail" 
                    type="email" 
                    value="${escapeHtml(q.get('email') || '')}"
                    placeholder="name@example.com" 
                    class="input-modern w-full"
                    autocomplete="email"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">كلمة المرور</label>
                  <input 
                    id="regPassword" 
                    type="password" 
                    placeholder="••••••••" 
                    class="input-modern w-full"
                    autocomplete="new-password"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">تأكيد كلمة المرور</label>
                  <input 
                    id="regPassword2" 
                    type="password" 
                    placeholder="••••••••" 
                    class="input-modern w-full"
                    autocomplete="new-password"
                  />
                </div>
                
                <button 
                  type="submit" 
                  id="registerBtn"
                  class="w-full py-3 px-4 rounded-xl btn-gradient font-bold text-lg flex items-center justify-center gap-2 mt-6"
                >
                  <span>إنشاء الحساب</span>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                  </svg>
                </button>
                
                <button 
                  type="button" 
                  id="backBtn"
                  class="w-full py-3 px-4 rounded-xl border-2 border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                  </svg>
                  <span>العودة لتسجيل الدخول</span>
                </button>
              </form>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-xs text-slate-400">
              <span>نسخة 2.0</span>
              <span class="mx-2">•</span>
              <span>حسابك آمن ومشفر</span>
            </div>
          </div>
        </div>
      `;

      // Attach event listeners
      const form = $('#registerForm', root);
      const btnRegister = $('#registerBtn', root);
      const btnBack = $('#backBtn', root);

      btnBack.addEventListener('click', () => {
        const email = ($('#regEmail', root)?.value || '').trim();
        location.hash = email ? `#/login?email=${encodeURIComponent(email)}` : '#/login';
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        const email = $('#regEmail', root).value.trim();
        const password = $('#regPassword', root).value;
        const password2 = $('#regPassword2', root).value;

        if (!email || !password) return alert('أدخل البريد وكلمة المرور.');
        if (password.length < 8) return alert('كلمة المرور يجب أن تكون 8 أحرف على الأقل.');
        if (password !== password2) return alert('كلمتا المرور غير متطابقتين.');

        btnRegister.disabled = true;
        btnRegister.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          const res = await fetch(`${API_BASE}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) return alert(data?.error || 'فشل إنشاء الحساب');
          location.hash = `#/login?email=${encodeURIComponent(email)}`;
        } finally {
          btnRegister.disabled = false;
          btnRegister.innerHTML = `
            <span>إنشاء الحساب</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
            </svg>
          `;
        }
      };
    }

    // =============================
    // Dashboard
    // =============================
    function renderHome(root) {
      setPage('لوحة التحكم', 'ملخّص سريع للمهام والمواعيد القادمة.');

      const today = startOfDay(nowTs());
      const in7 = daysFromNow(7);
      const in30 = daysFromNow(30);

      const tasks = state.tasks.map(t => ({ ...t, status: computeTaskStatus(t) }));
      const dueToday = tasks.filter(t => t.dueDate && startOfDay(t.dueDate) === today && t.status !== 'DONE');
      const overdue = tasks.filter(t => t.status === 'OVERDUE');

      const upcomingTenders = state.tenders
        .filter(t => t.submissionDeadline)
        .map(t => ({ ...t, submissionDeadline: t.submissionDeadline }))
        .filter(t => startOfDay(t.submissionDeadline) >= today && startOfDay(t.submissionDeadline) <= in7)
        .sort((a, b) => a.submissionDeadline - b.submissionDeadline)
        .slice(0, 8);

      const expiringContracts = state.contracts
        .map(c => ({ ...c, nextDate: c.renewalDate || c.endDate }))
        .filter(c => c.nextDate)
        .filter(c => startOfDay(c.nextDate) >= today && startOfDay(c.nextDate) <= in30)
        .sort((a, b) => a.nextDate - b.nextDate)
        .slice(0, 8);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4';

      const box1 = mkCard('مهام مستحقة اليوم', `${dueToday.length} مهمة`, (() => {
        const el = document.createElement('div');
        if (!dueToday.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">لا توجد مهام مستحقة اليوم.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        dueToday.slice(0, 7).forEach(t => list.appendChild(taskRow(t)));
        const more = mkBtn('فتح كل المهام', 'secondary', () => location.hash = '#/tasks?filter=today');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(list);
        el.appendChild(more);
        return el;
      })());

      const box2 = mkCard('مهام متأخرة', `${overdue.length} مهمة`, (() => {
        const el = document.createElement('div');
        if (!overdue.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">لا توجد مهام متأخرة.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        overdue.slice(0, 7).forEach(t => list.appendChild(taskRow(t)));
        const more = mkBtn('فتح المهام المتأخرة', 'secondary', () => location.hash = '#/tasks?filter=overdue');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(list);
        el.appendChild(more);
        return el;
      })());

      const box3 = mkCard('مواعيد تقديم مناقصات قريبة (7 أيام)', `${upcomingTenders.length} موعد`, (() => {
        const el = document.createElement('div');
        if (!upcomingTenders.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">لا توجد مواعيد تقديم قريبة.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        upcomingTenders.forEach(t => {
          const row = document.createElement('div');
          row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';
          row.innerHTML = `
            <div>
              <div class="font-semibold text-sm">${escapeHtml(t.title)}</div>
              <div class="text-xs text-slate-600 mt-1">${escapeHtml(getCompanyName(t.companyId))} • الحالة: ${escapeHtml(labels.TenderStatus[t.status] || t.status)}</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-500">آخر موعد</div>
              <div class="text-sm font-bold">${fmtDate(t.submissionDeadline)}</div>
              <button class="mt-2 text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50" data-open>فتح</button>
            </div>
          `;
          $('[data-open]', row).addEventListener('click', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`);
          list.appendChild(row);
        });
        el.appendChild(list);
        const more = mkBtn('فتح كل المناقصات', 'secondary', () => location.hash = '#/tenders');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(more);
        return el;
      })());

      const box4 = mkCard('عقود قريبة الانتهاء/التجديد (30 يوم)', `${expiringContracts.length} عقد`, (() => {
        const el = document.createElement('div');
        if (!expiringContracts.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">لا توجد عقود قريبة الانتهاء/التجديد.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        expiringContracts.forEach(c => {
          const row = document.createElement('div');
          row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';
          row.innerHTML = `
            <div>
              <div class="font-semibold text-sm">${escapeHtml(c.title)}</div>
              <div class="text-xs text-slate-600 mt-1">${escapeHtml(getCompanyName(c.companyId))} • الحالة: ${escapeHtml(labels.ContractStatus[c.status] || c.status)}</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-500">التاريخ</div>
              <div class="text-sm font-bold">${fmtDate(c.nextDate)}</div>
              <button class="mt-2 text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50" data-open>فتح</button>
            </div>
          `;
          $('[data-open]', row).addEventListener('click', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`);
          list.appendChild(row);
        });
        el.appendChild(list);
        const more = mkBtn('فتح كل العقود', 'secondary', () => location.hash = '#/contracts');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(more);
        return el;
      })());

      grid.appendChild(box1);
      grid.appendChild(box2);
      grid.appendChild(box3);
      grid.appendChild(box4);
      root.appendChild(grid);

      // Quick actions
      const actions = document.createElement('div');
      actions.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      actions.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm font-bold">إجراءات سريعة</div>
            <div class="text-xs text-slate-500 mt-1">أضف بياناتك بسرعة ثم استخدم مولّد Android لتحميل مشروع جاهز.</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="chip" data-act="addCompany">+ شركة</button>
            <button class="chip" data-act="addTender">+ مناقصة</button>
            <button class="chip" data-act="addContract">+ عقد</button>
            <button class="chip" data-act="addTask">+ مهمة</button>
            <button class="chip" data-act="addFollow">+ متابعة</button>
          </div>
        </div>
      `;
      $('[data-act="addCompany"]', actions).addEventListener('click', () => openCompanyForm());
      $('[data-act="addTender"]', actions).addEventListener('click', () => openTenderForm());
      $('[data-act="addContract"]', actions).addEventListener('click', () => openContractForm());
      $('[data-act="addTask"]', actions).addEventListener('click', () => openTaskForm());
      $('[data-act="addFollow"]', actions).addEventListener('click', () => openFollowUpForm());
      root.appendChild(actions);

      // Web notification helper (while page open)
      const note = document.createElement('div');
      note.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      note.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm font-bold">تنبيه داخل المتصفح (اختياري)</div>
            <div class="text-xs text-slate-500 mt-1">هذا للتجربة فقط (لن يعمل بالخلفية). التطبيق الحقيقي على Android يستخدم WorkManager.</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-req>طلب إذن الإشعارات</button>
            <button class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" data-test>إشعار تجريبي</button>
          </div>
        </div>
      `;
      $('[data-req]', note).addEventListener('click', async () => {
        if (!('Notification' in window)) return alert('المتصفح لا يدعم الإشعارات.');
        const p = await Notification.requestPermission();
        alert('حالة الإذن: ' + p);
      });
      $('[data-test]', note).addEventListener('click', () => {
        if (!('Notification' in window)) return alert('المتصفح لا يدعم الإشعارات.');
        if (Notification.permission !== 'granted') return alert('فعّل الإذن أولاً.');
        new Notification('تذكير', { body: 'هذا إشعار تجريبي داخل المتصفح.' });
      });
      root.appendChild(note);
    }

    function taskRow(t) {
      const row = document.createElement('div');
      row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="font-semibold text-sm">${escapeHtml(t.title)}</div>
        <div class="text-xs text-slate-600 mt-1">
          ${escapeHtml(labels.RelatedType[t.relatedType] || t.relatedType)}: ${escapeHtml(getRelatedName(t.relatedType, t.relatedId))}
          • الاستحقاق: ${fmtDate(t.dueDate)}
        </div>
      `;

      const right = document.createElement('div');
      right.className = 'flex flex-col items-end gap-2';
      const badges = document.createElement('div');
      badges.className = 'flex flex-wrap gap-1 justify-end';
      badges.appendChild(mkBadge(labels.TaskPriority[t.priority] || t.priority, t.priority === 'HIGH' ? 'rose' : (t.priority === 'MEDIUM' ? 'amber' : 'slate')));
      badges.appendChild(mkBadge(labels.TaskStatus[t.status] || t.status, t.status === 'OVERDUE' ? 'rose' : (t.status === 'DONE' ? 'emerald' : 'blue')));
      right.appendChild(badges);

      const actions = document.createElement('div');
      actions.className = 'flex gap-2';
      const doneBtn = document.createElement('button');
      doneBtn.className = 'text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50';
      doneBtn.textContent = 'تمت';
      doneBtn.disabled = t.status === 'DONE';
      doneBtn.addEventListener('click', () => {
        updateTask(t.id, { status: 'DONE', updatedAt: nowTs() });
        renderRoute();
      });
      const openBtn = document.createElement('button');
      openBtn.className = 'text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50';
      openBtn.textContent = 'تعديل';
      openBtn.addEventListener('click', () => openTaskForm(t));

      actions.appendChild(doneBtn);
      actions.appendChild(openBtn);
      right.appendChild(actions);

      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    function getRelatedName(type, id) {
      if (type === 'COMPANY') return getCompanyName(id);
      if (type === 'TENDER') return getTenderTitle(id);
      if (type === 'CONTRACT') return getContractTitle(id);
      return '—';
    }

    // =============================
    // Companies
    // =============================
    function renderCompanies(root, q) {
      setPage('الشركات', 'إدارة الشركات والبيانات الأساسية (بحث بالاسم أو الهاتف).', [
        mkBtn('+ إضافة شركة', 'primary', () => openCompanyForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'بحث', placeholder: 'اسم الشركة أو رقم الهاتف...', value: q.get('s') || '' });
      const sector = mkField({
        label: 'تصفية حسب القطاع (اختياري)',
        type: 'select',
        value: q.get('sector') || '',
        options: [{ value: '', label: 'الكل' }, ...uniqueSectors().map(s => ({ value: s, label: s }))]
      });

      const row = mkTwoCols(search.wrap, sector.wrap);
      controls.appendChild(row);

      const apply = mkBtn('تطبيق', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (sector.input.value) params.set('sector', sector.input.value);
        location.hash = `#/companies?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);

      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const sec = q.get('sector') || '';
      let items = [...state.companies];
      if (s) items = items.filter(c => (c.name || '').toLowerCase().includes(s) || (c.phone1 || '').includes(s) || (c.phone2 || '').includes(s));
      if (sec) items = items.filter(c => (c.sector || '') === sec);
      items.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));

      if (!items.length) {
        root.appendChild(mkEmpty('ابدأ بإضافة أول شركة ثم أضف المناقصات والعقود والمهام المرتبطة بها.', [
          mkBtn('+ إضافة شركة', 'primary', () => openCompanyForm()),
          mkBtn('استيراد نسخة احتياطية', 'secondary', () => location.hash = '#/backup')
        ]));
        return;
      }

      const rows = items.map(c => {
        const name = document.createElement('div');
        name.innerHTML = `<div class="font-semibold">${escapeHtml(c.name)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(c.sector || '—')} • ${escapeHtml(c.phone1 || '—')}</div>`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('فتح', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(c.id)}`));
        actions.appendChild(mkBtn('تعديل', 'secondary', () => openCompanyForm(c)));
        actions.appendChild(mkBtn('حذف', 'danger', async () => {
          const ok = confirm(`حذف الشركة "${c.name}"؟ سيتم حذف العلاقات (جهات الاتصال/المتابعات) المرتبطة بها أيضاً.`);
          if (!ok) return;
          deleteCompanyCascade(c.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([
          name,
          `<div class="text-xs text-slate-600">العنوان: ${escapeHtml(c.address || '—')}<br/>البريد: ${escapeHtml(c.email || '—')}<br/>الموقع: ${escapeHtml(c.website || '—')}</div>`,
          actions
        ]);
      });

      root.appendChild(mkTable(['الشركة', 'بيانات', 'إجراءات'], rows));
    }

    function uniqueSectors() {
      const set = new Set(state.companies.map(c => (c.sector || '').trim()).filter(Boolean));
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'ar'));
    }

    function openCompanyForm(existing = null) {
      const isEdit = !!existing;
      const body = document.createElement('div');

      const fName = mkField({ label: 'اسم الشركة *', value: existing?.name || '', placeholder: 'مثال: شركة XYZ' });
      const fSector = mkField({ label: 'القطاع/النوع', value: existing?.sector || '', placeholder: 'مثال: حكومي / خاص / مقاولات...' });
      const fAddress = mkField({ label: 'العنوان', value: existing?.address || '', placeholder: 'العنوان...' });
      const fPhone1 = mkField({ label: 'هاتف 1 (أساسي)', value: existing?.phone1 || '', placeholder: '05xxxxxxxx' });
      const fPhone2 = mkField({ label: 'هاتف 2 (اختياري)', value: existing?.phone2 || '' });
      const fEmail = mkField({ label: 'البريد (اختياري)', type: 'email', value: existing?.email || '' });
      const fWebsite = mkField({ label: 'الموقع (اختياري)', type: 'url', value: existing?.website || '' });
      const fNotes = mkField({ label: 'ملاحظات عامة', type: 'textarea', rows: 4, value: existing?.notes || '', placeholder: 'أي معلومات مهمة...' });

      body.appendChild(mkTwoCols(fName.wrap, fSector.wrap));
      body.appendChild(mkTwoCols(fPhone1.wrap, fPhone2.wrap));
      body.appendChild(mkTwoCols(fEmail.wrap, fWebsite.wrap));
      body.appendChild(fAddress.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'تعديل شركة' : 'إضافة شركة',
        subtitle: 'البيانات الأساسية للشركة.',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ التعديل' : 'إضافة',
        body,
        onOk: async (close) => {
          const name = fName.input.value.trim();
          if (!name) return alert('اسم الشركة مطلوب.');
          const obj = {
            id: existing?.id || uuid(),
            name,
            sector: fSector.input.value.trim() || null,
            address: fAddress.input.value.trim() || null,
            phone1: fPhone1.input.value.trim() || null,
            phone2: fPhone2.input.value.trim() || null,
            email: fEmail.input.value.trim() || null,
            website: fWebsite.input.value.trim() || null,
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };
          upsert('companies', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function deleteCompanyCascade(companyId) {
      state.companies = state.companies.filter(c => c.id !== companyId);
      state.contacts = state.contacts.filter(c => c.companyId !== companyId);
      state.followups = state.followups.filter(f => f.companyId !== companyId);
      const tendersToDelete = new Set(state.tenders.filter(t => t.companyId === companyId).map(t => t.id));
      const contractsToDelete = new Set(state.contracts.filter(c => c.companyId === companyId).map(c => c.id));
      state.tenders = state.tenders.filter(t => t.companyId !== companyId);
      state.contracts = state.contracts.filter(c => c.companyId !== companyId);
      state.tasks = state.tasks.filter(t => {
        if (t.relatedType === 'COMPANY' && t.relatedId === companyId) return false;
        if (t.relatedType === 'TENDER' && tendersToDelete.has(t.relatedId)) return false;
        if (t.relatedType === 'CONTRACT' && contractsToDelete.has(t.relatedId)) return false;
        return true;
      });
      state.followups = state.followups.filter(f => !(tendersToDelete.has(f.tenderId) || contractsToDelete.has(f.contractId)));
    }

    function renderCompanyDetails(root, id) {
      const company = state.companies.find(c => c.id === id);
      if (!company) {
        setPage('الشركة غير موجودة', 'قد تكون حُذفت أو لم يتم العثور عليها.');
        root.appendChild(mkEmpty('لا يمكن العثور على الشركة المطلوبة.', [
          mkBtn('العودة للشركات', 'secondary', () => location.hash = '#/companies')
        ]));
        return;
      }

      setPage(company.name, 'تفاصيل الشركة + المناقصات + العقود + جهات الاتصال + المتابعات.', [
        mkBtn('تعديل', 'secondary', () => openCompanyForm(company)),
        mkBtn('+ مناقصة', 'primary', () => openTenderForm({ companyId: company.id })),
        mkBtn('+ عقد', 'secondary', () => openContractForm({ companyId: company.id })),
        mkBtn('+ جهة اتصال', 'secondary', () => openContactForm({ companyId: company.id })),
        mkBtn('+ متابعة', 'secondary', () => openFollowUpForm({ companyId: company.id }))
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const info = document.createElement('div');
      info.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      info.innerHTML = `
        <div class="text-sm font-bold">بيانات الشركة</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">القطاع</div><div class="font-semibold mt-1">${escapeHtml(company.sector || '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">الهاتف</div><div class="font-semibold mt-1">${escapeHtml(company.phone1 || '—')}</div><div class="text-xs text-slate-600 mt-1">${escapeHtml(company.phone2 || '')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">البريد</div><div class="font-semibold mt-1">${escapeHtml(company.email || '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">الموقع</div><div class="font-semibold mt-1">${escapeHtml(company.website || '—')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">العنوان</div><div class="font-semibold mt-1">${escapeHtml(company.address || '—')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ملاحظات</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(company.notes || '—')}</div></div>
        </div>
      `;

      const stats = document.createElement('div');
      stats.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const tendersCount = state.tenders.filter(t => t.companyId === company.id).length;
      const contractsCount = state.contracts.filter(c => c.companyId === company.id).length;
      const contactsCount = state.contacts.filter(c => c.companyId === company.id).length;
      const followCount = state.followups.filter(f => f.companyId === company.id).length;
      stats.innerHTML = `
        <div class="text-sm font-bold">ملخص</div>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">مناقصات</div><div class="text-xl font-bold mt-1">${tendersCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">عقود</div><div class="text-xl font-bold mt-1">${contractsCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">جهات اتصال</div><div class="text-xl font-bold mt-1">${contactsCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">متابعات</div><div class="text-xl font-bold mt-1">${followCount}</div></div>
        </div>
        <div class="mt-4 text-xs text-slate-500">تاريخ الإنشاء: ${fmtDateTime(company.createdAt)} • آخر تحديث: ${fmtDateTime(company.updatedAt)}</div>
      `;

      top.appendChild(info);
      top.appendChild(stats);
      root.appendChild(top);

      // Tabs section
      const tabs = document.createElement('div');
      tabs.className = 'mt-4 bg-white border border-slate-200 rounded-2xl shadow-soft';
      tabs.innerHTML = `
        <div class="flex flex-wrap gap-2 p-3 border-b border-slate-200">
          <button class="chip" data-tab="tenders">مناقصات الشركة</button>
          <button class="chip" data-tab="contracts">عقود الشركة</button>
          <button class="chip" data-tab="contacts">جهات الاتصال</button>
          <button class="chip" data-tab="followups">المتابعات</button>
        </div>
        <div class="p-4" data-tab-body></div>
      `;
      const body = $('[data-tab-body]', tabs);

      const setTab = (name) => {
        $$('[data-tab]', tabs).forEach(b => b.classList.toggle('bg-slate-900', b.getAttribute('data-tab') === name));
        $$('[data-tab]', tabs).forEach(b => b.classList.toggle('text-white', b.getAttribute('data-tab') === name));
        body.innerHTML = '';
        if (name === 'tenders') body.appendChild(companyTendersView(company.id));
        if (name === 'contracts') body.appendChild(companyContractsView(company.id));
        if (name === 'contacts') body.appendChild(companyContactsView(company.id));
        if (name === 'followups') body.appendChild(companyFollowupsView(company.id));
      };

      $$('[data-tab]', tabs).forEach(b => b.addEventListener('click', () => setTab(b.getAttribute('data-tab'))));
      setTab('tenders');
      root.appendChild(tabs);
    }

    function companyTendersView(companyId) {
      const wrap = document.createElement('div');
      const items = state.tenders.filter(t => t.companyId === companyId).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      if (!items.length) {
        wrap.appendChild(mkEmpty('لا توجد مناقصات لهذه الشركة بعد.', [mkBtn('+ إضافة مناقصة', 'primary', () => openTenderForm({ companyId }))]));
        return wrap;
      }
      const rows = items.map(t => mkTr([
        `<div class="font-semibold">${escapeHtml(t.title)}<div class="text-xs text-slate-500 mt-1">رقم: ${escapeHtml(t.refNumber || '—')}</div></div>`,
        `<div class="text-xs text-slate-600">النوع: ${escapeHtml(labels.TenderType[t.type] || t.type)}<br/>الحالة: ${escapeHtml(labels.TenderStatus[t.status] || t.status)}<br/>آخر موعد: <b>${fmtDate(t.submissionDeadline)}</b></div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('فتح', 'secondary', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`));
          a.appendChild(mkBtn('تعديل', 'secondary', () => openTenderForm(t)));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['المناقصة', 'تفاصيل', 'إجراءات'], rows));
      return wrap;
    }

    function companyContractsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.contracts.filter(c => c.companyId === companyId).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      if (!items.length) {
        wrap.appendChild(mkEmpty('لا توجد عقود لهذه الشركة بعد.', [mkBtn('+ إضافة عقد', 'primary', () => openContractForm({ companyId }))]));
        return wrap;
      }
      const rows = items.map(c => mkTr([
        `<div class="font-semibold">${escapeHtml(c.title)}<div class="text-xs text-slate-500 mt-1">رقم: ${escapeHtml(c.contractNumber || '—')}</div></div>`,
        `<div class="text-xs text-slate-600">الحالة: ${escapeHtml(labels.ContractStatus[c.status] || c.status)}<br/>البداية: ${fmtDate(c.startDate)}<br/>النهاية: <b>${fmtDate(c.endDate)}</b></div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('فتح', 'secondary', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`));
          a.appendChild(mkBtn('تعديل', 'secondary', () => openContractForm(c)));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['العقد', 'تفاصيل', 'إجراءات'], rows));
      return wrap;
    }

    function companyContactsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.contacts.filter(c => c.companyId === companyId).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between gap-2 mb-3';
      header.appendChild(mkBadge(`${items.length} جهة اتصال`, 'slate'));
      header.appendChild(mkBtn('+ إضافة جهة اتصال', 'primary', () => openContactForm({ companyId })));
      wrap.appendChild(header);

      if (!items.length) {
        wrap.appendChild(mkEmpty('أضف الأشخاص داخل الشركة (المسمى الوظيفي + الجوال/واتساب).', [mkBtn('+ إضافة جهة اتصال', 'primary', () => openContactForm({ companyId }))]));
        return wrap;
      }

      const rows = items.map(p => mkTr([
        `<div class="font-semibold">${escapeHtml(p.name)}<div class="text-xs text-slate-500 mt-1">${escapeHtml(p.role || '—')}</div></div>`,
        `<div class="text-xs text-slate-600">الجوال/واتساب: ${escapeHtml(p.mobile || '—')}<br/>البريد: ${escapeHtml(p.email || '—')}<br/>ملاحظات: ${escapeHtml(p.notes || '—')}</div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('تعديل', 'secondary', () => openContactForm(p)));
          a.appendChild(mkBtn('حذف', 'danger', () => {
            const ok = confirm(`حذف جهة الاتصال "${p.name}"؟`);
            if (!ok) return;
            state.contacts = state.contacts.filter(x => x.id !== p.id);
            saveState(state);
            renderRoute();
          }));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['الاسم', 'تفاصيل', 'إجراءات'], rows));
      return wrap;
    }

    function companyFollowupsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.followups.filter(f => f.companyId === companyId).sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0));
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between gap-2 mb-3';
      header.appendChild(mkBadge(`${items.length} متابعة`, 'slate'));
      header.appendChild(mkBtn('+ إضافة متابعة', 'primary', () => openFollowUpForm({ companyId })));
      wrap.appendChild(header);

      if (!items.length) {
        wrap.appendChild(mkEmpty('سجّل الاتصالات والزيارات والبريد والواتساب وغيرها.', [mkBtn('+ إضافة متابعة', 'primary', () => openFollowUpForm({ companyId }))]));
        return wrap;
      }

      const rows = items.map(f => mkTr([
        `<div class="font-semibold">${escapeHtml(labels.FollowUpType[f.type] || f.type)}<div class="text-xs text-slate-500 mt-1">${fmtDateTime(f.dateTime)}</div></div>`,
        `<div class="text-xs text-slate-600">الشخص: ${escapeHtml(f.contactName || '—')}<br/>الملخص: ${escapeHtml(f.summary || '—')}<br/>الخطوة التالية: ${escapeHtml(f.nextStep || '—')} • ${fmtDate(f.nextStepDate)}</div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('تعديل', 'secondary', () => openFollowUpForm(f)));
          a.appendChild(mkBtn('حذف', 'danger', () => {
            const ok = confirm('حذف المتابعة؟');
            if (!ok) return;
            state.followups = state.followups.filter(x => x.id !== f.id);
            saveState(state);
            renderRoute();
          }));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['النشاط', 'تفاصيل', 'إجراءات'], rows));
      return wrap;
    }

    // =============================
    // Contacts
    // =============================
    function openContactForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'الشركة *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'اختر شركة...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const fName = mkField({ label: 'اسم الشخص *', value: existing?.name || '', placeholder: 'مثال: أحمد محمد' });
      const fRole = mkField({ label: 'المسمى الوظيفي', value: existing?.role || '', placeholder: 'مثال: مدير مشتريات' });
      const fMobile = mkField({ label: 'جوال / واتساب', value: existing?.mobile || '', placeholder: '05xxxxxxxx' });
      const fEmail = mkField({ label: 'البريد (اختياري)', type: 'email', value: existing?.email || '' });
      const fNotes = mkField({ label: 'ملاحظات', type: 'textarea', rows: 3, value: existing?.notes || '', placeholder: 'مثال: يفضّل الاتصال بعد العصر...' });

      body.appendChild(mkTwoCols(fCompany.wrap, fName.wrap));
      body.appendChild(mkTwoCols(fRole.wrap, fMobile.wrap));
      body.appendChild(fEmail.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'تعديل جهة اتصال' : 'إضافة جهة اتصال',
        subtitle: 'ربط جهة الاتصال بشركة محددة.',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ' : 'إضافة',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const name = fName.input.value.trim();
          if (!companyId) return alert('اختر الشركة.');
          if (!name) return alert('اسم الشخص مطلوب.');
          const obj = {
            id: existing?.id || uuid(),
            companyId,
            name,
            role: fRole.input.value.trim() || null,
            mobile: fMobile.input.value.trim() || null,
            email: fEmail.input.value.trim() || null,
            notes: fNotes.input.value.trim() || null
          };
          upsert('contacts', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    // =============================
    // Tenders
    // =============================
    function renderTenders(root, q) {
      setPage('المناقصات/الفرص', 'بحث وتصفية حسب الحالة والشركة ورقم المرجع.', [
        mkBtn('+ إضافة مناقصة', 'primary', () => openTenderForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'بحث', placeholder: 'العنوان أو رقم المرجع...', value: q.get('s') || '' });
      const status = mkField({
        label: 'الحالة',
        type: 'select',
        value: q.get('status') || '',
        options: [{ value: '', label: 'الكل' }, ...Enums.TenderStatus.map(v => ({ value: v, label: labels.TenderStatus[v] || v }))]
      });
      const company = mkField({
        label: 'الشركة',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'الكل' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const from = mkField({ label: 'من تاريخ آخر موعد', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'إلى تاريخ آخر موعد', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(search.wrap, status.wrap));
      controls.appendChild(mkTwoCols(company.wrap, from.wrap));
      controls.appendChild(mkTwoCols(to.wrap, document.createElement('div')));

      const apply = mkBtn('تطبيق', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (status.input.value) params.set('status', status.input.value);
        if (company.input.value) params.set('company', company.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/tenders?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const st = q.get('status') || '';
      const comp = q.get('company') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.tenders];
      if (s) items = items.filter(t => (t.title || '').toLowerCase().includes(s) || (t.refNumber || '').toLowerCase().includes(s));
      if (st) items = items.filter(t => t.status === st);
      if (comp) items = items.filter(t => t.companyId === comp);
      if (fromTs) items = items.filter(t => t.submissionDeadline && startOfDay(t.submissionDeadline) >= startOfDay(fromTs));
      if (toTs) items = items.filter(t => t.submissionDeadline && startOfDay(t.submissionDeadline) <= startOfDay(toTs));
      items.sort((a, b) => (a.submissionDeadline || Infinity) - (b.submissionDeadline || Infinity));

      if (!items.length) {
        root.appendChild(mkEmpty('لا توجد مناقصات مطابقة للبحث/التصفية. يمكنك إضافة مناقصة جديدة.', [
          mkBtn('+ إضافة مناقصة', 'primary', () => openTenderForm()),
          mkBtn('إزالة التصفية', 'secondary', () => location.hash = '#/tenders')
        ]));
        return;
      }

      const rows = items.map(t => {
        const title = document.createElement('div');
        title.innerHTML = `<div class="font-semibold">${escapeHtml(t.title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(getCompanyName(t.companyId))}</div>`;
        const statusBadge = document.createElement('div');
        statusBadge.className = 'flex flex-col items-start gap-2';
        statusBadge.appendChild(mkBadge(labels.TenderStatus[t.status] || t.status, t.status === 'AWARDED' ? 'emerald' : (t.status === 'LOST' ? 'rose' : 'blue')));
        statusBadge.appendChild(mkBadge(labels.TenderType[t.type] || t.type, 'slate'));

        const dateInfo = document.createElement('div');
        dateInfo.className = 'text-xs text-slate-600';
        dateInfo.innerHTML = `آخر موعد تقديم: <b>${fmtDate(t.submissionDeadline)}</b><br/>فتح فني: ${fmtDate(t.technicalOpeningDate)} • فتح مالي: ${fmtDate(t.financialOpeningDate)}`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('فتح', 'secondary', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`));
        actions.appendChild(mkBtn('تعديل', 'secondary', () => openTenderForm(t)));
        actions.appendChild(mkBtn('حذف', 'danger', () => {
          const ok = confirm(`حذف المناقصة "${t.title}"؟`);
          if (!ok) return;
          deleteTenderCascade(t.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([title, statusBadge, dateInfo, actions]);
      });

      root.appendChild(mkTable(['العنوان', 'الحالة/النوع', 'التواريخ', 'إجراءات'], rows));
    }

    function openTenderForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'الشركة *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'اختر شركة...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))],
        help: 'يفضّل إنشاء الشركة أولاً ثم ربط المناقصة بها.'
      });
      const fTitle = mkField({ label: 'عنوان المناقصة/الفرصة *', value: existing?.title || '', placeholder: 'مثال: توريد معدات...' });
      const fRef = mkField({ label: 'رقم/مرجع (اختياري)', value: existing?.refNumber || '' });
      const fType = mkField({
        label: 'النوع',
        type: 'select',
        value: existing?.type || 'TENDER',
        options: Enums.TenderType.map(v => ({ value: v, label: labels.TenderType[v] || v }))
      });
      const fStatus = mkField({
        label: 'الحالة',
        type: 'select',
        value: existing?.status || 'PREPARATION',
        options: Enums.TenderStatus.map(v => ({ value: v, label: labels.TenderStatus[v] || v }))
      });

      const fDocsDeadline = mkField({ label: 'آخر موعد شراء الكراسة (اختياري)', type: 'date', value: toISODate(existing?.docsPurchaseDeadline) });
      const fSubmission = mkField({ label: 'آخر موعد تقديم العرض *', type: 'date', value: toISODate(existing?.submissionDeadline) });
      const fTechOpen = mkField({ label: 'فتح المظروف الفني (اختياري)', type: 'date', value: toISODate(existing?.technicalOpeningDate) });
      const fFinOpen = mkField({ label: 'فتح المظروف المالي (اختياري)', type: 'date', value: toISODate(existing?.financialOpeningDate) });
      const fAward = mkField({ label: 'تاريخ الترسية (اختياري)', type: 'date', value: toISODate(existing?.awardDate) });

      const fExpectedValue = mkField({ label: 'القيمة المتوقعة (اختياري)', type: 'number', value: existing?.expectedValue ?? '' });
      const fFinalValue = mkField({ label: 'القيمة النهائية (اختياري)', type: 'number', value: existing?.finalValue ?? '' });
      const fPrimaryG = mkField({ label: 'الضمان الابتدائي (اختياري)', type: 'number', value: existing?.primaryGuarantee ?? '' });
      const fFinalG = mkField({ label: 'الضمان النهائي (اختياري)', type: 'number', value: existing?.finalGuarantee ?? '' });
      const fMargin = mkField({ label: 'هامش الربح % (اختياري)', type: 'number', value: existing?.margin ?? '' });

      const fNotes = mkField({ label: 'ملاحظات', type: 'textarea', rows: 4, value: existing?.notes || '', placeholder: 'منافسين، شروط خاصة، ...' });

      body.appendChild(mkTwoCols(fCompany.wrap, fTitle.wrap));
      body.appendChild(mkTwoCols(fRef.wrap, fType.wrap));
      body.appendChild(mkTwoCols(fStatus.wrap, fSubmission.wrap));
      body.appendChild(mkTwoCols(fDocsDeadline.wrap, fTechOpen.wrap));
      body.appendChild(mkTwoCols(fFinOpen.wrap, fAward.wrap));

      const finHeader = document.createElement('div');
      finHeader.className = 'mt-3 text-sm font-bold';
      finHeader.textContent = 'بيانات مالية (اختياري)';
      body.appendChild(finHeader);
      body.appendChild(mkTwoCols(fExpectedValue.wrap, fFinalValue.wrap));
      body.appendChild(mkTwoCols(fPrimaryG.wrap, fFinalG.wrap));
      body.appendChild(mkTwoCols(fMargin.wrap, document.createElement('div')));
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'تعديل مناقصة' : 'إضافة مناقصة',
        subtitle: 'الحد الأدنى المطلوب: شركة + عنوان + آخر موعد تقديم.',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ' : 'إضافة',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const title = fTitle.input.value.trim();
          const submission = fromISODate(fSubmission.input.value);
          if (!companyId) return alert('اختر الشركة.');
          if (!title) return alert('العنوان مطلوب.');
          if (!submission) return alert('آخر موعد تقديم العرض مطلوب.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            title,
            refNumber: fRef.input.value.trim() || null,
            type: fType.input.value,
            status: fStatus.input.value,
            docsPurchaseDeadline: fromISODate(fDocsDeadline.input.value),
            submissionDeadline: submission,
            technicalOpeningDate: fromISODate(fTechOpen.input.value),
            financialOpeningDate: fromISODate(fFinOpen.input.value),
            awardDate: fromISODate(fAward.input.value),
            expectedValue: toNumOrNull(fExpectedValue.input.value),
            finalValue: toNumOrNull(fFinalValue.input.value),
            primaryGuarantee: toNumOrNull(fPrimaryG.input.value),
            finalGuarantee: toNumOrNull(fFinalG.input.value),
            margin: toNumOrNull(fMargin.input.value),
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };
          upsert('tenders', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function toNumOrNull(v) {
      const s = (v ?? '').toString().trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function deleteTenderCascade(tenderId) {
      state.tenders = state.tenders.filter(t => t.id !== tenderId);
      state.tasks = state.tasks.filter(t => !(t.relatedType === 'TENDER' && t.relatedId === tenderId));
      state.followups = state.followups.filter(f => f.tenderId !== tenderId);
    }

    function renderTenderDetails(root, id) {
      const t = state.tenders.find(x => x.id === id);
      if (!t) {
        setPage('المناقصة غير موجودة', 'قد تكون حُذفت أو لم يتم العثور عليها.');
        root.appendChild(mkEmpty('لا يمكن العثور على المناقصة المطلوبة.', [mkBtn('العودة للمناقصات', 'secondary', () => location.hash = '#/tenders')]));
        return;
      }
      const companyName = getCompanyName(t.companyId);
      setPage(t.title, `الشركة: ${companyName}`, [
        mkBtn('تعديل', 'secondary', () => openTenderForm(t)),
        mkBtn('+ مهمة مرتبطة', 'primary', () => openTaskForm({ relatedType: 'TENDER', relatedId: t.id })),
        mkBtn('فتح الشركة', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(t.companyId)}`)
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const basic = document.createElement('div');
      basic.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      basic.innerHTML = `
        <div class="text-sm font-bold">معلومات أساسية</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">النوع</div><div class="font-semibold mt-1">${escapeHtml(labels.TenderType[t.type] || t.type)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">الحالة</div><div class="font-semibold mt-1">${escapeHtml(labels.TenderStatus[t.status] || t.status)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">رقم/مرجع</div><div class="font-semibold mt-1">${escapeHtml(t.refNumber || '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">آخر موعد تقديم</div><div class="font-semibold mt-1">${fmtDate(t.submissionDeadline)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">شراء الكراسة</div><div class="font-semibold mt-1">${fmtDate(t.docsPurchaseDeadline)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">فتح فني/مالي</div><div class="font-semibold mt-1">${fmtDate(t.technicalOpeningDate)} / ${fmtDate(t.financialOpeningDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">تاريخ الترسية</div><div class="font-semibold mt-1">${fmtDate(t.awardDate)}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ملاحظات</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(t.notes || '—')}</div></div>
        </div>
      `;

      const financial = document.createElement('div');
      financial.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      financial.innerHTML = `
        <div class="text-sm font-bold">ملخص مالي</div>
        <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">متوقعة</div><div class="font-semibold mt-1">${escapeHtml(t.expectedValue ?? '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">نهائية</div><div class="font-semibold mt-1">${escapeHtml(t.finalValue ?? '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ضمان ابتدائي</div><div class="font-semibold mt-1">${escapeHtml(t.primaryGuarantee ?? '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ضمان نهائي</div><div class="font-semibold mt-1">${escapeHtml(t.finalGuarantee ?? '—')}</div></div>
          <div class="col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">هامش</div><div class="font-semibold mt-1">${escapeHtml(t.margin ?? '—')}</div></div>
        </div>
        <div class="mt-4 text-xs text-slate-500">آخر تحديث: ${fmtDateTime(t.updatedAt)}</div>
      `;

      top.appendChild(basic);
      top.appendChild(financial);
      root.appendChild(top);

      // Related tasks
      const related = state.tasks.filter(x => x.relatedType === 'TENDER' && x.relatedId === t.id)
        .map(x => ({ ...x, status: computeTaskStatus(x) }))
        .sort((a, b) => (a.dueDate || Infinity) - (b.dueDate || Infinity));

      const tasksBox = document.createElement('div');
      tasksBox.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      tasksBox.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">مهام مرتبطة بالمناقصة</div>
            <div class="text-xs text-slate-500 mt-1">${related.length} مهمة</div>
          </div>
        </div>
      `;
      const list = document.createElement('div');
      list.className = 'mt-3 flex flex-col gap-2';
      if (!related.length) {
        list.appendChild(mkEmpty('أضف مهام مثل: شراء الكراسة، تسليم العرض الفني، إلخ.', [
          mkBtn('+ إضافة مهمة', 'primary', () => openTaskForm({ relatedType: 'TENDER', relatedId: t.id }))
        ]));
      } else {
        related.forEach(tt => list.appendChild(taskRow(tt)));
      }
      tasksBox.appendChild(list);
      root.appendChild(tasksBox);
    }

    // =============================
    // Contracts
    // =============================
    function renderContracts(root, q) {
      setPage('العقود', 'بحث وتصفية حسب الحالة والشركة وتواريخ النهاية/التجديد.', [
        mkBtn('+ إضافة عقد', 'primary', () => openContractForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'بحث', placeholder: 'العنوان أو رقم العقد...', value: q.get('s') || '' });
      const status = mkField({
        label: 'الحالة',
        type: 'select',
        value: q.get('status') || '',
        options: [{ value: '', label: 'الكل' }, ...Enums.ContractStatus.map(v => ({ value: v, label: labels.ContractStatus[v] || v }))]
      });
      const company = mkField({
        label: 'الشركة',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'الكل' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const from = mkField({ label: 'من تاريخ نهاية/تجديد', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'إلى تاريخ نهاية/تجديد', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(search.wrap, status.wrap));
      controls.appendChild(mkTwoCols(company.wrap, from.wrap));
      controls.appendChild(mkTwoCols(to.wrap, document.createElement('div')));

      const apply = mkBtn('تطبيق', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (status.input.value) params.set('status', status.input.value);
        if (company.input.value) params.set('company', company.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/contracts?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const st = q.get('status') || '';
      const comp = q.get('company') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.contracts];
      if (s) items = items.filter(c => (c.title || '').toLowerCase().includes(s) || (c.contractNumber || '').toLowerCase().includes(s));
      if (st) items = items.filter(c => c.status === st);
      if (comp) items = items.filter(c => c.companyId === comp);
      if (fromTs) items = items.filter(c => {
        const dt = c.renewalDate || c.endDate;
        return dt && startOfDay(dt) >= startOfDay(fromTs);
      });
      if (toTs) items = items.filter(c => {
        const dt = c.renewalDate || c.endDate;
        return dt && startOfDay(dt) <= startOfDay(toTs);
      });
      items.sort((a, b) => ((a.renewalDate || a.endDate || Infinity) - (b.renewalDate || b.endDate || Infinity)));

      if (!items.length) {
        root.appendChild(mkEmpty('لا توجد عقود مطابقة للبحث/التصفية. يمكنك إضافة عقد جديد.', [
          mkBtn('+ إضافة عقد', 'primary', () => openContractForm()),
          mkBtn('إزالة التصفية', 'secondary', () => location.hash = '#/contracts')
        ]));
        return;
      }

      const rows = items.map(c => {
        const title = document.createElement('div');
        title.innerHTML = `<div class="font-semibold">${escapeHtml(c.title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(getCompanyName(c.companyId))}</div>`;

        const statusBadge = document.createElement('div');
        statusBadge.className = 'flex flex-col items-start gap-2';
        statusBadge.appendChild(mkBadge(labels.ContractStatus[c.status] || c.status, c.status === 'ACTIVE' ? 'emerald' : (c.status === 'EXPIRED' ? 'rose' : 'amber')));

        const dateInfo = document.createElement('div');
        dateInfo.className = 'text-xs text-slate-600';
        dateInfo.innerHTML = `البداية: ${fmtDate(c.startDate)}<br/>النهاية: <b>${fmtDate(c.endDate)}</b><br/>تجديد: ${fmtDate(c.renewalDate)}`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('فتح', 'secondary', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`));
        actions.appendChild(mkBtn('تعديل', 'secondary', () => openContractForm(c)));
        actions.appendChild(mkBtn('حذف', 'danger', () => {
          const ok = confirm(`حذف العقد "${c.title}"؟`);
          if (!ok) return;
          deleteContractCascade(c.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([title, statusBadge, dateInfo, actions]);
      });

      root.appendChild(mkTable(['العنوان', 'الحالة', 'التواريخ', 'إجراءات'], rows));
    }

    function openContractForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'الشركة *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'اختر شركة...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const fTitle = mkField({ label: 'عنوان العقد *', value: existing?.title || '', placeholder: 'مثال: عقد صيانة...' });
      const fNumber = mkField({ label: 'رقم العقد (اختياري)', value: existing?.contractNumber || '' });

      const fStart = mkField({ label: 'تاريخ البداية *', type: 'date', value: toISODate(existing?.startDate) });
      const fEnd = mkField({ label: 'تاريخ النهاية *', type: 'date', value: toISODate(existing?.endDate) });
      const fRenewal = mkField({ label: 'تاريخ تجديد/مراجعة (اختياري)', type: 'date', value: toISODate(existing?.renewalDate) });

      const fValue = mkField({ label: 'قيمة العقد *', type: 'number', value: existing?.value ?? '' });
      const fPayment = mkField({ label: 'شروط الدفع', value: existing?.paymentTerms || '', placeholder: 'مثال: شهري / ربع سنوي / دفعات...' });
      const fStatus = mkField({
        label: 'الحالة',
        type: 'select',
        value: existing?.status || 'ACTIVE',
        options: Enums.ContractStatus.map(v => ({ value: v, label: labels.ContractStatus[v] || v }))
      });

      const fNotes = mkField({ label: 'ملاحظات', type: 'textarea', rows: 4, value: existing?.notes || '' });

      body.appendChild(mkTwoCols(fCompany.wrap, fTitle.wrap));
      body.appendChild(mkTwoCols(fNumber.wrap, fStatus.wrap));
      body.appendChild(mkTwoCols(fStart.wrap, fEnd.wrap));
      body.appendChild(mkTwoCols(fRenewal.wrap, fValue.wrap));
      body.appendChild(fPayment.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'تعديل عقد' : 'إضافة عقد',
        subtitle: 'الحد الأدنى: شركة + عنوان + بداية + نهاية + قيمة.',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ' : 'إضافة',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const title = fTitle.input.value.trim();
          const startDate = fromISODate(fStart.input.value);
          const endDate = fromISODate(fEnd.input.value);
          const value = toNumOrNull(fValue.input.value);
          if (!companyId) return alert('اختر الشركة.');
          if (!title) return alert('عنوان العقد مطلوب.');
          if (!startDate) return alert('تاريخ البداية مطلوب.');
          if (!endDate) return alert('تاريخ النهاية مطلوب.');
          if (value === null) return alert('قيمة العقد مطلوبة.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            title,
            contractNumber: fNumber.input.value.trim() || null,
            startDate,
            endDate,
            value,
            paymentTerms: fPayment.input.value.trim() || null,
            renewalDate: fromISODate(fRenewal.input.value),
            status: fStatus.input.value,
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };

          upsert('contracts', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function deleteContractCascade(contractId) {
      state.contracts = state.contracts.filter(c => c.id !== contractId);
      state.tasks = state.tasks.filter(t => !(t.relatedType === 'CONTRACT' && t.relatedId === contractId));
      state.followups = state.followups.filter(f => f.contractId !== contractId);
    }

    function renderContractDetails(root, id) {
      const c = state.contracts.find(x => x.id === id);
      if (!c) {
        setPage('العقد غير موجود', 'قد يكون حُذف أو لم يتم العثور عليه.');
        root.appendChild(mkEmpty('لا يمكن العثور على العقد المطلوب.', [mkBtn('العودة للعقود', 'secondary', () => location.hash = '#/contracts')]));
        return;
      }
      const companyName = getCompanyName(c.companyId);
      setPage(c.title, `الشركة: ${companyName}`, [
        mkBtn('تعديل', 'secondary', () => openContractForm(c)),
        mkBtn('+ مهمة مرتبطة', 'primary', () => openTaskForm({ relatedType: 'CONTRACT', relatedId: c.id })),
        mkBtn('فتح الشركة', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(c.companyId)}`)
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const basic = document.createElement('div');
      basic.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      basic.innerHTML = `
        <div class="text-sm font-bold">معلومات أساسية</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">الحالة</div><div class="font-semibold mt-1">${escapeHtml(labels.ContractStatus[c.status] || c.status)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">رقم العقد</div><div class="font-semibold mt-1">${escapeHtml(c.contractNumber || '—')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">تاريخ البداية</div><div class="font-semibold mt-1">${fmtDate(c.startDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">تاريخ النهاية</div><div class="font-semibold mt-1">${fmtDate(c.endDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">تاريخ التجديد/المراجعة</div><div class="font-semibold mt-1">${fmtDate(c.renewalDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">قيمة العقد</div><div class="font-semibold mt-1">${escapeHtml(c.value ?? '—')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">شروط الدفع</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(c.paymentTerms || '—')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ملاحظات</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(c.notes || '—')}</div></div>
        </div>
      `;

      const side = document.createElement('div');
      side.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const next = c.renewalDate || c.endDate;
      const days = next ? Math.round((startOfDay(next) - startOfDay(nowTs())) / (24 * 60 * 60 * 1000)) : null;
      side.innerHTML = `
        <div class="text-sm font-bold">تنبيه</div>
        <div class="mt-3 p-3 rounded-xl bg-slate-50 border border-slate-200">
          <div class="text-xs text-slate-500">أقرب تاريخ</div>
          <div class="text-lg font-bold mt-1">${fmtDate(next)}</div>
          <div class="text-xs text-slate-600 mt-1">${days === null ? '—' : (days >= 0 ? `بعد ${days} يوم` : `منذ ${Math.abs(days)} يوم`)}</div>
        </div>
        <div class="mt-4 text-xs text-slate-500">آخر تحديث: ${fmtDateTime(c.updatedAt)}</div>
      `;

      top.appendChild(basic);
      top.appendChild(side);
      root.appendChild(top);

      // Related tasks
      const related = state.tasks.filter(x => x.relatedType === 'CONTRACT' && x.relatedId === c.id)
        .map(x => ({ ...x, status: computeTaskStatus(x) }))
        .sort((a, b) => (a.dueDate || Infinity) - (b.dueDate || Infinity));

      const tasksBox = document.createElement('div');
      tasksBox.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      tasksBox.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">مهام مرتبطة بالعقد</div>
            <div class="text-xs text-slate-500 mt-1">${related.length} مهمة</div>
          </div>
        </div>
      `;
      const list = document.createElement('div');
      list.className = 'mt-3 flex flex-col gap-2';
      if (!related.length) {
        list.appendChild(mkEmpty('أضف مهام مثل: مراجعة التجديد، تجهيز مستندات، إلخ.', [
          mkBtn('+ إضافة مهمة', 'primary', () => openTaskForm({ relatedType: 'CONTRACT', relatedId: c.id }))
        ]));
      } else {
        related.forEach(tt => list.appendChild(taskRow(tt)));
      }
      tasksBox.appendChild(list);
      root.appendChild(tasksBox);
    }

    // =============================
    // Tasks
    // =============================
    function renderTasks(root, q) {
      setPage('المهام', 'قائمة المهام مع فلاتر (اليوم/متأخرة/الأولوية).', [
        mkBtn('+ إضافة مهمة', 'primary', () => openTaskForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const filter = mkField({
        label: 'فلتر سريع',
        type: 'select',
        value: q.get('filter') || '',
        options: [
          { value: '', label: 'الكل' },
          { value: 'today', label: 'مستحقة اليوم' },
          { value: 'overdue', label: 'متأخرة' },
          { value: 'open', label: 'غير منتهية' },
          { value: 'done', label: 'منتهية' }
        ]
      });
      const priority = mkField({
        label: 'الأولوية',
        type: 'select',
        value: q.get('priority') || '',
        options: [{ value: '', label: 'الكل' }, ...Enums.TaskPriority.map(v => ({ value: v, label: labels.TaskPriority[v] || v }))]
      });
      const relatedType = mkField({
        label: 'نوع الارتباط',
        type: 'select',
        value: q.get('rt') || '',
        options: [{ value: '', label: 'الكل' }, ...Enums.RelatedType.map(v => ({ value: v, label: labels.RelatedType[v] || v }))]
      });
      const search = mkField({ label: 'بحث', placeholder: 'عنوان المهمة...', value: q.get('s') || '' });

      controls.appendChild(mkTwoCols(filter.wrap, priority.wrap));
      controls.appendChild(mkTwoCols(relatedType.wrap, search.wrap));

      const apply = mkBtn('تطبيق', 'secondary', () => {
        const params = new URLSearchParams();
        if (filter.input.value) params.set('filter', filter.input.value);
        if (priority.input.value) params.set('priority', priority.input.value);
        if (relatedType.input.value) params.set('rt', relatedType.input.value);
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        location.hash = `#/tasks?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const today = startOfDay(nowTs());
      let items = state.tasks.map(t => ({ ...t, status: computeTaskStatus(t) }));

      const f = q.get('filter') || '';
      if (f === 'today') items = items.filter(t => t.dueDate && startOfDay(t.dueDate) === today && t.status !== 'DONE');
      if (f === 'overdue') items = items.filter(t => t.status === 'OVERDUE');
      if (f === 'open') items = items.filter(t => t.status !== 'DONE');
      if (f === 'done') items = items.filter(t => t.status === 'DONE');

      const pr = q.get('priority') || '';
      if (pr) items = items.filter(t => t.priority === pr);

      const rt = q.get('rt') || '';
      if (rt) items = items.filter(t => t.relatedType === rt);

      const s = (q.get('s') || '').toLowerCase();
      if (s) items = items.filter(t => (t.title || '').toLowerCase().includes(s));

      items.sort((a, b) => (a.status === 'OVERDUE' ? -1 : 0) - (b.status === 'OVERDUE' ? -1 : 0) || (a.dueDate || Infinity) - (b.dueDate || Infinity));

      if (!items.length) {
        root.appendChild(mkEmpty('لا توجد مهام مطابقة. جرّب إضافة مهمة جديدة أو تغيير الفلاتر.', [
          mkBtn('+ إضافة مهمة', 'primary', () => openTaskForm()),
          mkBtn('إزالة الفلاتر', 'secondary', () => location.hash = '#/tasks')
        ]));
        return;
      }

      const list = document.createElement('div');
      list.className = 'mt-4 flex flex-col gap-2';
      items.forEach(t => list.appendChild(taskRow(t)));
      root.appendChild(list);
    }

    function openTaskForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fRelatedType = mkField({
        label: 'نوع الارتباط *',
        type: 'select',
        value: existing?.relatedType || defaults.relatedType || 'COMPANY',
        options: Enums.RelatedType.map(v => ({ value: v, label: labels.RelatedType[v] || v }))
      });

      const fRelatedId = mkField({
        label: 'العنصر المرتبط *',
        type: 'select',
        value: existing?.relatedId || defaults.relatedId || '',
        options: [{ value: '', label: '—' }]
      });

      const fTitle = mkField({ label: 'عنوان المهمة *', value: existing?.title || '', placeholder: 'مثال: شراء كراسة الشروط' });
      const fDesc = mkField({ label: 'الوصف (اختياري)', type: 'textarea', rows: 3, value: existing?.description || '' });
      const fDue = mkField({ label: 'تاريخ الاستحقاق *', type: 'date', value: toISODate(existing?.dueDate) });

      const fPriority = mkField({
        label: 'الأولوية',
        type: 'select',
        value: existing?.priority || 'MEDIUM',
        options: Enums.TaskPriority.map(v => ({ value: v, label: labels.TaskPriority[v] || v }))
      });

      const fStatus = mkField({
        label: 'الحالة',
        type: 'select',
        value: existing?.status || 'NEW',
        options: Enums.TaskStatus.map(v => ({ value: v, label: labels.TaskStatus[v] || v }))
      });

      const fReminder = mkField({
        label: 'تذكير قبل الاستحقاق (أيام)',
        type: 'select',
        value: (existing?.reminderOffset ?? 1).toString(),
        options: [
          { value: '0', label: 'بدون' },
          { value: '1', label: 'قبل يوم' },
          { value: '2', label: 'قبل يومين' },
          { value: '3', label: 'قبل 3 أيام' },
          { value: '7', label: 'قبل أسبوع' }
        ],
        help: 'في Android سيتم جدولة إشعار باستخدام WorkManager.'
      });

      function refreshRelatedOptions() {
        const rt = fRelatedType.input.value;
        let opts = [{ value: '', label: 'اختر...' }];
        if (rt === 'COMPANY') opts = opts.concat(state.companies.map(c => ({ value: c.id, label: c.name })));
        if (rt === 'TENDER') opts = opts.concat(state.tenders.map(t => ({ value: t.id, label: `${t.title} — ${getCompanyName(t.companyId)}` })));
        if (rt === 'CONTRACT') opts = opts.concat(state.contracts.map(c => ({ value: c.id, label: `${c.title} — ${getCompanyName(c.companyId)}` })));
        fRelatedId.input.innerHTML = '';
        opts.forEach(o => {
          const el = document.createElement('option');
          el.value = o.value;
          el.textContent = o.label;
          fRelatedId.input.appendChild(el);
        });

        // Keep current selection if exists
        const current = existing?.relatedId || defaults.relatedId || '';
        if (current && opts.some(o => o.value === current)) fRelatedId.input.value = current;
        else fRelatedId.input.value = '';
      }

      fRelatedType.input.addEventListener('change', refreshRelatedOptions);

      body.appendChild(mkTwoCols(fRelatedType.wrap, fRelatedId.wrap));
      body.appendChild(mkTwoCols(fTitle.wrap, fDue.wrap));
      body.appendChild(mkTwoCols(fPriority.wrap, fStatus.wrap));
      body.appendChild(fReminder.wrap);
      body.appendChild(fDesc.wrap);
      refreshRelatedOptions();

      openModal({
        title: isEdit ? 'تعديل مهمة' : 'إضافة مهمة',
        subtitle: 'اربط المهمة بشركة أو مناقصة أو عقد.',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ' : 'إضافة',
        body,
        onOk: async (close) => {
          const relatedType = fRelatedType.input.value;
          const relatedId = fRelatedId.input.value;
          const title = fTitle.input.value.trim();
          const dueDate = fromISODate(fDue.input.value);
          if (!relatedType) return alert('اختر نوع الارتباط.');
          if (!relatedId) return alert('اختر العنصر المرتبط.');
          if (!title) return alert('عنوان المهمة مطلوب.');
          if (!dueDate) return alert('تاريخ الاستحقاق مطلوب.');

          const obj = {
            id: existing?.id || uuid(),
            relatedType,
            relatedId,
            title,
            description: fDesc.input.value.trim() || null,
            dueDate,
            priority: fPriority.input.value,
            status: fStatus.input.value,
            reminderOffset: Number(fReminder.input.value || '0'),
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };

          upsert('tasks', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function updateTask(id, patch) {
      const idx = state.tasks.findIndex(t => t.id === id);
      if (idx < 0) return;
      state.tasks[idx] = { ...state.tasks[idx], ...patch };
      saveState(state);
    }

    // =============================
    // Follow-ups
    // =============================
    function renderFollowups(root, q) {
      setPage('المتابعات/الأنشطة', 'سجل الاتصالات والزيارات والبريد والواتساب...', [
        mkBtn('+ إضافة متابعة', 'primary', () => openFollowUpForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const company = mkField({
        label: 'الشركة',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'الكل' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const type = mkField({
        label: 'النوع',
        type: 'select',
        value: q.get('type') || '',
        options: [{ value: '', label: 'الكل' }, ...Enums.FollowUpType.map(v => ({ value: v, label: labels.FollowUpType[v] || v }))]
      });
      const from = mkField({ label: 'من تاريخ', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'إلى تاريخ', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(company.wrap, type.wrap));
      controls.appendChild(mkTwoCols(from.wrap, to.wrap));

      const apply = mkBtn('تطبيق', 'secondary', () => {
        const params = new URLSearchParams();
        if (company.input.value) params.set('company', company.input.value);
        if (type.input.value) params.set('type', type.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/followups?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const comp = q.get('company') || '';
      const tp = q.get('type') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.followups];
      if (comp) items = items.filter(f => f.companyId === comp);
      if (tp) items = items.filter(f => f.type === tp);
      if (fromTs) items = items.filter(f => f.dateTime && startOfDay(f.dateTime) >= startOfDay(fromTs));
      if (toTs) items = items.filter(f => f.dateTime && startOfDay(f.dateTime) <= startOfDay(toTs));
      items.sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0));

      if (!items.length) {
        root.appendChild(mkEmpty('لا توجد متابعات. أضف أول متابعة وربطها بشركة (ويمكن ربطها بمناقصة/عقد).', [
          mkBtn('+ إضافة متابعة', 'primary', () => openFollowUpForm()),
          mkBtn('إزالة الفلاتر', 'secondary', () => location.hash = '#/followups')
        ]));
        return;
      }

      const rows = items.slice(0, 200).map(f => {
        const left = document.createElement('div');
        left.innerHTML = `<div class="font-semibold">${escapeHtml(labels.FollowUpType[f.type] || f.type)} • ${fmtDateTime(f.dateTime)}</div>
          <div class="text-xs text-slate-500 mt-1">الشركة: ${escapeHtml(getCompanyName(f.companyId))}</div>`;

        const mid = document.createElement('div');
        mid.className = 'text-xs text-slate-600';
        const tenderPart = f.tenderId ? `مناقصة: ${escapeHtml(getTenderTitle(f.tenderId))}<br/>` : '';
        const contractPart = f.contractId ? `عقد: ${escapeHtml(getContractTitle(f.contractId))}<br/>` : '';
        mid.innerHTML = `${tenderPart}${contractPart}الشخص: ${escapeHtml(f.contactName || '—')}<br/>الملخص: ${escapeHtml(f.summary || '—')}`;

        const right = document.createElement('div');
        right.className = 'text-xs text-slate-600';
        right.innerHTML = `الخطوة التالية: ${escapeHtml(f.nextStep || '—')}<br/>تاريخها: <b>${fmtDate(f.nextStepDate)}</b>`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('تعديل', 'secondary', () => openFollowUpForm(f)));
        actions.appendChild(mkBtn('حذف', 'danger', () => {
          const ok = confirm('حذف المتابعة؟');
          if (!ok) return;
          state.followups = state.followups.filter(x => x.id !== f.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([left, mid, right, actions]);
      });

      root.appendChild(mkTable(['النشاط', 'تفاصيل', 'الخطوة التالية', 'إجراءات'], rows));
    }

    function openFollowUpForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'الشركة *',
        type: 'select',
        value: existing?.companyId || defaults.companyId || '',
        options: [{ value: '', label: 'اختر شركة...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const fType = mkField({
        label: 'نوع النشاط',
        type: 'select',
        value: existing?.type || 'CALL',
        options: Enums.FollowUpType.map(v => ({ value: v, label: labels.FollowUpType[v] || v }))
      });

      const fDateTime = mkField({ label: 'التاريخ والوقت *', type: 'datetime-local', value: toISODatetimeLocal(existing?.dateTime || nowTs()) });

      const fTender = mkField({ label: 'مناقصة (اختياري)', type: 'select', value: existing?.tenderId || '', options: [{ value: '', label: '—' }] });
      const fContract = mkField({ label: 'عقد (اختياري)', type: 'select', value: existing?.contractId || '', options: [{ value: '', label: '—' }] });

      const fContact = mkField({ label: 'اسم الشخص', value: existing?.contactName || '', placeholder: 'مثال: أ. محمد' });
      const fSummary = mkField({ label: 'ملخص *', type: 'textarea', rows: 4, value: existing?.summary || '' });
      const fNext = mkField({ label: 'الخطوة التالية (اختياري)', value: existing?.nextStep || '' });
      const fNextDate = mkField({ label: 'تاريخ الخطوة التالية (اختياري)', type: 'date', value: toISODate(existing?.nextStepDate) });

      function refreshTenderContractOptions() {
        const companyId = fCompany.input.value;
        const tenders = state.tenders.filter(t => t.companyId === companyId);
        const contracts = state.contracts.filter(c => c.companyId === companyId);

        fTender.input.innerHTML = '';
        [{ value: '', label: '—' }].concat(tenders.map(t => ({ value: t.id, label: t.title }))).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          fTender.input.appendChild(opt);
        });

        fContract.input.innerHTML = '';
        [{ value: '', label: '—' }].concat(contracts.map(c => ({ value: c.id, label: c.title }))).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          fContract.input.appendChild(opt);
        });

        if (existing?.tenderId && tenders.some(t => t.id === existing.tenderId)) fTender.input.value = existing.tenderId; else fTender.input.value = '';
        if (existing?.contractId && contracts.some(c => c.id === existing.contractId)) fContract.input.value = existing.contractId; else fContract.input.value = '';
      }

      fCompany.input.addEventListener('change', refreshTenderContractOptions);

      body.appendChild(mkTwoCols(fCompany.wrap, fType.wrap));
      body.appendChild(mkTwoCols(fDateTime.wrap, fContact.wrap));
      body.appendChild(mkTwoCols(fTender.wrap, fContract.wrap));
      body.appendChild(fSummary.wrap);
      body.appendChild(mkTwoCols(fNext.wrap, fNextDate.wrap));

      refreshTenderContractOptions();

      openModal({
        title: isEdit ? 'تعديل متابعة' : 'إضافة متابعة',
        subtitle: 'ربط المتابعة بشركة (مطلوب) وبمناقصة/عقد (اختياري).',
        hint: 'حقول * مطلوبة.',
        okText: isEdit ? 'حفظ' : 'إضافة',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const type = fType.input.value;
          const dateTime = fromISODatetimeLocal(fDateTime.input.value);
          const summary = fSummary.input.value.trim();
          if (!companyId) return alert('اختر الشركة.');
          if (!dateTime) return alert('التاريخ والوقت مطلوب.');
          if (!summary) return alert('الملخص مطلوب.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            tenderId: fTender.input.value || null,
            contractId: fContract.input.value || null,
            type,
            dateTime,
            contactName: fContact.input.value.trim() || null,
            summary,
            nextStep: fNext.input.value.trim() || null,
            nextStepDate: fromISODate(fNextDate.input.value)
          };

          upsert('followups', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    // =============================
    // Backup / Restore
    // =============================
    function renderBackup(root) {
      setPage('نسخ احتياطي / استعادة', 'تصدير/استيراد JSON محلي (بسيط).');

      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      card.innerHTML = `
        <div class="text-sm font-bold">تصدير/استيراد البيانات</div>
        <div class="text-xs text-slate-500 mt-1">هذا يصدّر/يستورد بيانات النموذج الويب. في مشروع Android يوجد هيكل Backup/Restore باستخدام ملف JSON عبر SAF.</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'mt-4 flex flex-col md:flex-row gap-2';

      const exportBtn = mkBtn('تصدير JSON', 'primary', () => {
        const payload = {
          exportedAt: new Date().toISOString(),
          version: 1,
          data: state
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `tcrm_backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      const importWrap = document.createElement('div');
      importWrap.className = 'flex items-center gap-2';
      const file = document.createElement('input');
      file.type = 'file';
      file.accept = 'application/json';
      file.className = 'block text-sm';

      const importBtn = mkBtn('استيراد', 'secondary', async () => {
        const f = file.files?.[0];
        if (!f) return alert('اختر ملف JSON أولاً.');
        const text = await f.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch { return alert('ملف غير صالح.'); }
        const incoming = parsed.data || parsed;
        if (!incoming || typeof incoming !== 'object') return alert('محتوى غير صالح.');
        const ok = confirm('سيتم استبدال البيانات الحالية بالمستورد. المتابعة؟');
        if (!ok) return;
        state = { ...defaultState(), ...incoming };
        saveState(state);
        alert('تم الاستيراد بنجاح.');
        renderRoute();
      });

      const wipeBtn = mkBtn('مسح كل البيانات', 'danger', () => {
        const ok = confirm('مسح جميع البيانات نهائياً؟');
        if (!ok) return;
        state = defaultState();
        saveState(state);
        renderRoute();
      });

      actions.appendChild(exportBtn);
      importWrap.appendChild(file);
      importWrap.appendChild(importBtn);
      actions.appendChild(importWrap);
      actions.appendChild(wipeBtn);

      card.appendChild(actions);
      root.appendChild(card);

      const help = document.createElement('div');
      help.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      help.innerHTML = `
        <div class="text-sm font-bold">ملاحظة عن Android</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <ul class="list-disc pr-5">
            <li>نسخة Android ستستخدم Room لتخزين البيانات محلياً فقط.</li>
            <li>النسخ الاحتياطي/الاستعادة ستكون عبر ملف JSON باستخدام Storage Access Framework.</li>
            <li>الإشعارات ستُجدول باستخدام WorkManager مع قنوات إشعار (NotificationChannel).</li>
          </ul>
        </div>
      `;
      root.appendChild(help);
    }

    // =============================
    // Android Project Generator
    // =============================
    function renderAndroidGenerator(root) {
      setPage('توليد مشروع Android Studio', 'ينشئ ZIP لمشروع Kotlin + Jetpack Compose + Room + WorkManager (RTL عربي) + MVVM.', [
        mkBtn('تحميل ZIP الآن', 'primary', () => downloadAndroidZip())
      ]);

      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      card.innerHTML = `
        <div class="text-sm font-bold">إعدادات المشروع</div>
        <div class="text-xs text-slate-500 mt-1">يمكنك تعديل الحزمة والـ SDK والإصدارات قبل التوليد. (افتراضات عملية وبسيطة)</div>
      `;

      const s = state.settings.android;

      const fAppName = mkField({ label: 'اسم التطبيق', value: s.appName });
      const fAppId = mkField({ label: 'applicationId', value: s.applicationId, placeholder: 'com.yourname.tendercrm' });
      const fPkg = mkField({ label: 'packageName', value: s.packageName, placeholder: 'com.yourname.tendercrm' });
      const fMin = mkField({ label: 'minSdk', type: 'number', value: s.minSdk });
      const fTarget = mkField({ label: 'targetSdk', type: 'number', value: s.targetSdk });

      const fKotlin = mkField({ label: 'Kotlin', value: s.kotlinVersion });
      const fAgp = mkField({ label: 'Android Gradle Plugin', value: s.agpVersion });
      const fComposeBom = mkField({ label: 'Compose BOM', value: s.composeBom });
      const fRoom = mkField({ label: 'Room', value: s.roomVersion });
      const fWork = mkField({ label: 'WorkManager', value: s.workVersion });
      const fNav = mkField({ label: 'Navigation Compose', value: s.navVersion });
      const fSer = mkField({ label: 'kotlinx.serialization', value: s.serializationVersion });

      const form = document.createElement('div');
      form.className = 'mt-4 grid grid-cols-1 md:grid-cols-2 gap-3';
      [fAppName, fAppId, fPkg, fMin, fTarget, fKotlin, fAgp, fComposeBom, fRoom, fWork, fNav, fSer].forEach(x => form.appendChild(x.wrap));

      const saveBtn = mkBtn('حفظ الإعدادات', 'secondary', () => {
        state.settings.android = {
          appName: fAppName.input.value.trim() || s.appName,
          applicationId: fAppId.input.value.trim() || s.applicationId,
          packageName: fPkg.input.value.trim() || s.packageName,
          minSdk: Number(fMin.input.value || s.minSdk),
          targetSdk: Number(fTarget.input.value || s.targetSdk),
          kotlinVersion: fKotlin.input.value.trim() || s.kotlinVersion,
          agpVersion: fAgp.input.value.trim() || s.agpVersion,
          composeBom: fComposeBom.input.value.trim() || s.composeBom,
          roomVersion: fRoom.input.value.trim() || s.roomVersion,
          workVersion: fWork.input.value.trim() || s.workVersion,
          navVersion: fNav.input.value.trim() || s.navVersion,
          serializationVersion: fSer.input.value.trim() || s.serializationVersion
        };
        saveState(state);
        alert('تم حفظ الإعدادات. يمكنك الآن تحميل ZIP.');
      });
      saveBtn.classList.add('mt-3');

      card.appendChild(form);
      card.appendChild(saveBtn);
      root.appendChild(card);

      const arch = document.createElement('div');
      arch.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      arch.innerHTML = `
        <div class="text-sm font-bold">المعمارية (MVVM) + هيكل الحزم</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <div class="text-xs text-slate-500">المشروع المولّد يحتوي على:</div>
          <pre class="mt-3 p-3 rounded-xl bg-slate-950 text-slate-100 overflow-auto text-xs"><code>\
${escapeHtml(renderPackageStructure())}\
</code></pre>
          <div class="mt-3 text-xs text-slate-600">
            ملاحظة: يعتمد على Repository + ViewModel بدون DI framework (بسيط). يمكنك إضافة Hilt لاحقاً.
          </div>
        </div>
      `;
      root.appendChild(arch);

      const how = document.createElement('div');
      how.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      how.innerHTML = `
        <div class="text-sm font-bold">كيف تشغل المشروع في Android Studio؟</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <ol class="list-decimal pr-5">
            <li>اضغط <b>تحميل ZIP</b> ثم فك الضغط.</li>
            <li>افتح Android Studio → <span class="kbd">Open</span> واختر مجلد المشروع.</li>
            <li>انتظر Gradle Sync (قد يطلب تنزيل SDK/Build Tools).</li>
            <li>شغّل على جهازك عبر USB أو <span class="kbd">Build → Build APK(s)</span>.</li>
          </ol>
          <div class="mt-3 text-xs text-slate-600">إذا ظهرت مشكلة توافق إصدارات (AGP/Kotlin/Compose BOM)، عدّل الإصدارات في إعدادات التوليد ثم أعد تنزيل ZIP.</div>
        </div>
      `;
      root.appendChild(how);

      const preview = document.createElement('div');
      preview.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      preview.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">معاينة سريعة لما سيتم توليده</div>
            <div class="text-xs text-slate-500 mt-1">مقتطفات (غير كاملة) للتأكد من المحتوى.</div>
          </div>
          <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-refresh>تحديث المعاينة</button>
        </div>
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4" data-previews></div>
      `;
      const previews = $('[data-previews]', preview);
      const refresh = () => {
        previews.innerHTML = '';
        const settings = state.settings.android;
        const samples = getAndroidFileSamples(settings);
        samples.forEach(s => {
          const el = document.createElement('div');
          el.className = 'border border-slate-200 rounded-2xl overflow-hidden';
          el.innerHTML = `
            <div class="px-3 py-2 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
              <div class="text-xs font-semibold">${escapeHtml(s.path)}</div>
              <div class="text-[11px] text-slate-500">مقتطف</div>
            </div>
            <pre class="p-3 text-xs bg-slate-950 text-slate-100 overflow-auto max-h-64"><code>${escapeHtml(s.content)}</code></pre>
          `;
          previews.appendChild(el);
        });
      };
      $('[data-refresh]', preview).addEventListener('click', refresh);
      refresh();
      root.appendChild(preview);
    }

    function renderPackageStructure() {
      return `app/src/main/java/<package>/\
  App.kt\
  MainActivity.kt\
  di/\
    AppContainer.kt\
  data/\
    local/\
      AppDatabase.kt\
      Converters.kt\
      dao/\
        CompanyDao.kt\
        ContactDao.kt\
        TenderDao.kt\
        ContractDao.kt\
        TaskDao.kt\
        FollowUpDao.kt\
      entity/\
        CompanyEntity.kt\
        ContactEntity.kt\
        TenderEntity.kt\
        ContractEntity.kt\
        TaskEntity.kt\
        FollowUpEntity.kt\
      model/\
        Enums.kt\
  repo/\
    CompanyRepository.kt\
    TenderRepository.kt\
    ContractRepository.kt\
    TaskRepository.kt\
    FollowUpRepository.kt\
  ui/\
    navigation/\
      Routes.kt\
      AppNavHost.kt\
    screens/\
      DashboardScreen.kt\
      CompaniesScreen.kt\
      CompanyDetailsScreen.kt\
      TendersScreen.kt\
      TenderDetailsScreen.kt\
      ContractsScreen.kt\
      ContractDetailsScreen.kt\
      TasksScreen.kt\
      FollowUpsScreen.kt\
      BackupRestoreScreen.kt\
    components/\
      Ui.kt\
    theme/\
      Theme.kt\
  vm/\
    DashboardViewModel.kt\
    CompaniesViewModel.kt\
    CompanyDetailsViewModel.kt\
    TendersViewModel.kt\
    TenderDetailsViewModel.kt\
    ContractsViewModel.kt\
    ContractDetailsViewModel.kt\
    TasksViewModel.kt\
    FollowUpsViewModel.kt\
  notify/\
    NotificationWorker.kt\
    NotificationScheduler.kt\
  backup/\
    BackupModels.kt\
    BackupService.kt`;
    }

    function getAndroidFileSamples(settings) {
      const pkg = settings.packageName;
      const samplePaths = [
        { path: 'app/build.gradle.kts', content: androidTemplates.appBuildGradle(settings).split('\n').slice(0, 70).join('\n') + '\n…' },
        { path: 'MainActivity.kt', content: androidTemplates.mainActivity(settings).split('\n').slice(0, 90).join('\n') + '\n…' },
        { path: 'CompanyEntity.kt', content: androidTemplates.companyEntity(settings).split('\n').slice(0, 120).join('\n') + '\n…' },
        { path: 'NotificationScheduler.kt', content: androidTemplates.notificationScheduler(settings).split('\n').slice(0, 140).join('\n') + '\n…' }
      ];
      return samplePaths;
    }

    async function downloadAndroidZip() {
      // persist current settings first
      saveState(state);
      const settings = state.settings.android;

      // Basic validation
      if (!/^[a-zA-Z0-9_.]+$/.test(settings.applicationId)) {
        alert('applicationId غير صالح.');
        return;
      }
      if (!/^[a-zA-Z0-9_.]+$/.test(settings.packageName)) {
        alert('packageName غير صالح.');
        return;
      }

      const zip = await buildAndroidZip(settings);
      const blob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `TenderCRM_Android_${settings.applicationId}.zip`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function packageToPath(pkg) {
      return pkg.split('.').join('/');
    }

    async function buildAndroidZip(settings) {
      const zip = new JSZip();
      const pkgPath = packageToPath(settings.packageName);

      // Root files
      zip.file('settings.gradle.kts', androidTemplates.settingsGradle(settings));
      zip.file('build.gradle.kts', androidTemplates.rootBuildGradle(settings));
      zip.file('gradle.properties', androidTemplates.gradleProperties(settings));
      zip.file('README.md', androidTemplates.readme(settings));

      // app module
      zip.file('app/build.gradle.kts', androidTemplates.appBuildGradle(settings));
      zip.file('app/proguard-rules.pro', androidTemplates.proguard());
      zip.file('app/src/main/AndroidManifest.xml', androidTemplates.manifest(settings));

      // resources
      zip.file('app/src/main/res/values/strings.xml', androidTemplates.strings(settings));
      zip.file('app/src/main/res/values/themes.xml', androidTemplates.themes(settings));
      zip.file('app/src/main/res/xml/backup_rules.xml', androidTemplates.backupRules());
      zip.file('app/src/main/res/drawable/ic_launcher_background.xml', androidTemplates.launcherBg());
      zip.file('app/src/main/res/drawable-v24/ic_launcher_foreground.xml', androidTemplates.launcherFg());
      zip.file('app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml', androidTemplates.launcherXml());
      zip.file('app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml', androidTemplates.launcherXmlRound());

      // Kotlin sources
      const base = `app/src/main/java/${pkgPath}`;
      zip.file(`${base}/App.kt`, androidTemplates.appKt(settings));
      zip.file(`${base}/MainActivity.kt`, androidTemplates.mainActivity(settings));

      zip.file(`${base}/di/AppContainer.kt`, androidTemplates.appContainer(settings));

      zip.file(`${base}/data/model/Enums.kt`, androidTemplates.enumsKt(settings));

      zip.file(`${base}/data/local/Converters.kt`, androidTemplates.converters(settings));
      zip.file(`${base}/data/local/AppDatabase.kt`, androidTemplates.database(settings));

      zip.file(`${base}/data/local/entity/CompanyEntity.kt`, androidTemplates.companyEntity(settings));
      zip.file(`${base}/data/local/entity/ContactEntity.kt`, androidTemplates.contactEntity(settings));
      zip.file(`${base}/data/local/entity/TenderEntity.kt`, androidTemplates.tenderEntity(settings));
      zip.file(`${base}/data/local/entity/ContractEntity.kt`, androidTemplates.contractEntity(settings));
      zip.file(`${base}/data/local/entity/TaskEntity.kt`, androidTemplates.taskEntity(settings));
      zip.file(`${base}/data/local/entity/FollowUpEntity.kt`, androidTemplates.followUpEntity(settings));

      zip.file(`${base}/data/local/dao/CompanyDao.kt`, androidTemplates.companyDao(settings));
      zip.file(`${base}/data/local/dao/ContactDao.kt`, androidTemplates.contactDao(settings));
      zip.file(`${base}/data/local/dao/TenderDao.kt`, androidTemplates.tenderDao(settings));
      zip.file(`${base}/data/local/dao/ContractDao.kt`, androidTemplates.contractDao(settings));
      zip.file(`${base}/data/local/dao/TaskDao.kt`, androidTemplates.taskDao(settings));
      zip.file(`${base}/data/local/dao/FollowUpDao.kt`, androidTemplates.followUpDao(settings));

      zip.file(`${base}/repo/CompanyRepository.kt`, androidTemplates.companyRepo(settings));
      zip.file(`${base}/repo/TenderRepository.kt`, androidTemplates.tenderRepo(settings));
      zip.file(`${base}/repo/ContractRepository.kt`, androidTemplates.contractRepo(settings));
      zip.file(`${base}/repo/TaskRepository.kt`, androidTemplates.taskRepo(settings));
      zip.file(`${base}/repo/FollowUpRepository.kt`, androidTemplates.followUpRepo(settings));

      zip.file(`${base}/ui/theme/Theme.kt`, androidTemplates.themeKt(settings));
      zip.file(`${base}/ui/components/Ui.kt`, androidTemplates.uiComponents(settings));

      zip.file(`${base}/ui/navigation/Routes.kt`, androidTemplates.routes(settings));
      zip.file(`${base}/ui/navigation/AppNavHost.kt`, androidTemplates.navHost(settings));

      zip.file(`${base}/ui/screens/DashboardScreen.kt`, androidTemplates.dashboardScreen(settings));
      zip.file(`${base}/ui/screens/CompaniesScreen.kt`, androidTemplates.companiesScreen(settings));
      zip.file(`${base}/ui/screens/CompanyDetailsScreen.kt`, androidTemplates.companyDetailsScreen(settings));
      zip.file(`${base}/ui/screens/TendersScreen.kt`, androidTemplates.tendersScreen(settings));
      zip.file(`${base}/ui/screens/TenderDetailsScreen.kt`, androidTemplates.tenderDetailsScreen(settings));
      zip.file(`${base}/ui/screens/ContractsScreen.kt`, androidTemplates.contractsScreen(settings));
      zip.file(`${base}/ui/screens/ContractDetailsScreen.kt`, androidTemplates.contractDetailsScreen(settings));
      zip.file(`${base}/ui/screens/TasksScreen.kt`, androidTemplates.tasksScreen(settings));
      zip.file(`${base}/ui/screens/FollowUpsScreen.kt`, androidTemplates.followupsScreen(settings));
      zip.file(`${base}/ui/screens/BackupRestoreScreen.kt`, androidTemplates.backupRestoreScreen(settings));

      zip.file(`${base}/vm/DashboardViewModel.kt`, androidTemplates.dashboardVm(settings));
      zip.file(`${base}/vm/CompaniesViewModel.kt`, androidTemplates.companiesVm(settings));
      zip.file(`${base}/vm/CompanyDetailsViewModel.kt`, androidTemplates.companyDetailsVm(settings));
      zip.file(`${base}/vm/TendersViewModel.kt`, androidTemplates.tendersVm(settings));
      zip.file(`${base}/vm/TenderDetailsViewModel.kt`, androidTemplates.tenderDetailsVm(settings));
      zip.file(`${base}/vm/ContractsViewModel.kt`, androidTemplates.contractsVm(settings));
      zip.file(`${base}/vm/ContractDetailsViewModel.kt`, androidTemplates.contractDetailsVm(settings));
      zip.file(`${base}/vm/TasksViewModel.kt`, androidTemplates.tasksVm(settings));
      zip.file(`${base}/vm/FollowUpsViewModel.kt`, androidTemplates.followupsVm(settings));

      zip.file(`${base}/notify/NotificationWorker.kt`, androidTemplates.notificationWorker(settings));
      zip.file(`${base}/notify/NotificationScheduler.kt`, androidTemplates.notificationScheduler(settings));

      zip.file(`${base}/backup/BackupModels.kt`, androidTemplates.backupModels(settings));
      zip.file(`${base}/backup/BackupService.kt`, androidTemplates.backupService(settings));

      // Tests placeholders
      zip.file('app/src/test/java/' + pkgPath + '/ExampleUnitTest.kt', androidTemplates.unitTest(settings));
      zip.file('app/src/androidTest/java/' + pkgPath + '/ExampleInstrumentedTest.kt', androidTemplates.instrumentedTest(settings));

      return zip;
    }

    const androidTemplates = {
      settingsGradle: (s) => `pluginManagement {\n  repositories {\n    google()\n    mavenCentral()\n    gradlePluginPortal()\n  }\n}\n\ndependencyResolutionManagement {\n  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)\n  repositories {\n    google()\n    mavenCentral()\n  }\n}\n\nrootProject.name = "TenderCRM"\ninclude(":app")\n`,

      rootBuildGradle: (s) => `plugins {\n  id("com.android.application") version "${s.agpVersion}" apply false\n  id("org.jetbrains.kotlin.android") version "${s.kotlinVersion}" apply false\n  id("com.google.devtools.ksp") version "${s.kotlinVersion}-1.0.20" apply false\n  id("org.jetbrains.kotlin.plugin.serialization") version "${s.kotlinVersion}" apply false\n}\n`,

      gradleProperties: () => `org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8\nandroid.useAndroidX=true\nkotlin.code.style=official\nandroid.nonTransitiveRClass=true\n`,

      appBuildGradle: (s) => `plugins {\n  id("com.android.application")\n  id("org.jetbrains.kotlin.android")\n  id("com.google.devtools.ksp")\n  id("org.jetbrains.kotlin.plugin.serialization")\n}\n\nandroid {\n  namespace = "${s.packageName}"\n  compileSdk = ${s.targetSdk}\n\n  defaultConfig {\n    applicationId = "${s.applicationId}"\n    minSdk = ${s.minSdk}\n    targetSdk = ${s.targetSdk}\n    versionCode = 1\n    versionName = "1.0"\n\n    testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"\n    vectorDrawables {\n      useSupportLibrary = true\n    }\n  }\n\n  buildTypes {\n    release {\n      isMinifyEnabled = false\n      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")\n    }\n  }\n\n  compileOptions {\n    sourceCompatibility = JavaVersion.VERSION_17\n    targetCompatibility = JavaVersion.VERSION_17\n  }\n  kotlinOptions {\n    jvmTarget = "17"\n  }\n\n  buildFeatures {\n    compose = true\n  }\n\n  composeOptions {\n    // Compose compiler is managed by the Kotlin plugin in recent versions\n  }\n\n  packaging {\n    resources {\n      excludes += "/META-INF/{AL2.0,LGPL2.1}"\n    }\n  }\n}\n\ndependencies {\n  val composeBom = platform("androidx.compose:compose-bom:${s.composeBom}")\n  implementation(composeBom)\n  androidTestImplementation(composeBom)\n\n  implementation("androidx.core:core-ktx:1.15.0")\n  implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.8.7")\n  implementation("androidx.activity:activity-compose:1.9.3")\n\n  // Compose\n  implementation("androidx.compose.ui:ui")\n  implementation("androidx.compose.ui:ui-tooling-preview")\n  implementation("androidx.compose.material3:material3")\n  implementation("androidx.navigation:navigation-compose:${s.navVersion}")\n  implementation("androidx.lifecycle:lifecycle-runtime-compose:2.8.7")\n\n  // Room (KSP)\n  implementation("androidx.room:room-runtime:${s.roomVersion}")\n  implementation("androidx.room:room-ktx:${s.roomVersion}")\n  ksp("androidx.room:room-compiler:${s.roomVersion}")\n\n  // WorkManager\n  implementation("androidx.work:work-runtime-ktx:${s.workVersion}")\n\n  // Coroutines\n  implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.9.0")\n\n  // Serialization (JSON)\n  implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:${s.serializationVersion}")\n\n  // Tests\n  testImplementation("junit:junit:4.13.2")\n  androidTestImplementation("androidx.test.ext:junit:1.2.1")\n  androidTestImplementation("androidx.test.espresso:espresso-core:3.6.1")\n  androidTestImplementation("androidx.compose.ui:ui-test-junit4")\n\n  debugImplementation("androidx.compose.ui:ui-tooling")\n  debugImplementation("androidx.compose.ui:ui-test-manifest")\n}\n`,

      proguard: () => `# Keep it simple for v1\n`,

      manifest: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<manifest xmlns:android="http://schemas.android.com/apk/res/android">\n\n  <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />\n\n  <application\n    android:name=".${'App'}"\n    android:allowBackup="true"\n    android:dataExtractionRules="@xml/backup_rules"\n    android:fullBackupContent="@xml/backup_rules"\n    android:icon="@mipmap/ic_launcher"\n    android:label="@string/app_name"\n    android:roundIcon="@mipmap/ic_launcher_round"\n    android:supportsRtl="true"\n    android:theme="@style/Theme.TenderCRM">\n\n    <activity\n      android:name=".${'MainActivity'}"\n      android:exported="true">\n      <intent-filter>\n        <action android:name="android.intent.action.MAIN" />\n        <category android:name="android.intent.category.LAUNCHER" />\n      </intent-filter>\n    </activity>\n\n  </application>\n</manifest>\n`,

      strings: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<resources>\n  <string name="app_name">${escapeXml(s.appName)}</string>\n</resources>\n`,

      themes: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<resources xmlns:tools="http://schemas.android.com/tools">\n  <style name="Theme.TenderCRM" parent="android:Theme.Material.Light.NoActionBar">\n    <item name="android:statusBarColor">@android:color/transparent</item>\n    <item name="android:navigationBarColor">@android:color/transparent</item>\n  </style>\n</resources>\n`,

      backupRules: () => `<?xml version="1.0" encoding="utf-8"?>\n<full-backup-content>\n  <exclude domain="cache" />\n</full-backup-content>\n`,

      launcherBg: () => `<?xml version="1.0" encoding="utf-8"?>\n<vector xmlns:android="http://schemas.android.com/apk/res/android"\n  android:width="108dp"\n  android:height="108dp"\n  android:viewportWidth="108"\n  android:viewportHeight="108">\n  <path android:fillColor="#0F172A" android:pathData="M0,0h108v108h-108z"/>\n</vector>\n`,
      launcherFg: () => `<?xml version="1.0" encoding="utf-8"?>\n<vector xmlns:android="http://schemas.android.com/apk/res/android"\n  android:width="108dp"\n  android:height="108dp"\n  android:viewportWidth="108"\n  android:viewportHeight="108">\n  <path\n    android:fillColor="#FFFFFF"\n    android:pathData="M54,20c-7.7,0-14,6.3-14,14v40c0,7.7 6.3,14 14,14s14-6.3 14-14V34c0-7.7-6.3-14-14-14zm0,10c2.2,0 4,1.8 4,4v40c0,2.2-1.8,4-4,4s-4-1.8-4-4V34c0-2.2 1.8-4 4-4z" />\n</vector>\n`,
      launcherXml: () => `<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@drawable/ic_launcher_background" />\n  <foreground android:drawable="@drawable/ic_launcher_foreground" />\n</adaptive-icon>\n`,
      launcherXmlRound: () => `<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@drawable/ic_launcher_background" />\n  <foreground android:drawable="@drawable/ic_launcher_foreground" />\n</adaptive-icon>\n`,

      readme: (s) => `# ${s.appName}\n\nتطبيق شخصي يعمل أوفلاين لإدارة الشركات/المناقصات/العقود/المهام/المتابعات.\n\n## التشغيل\n1) فك الضغط\n2) افتح Android Studio → Open\n3) Gradle Sync\n4) Run\n\n## ملاحظات\n- Room + WorkManager + Jetpack Compose\n- UI عربية RTL (LayoutDirection.Rtl)\n- بدون حسابات وبدون Backend\n`,

      appKt: (s) => `package ${s.packageName}\n\nimport android.app.Application\nimport ${s.packageName}.di.AppContainer\n\nclass App : Application() {\n  lateinit var container: AppContainer\n    private set\n\n  override fun onCreate() {\n    super.onCreate()\n    container = AppContainer(this)\n  }\n}\n`,

      mainActivity: (s) => `package ${s.packageName}\n\nimport android.os.Bundle\nimport androidx.activity.ComponentActivity\nimport androidx.activity.compose.setContent\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Surface\nimport androidx.compose.runtime.CompositionLocalProvider\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.platform.LocalLayoutDirection\nimport androidx.compose.ui.unit.LayoutDirection\nimport ${s.packageName}.ui.navigation.AppNavHost\nimport ${s.packageName}.ui.theme.TenderCRMTheme\n\nclass MainActivity : ComponentActivity() {\n  override fun onCreate(savedInstanceState: Bundle?) {\n    super.onCreate(savedInstanceState)\n\n    setContent {\n      TenderCRMTheme {\n        CompositionLocalProvider(LocalLayoutDirection provides LayoutDirection.Rtl) {\n          Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {\n            AppNavHost()\n          }\n        }\n      }\n    }\n  }\n}\n`,

      appContainer: (s) => `package ${s.packageName}.di\n\nimport android.content.Context\nimport ${s.packageName}.data.local.AppDatabase\nimport ${s.packageName}.notify.NotificationScheduler\nimport ${s.packageName}.repo.CompanyRepository\nimport ${s.packageName}.repo.ContractRepository\nimport ${s.packageName}.repo.FollowUpRepository\nimport ${s.packageName}.repo.TaskRepository\nimport ${s.packageName}.repo.TenderRepository\n\nclass AppContainer(private val appContext: Context) {\n\n  private val db: AppDatabase by lazy {\n    AppDatabase.build(appContext)\n  }\n\n  val notificationScheduler: NotificationScheduler by lazy {\n    NotificationScheduler(appContext)\n  }\n\n  val companyRepository: CompanyRepository by lazy { CompanyRepository(db.companyDao()) }\n  val tenderRepository: TenderRepository by lazy { TenderRepository(db.tenderDao(), db.companyDao()) }\n  val contractRepository: ContractRepository by lazy { ContractRepository(db.contractDao(), db.companyDao()) }\n  val taskRepository: TaskRepository by lazy { TaskRepository(db.taskDao(), db.companyDao(), db.tenderDao(), db.contractDao()) }\n  val followUpRepository: FollowUpRepository by lazy { FollowUpRepository(db.followUpDao(), db.companyDao()) }\n}\n`,

      enumsKt: (s) => `package ${s.packageName}.data.model\n\nenum class TenderType { TENDER, PRACTICE, CONTRACT, DIRECT_SALE }\n\nenum class TenderStatus {\n  PREPARATION, OFFER_IN_PROGRESS, SUBMITTED, AWARDED, LOST, IN_PROGRESS, COMPLETED\n}\n\nenum class ContractStatus { ACTIVE, EXPIRED, SUSPENDED }\n\nenum class RelatedType { COMPANY, TENDER, CONTRACT }\n\nenum class TaskPriority { HIGH, MEDIUM, LOW }\n\nenum class TaskStatus { NEW, IN_PROGRESS, DONE, OVERDUE }\n\nenum class FollowUpType { CALL, VISIT, EMAIL, WHATSAPP, OTHER }\n`,

      converters: (s) => `package ${s.packageName}.data.local\n\nimport androidx.room.TypeConverter\nimport java.time.Instant\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.time.ZoneId\n\nobject Converters {\n\n  @TypeConverter\n  fun fromLocalDate(value: LocalDate?): Long? = value?.toEpochDay()\n\n  @TypeConverter\n  fun toLocalDate(value: Long?): LocalDate? = value?.let { LocalDate.ofEpochDay(it) }\n\n  @TypeConverter\n  fun fromLocalDateTime(value: LocalDateTime?): Long? = value?.atZone(ZoneId.systemDefault())?.toInstant()?.toEpochMilli()\n\n  @TypeConverter\n  fun toLocalDateTime(value: Long?): LocalDateTime? = value?.let {\n    LocalDateTime.ofInstant(Instant.ofEpochMilli(it), ZoneId.systemDefault())\n  }\n}\n`,

      database: (s) => `package ${s.packageName}.data.local\n\nimport android.content.Context\nimport androidx.room.Database\nimport androidx.room.Room\nimport androidx.room.RoomDatabase\nimport androidx.room.TypeConverters\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContactDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.dao.FollowUpDao\nimport ${s.packageName}.data.local.dao.TaskDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport ${s.packageName}.data.local.entity.ContactEntity\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\n\n@Database(\n  entities = [\n    CompanyEntity::class,\n    ContactEntity::class,\n    TenderEntity::class,\n    ContractEntity::class,\n    TaskEntity::class,\n    FollowUpEntity::class\n  ],\n  version = 1,\n  exportSchema = true\n)\n@TypeConverters(Converters::class)\nabstract class AppDatabase : RoomDatabase() {\n  abstract fun companyDao(): CompanyDao\n  abstract fun contactDao(): ContactDao\n  abstract fun tenderDao(): TenderDao\n  abstract fun contractDao(): ContractDao\n  abstract fun taskDao(): TaskDao\n  abstract fun followUpDao(): FollowUpDao\n\n  companion object {\n    fun build(context: Context): AppDatabase {\n      return Room.databaseBuilder(context, AppDatabase::class.java, "tender_crm.db")\n        .fallbackToDestructiveMigration()\n        .build()\n    }\n  }\n}\n`,

      companyEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.PrimaryKey\nimport java.time.LocalDateTime\n\n@Entity(tableName = "companies")\ndata class CompanyEntity(\n  @PrimaryKey val id: String,\n  val name: String,\n  val sector: String?,\n  val address: String?,\n  val phone1: String?,\n  val phone2: String?,\n  val email: String?,\n  val website: String?,\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      contactEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\n\n@Entity(\n  tableName = "contacts",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId")]\n)\ndata class ContactEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val name: String,\n  val role: String?,\n  val mobile: String?,\n  val email: String?,\n  val notes: String?\n)\n`,

      tenderEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.TenderStatus\nimport ${s.packageName}.data.model.TenderType\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "tenders",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("status"), Index("type")]\n)\ndata class TenderEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val title: String,\n  val refNumber: String?,\n  val type: TenderType,\n  val status: TenderStatus,\n\n  val docsPurchaseDeadline: LocalDate?,\n  val submissionDeadline: LocalDate,\n  val technicalOpeningDate: LocalDate?,\n  val financialOpeningDate: LocalDate?,\n  val awardDate: LocalDate?,\n\n  val expectedValue: Double?,\n  val finalValue: Double?,\n  val primaryGuarantee: Double?,\n  val finalGuarantee: Double?,\n  val margin: Double?,\n\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      contractEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.ContractStatus\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "contracts",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("status")]\n)\ndata class ContractEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val title: String,\n  val contractNumber: String?,\n  val startDate: LocalDate,\n  val endDate: LocalDate,\n  val value: Double,\n  val paymentTerms: String?,\n  val renewalDate: LocalDate?,\n  val status: ContractStatus,\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      taskEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.RelatedType\nimport ${s.packageName}.data.model.TaskPriority\nimport ${s.packageName}.data.model.TaskStatus\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "tasks",\n  indices = [Index("relatedType"), Index("relatedId"), Index("status"), Index("dueDate")]\n)\ndata class TaskEntity(\n  @PrimaryKey val id: String,\n  val relatedType: RelatedType,\n  val relatedId: String,\n  val title: String,\n  val description: String?,\n  val dueDate: LocalDate,\n  val priority: TaskPriority,\n  val status: TaskStatus,\n  val reminderOffset: Int,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      followUpEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.FollowUpType\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "followups",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("type"), Index("dateTime")]\n)\ndata class FollowUpEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val tenderId: String?,\n  val contractId: String?,\n  val type: FollowUpType,\n  val dateTime: LocalDateTime,\n  val contactName: String?,\n  val summary: String,\n  val nextStep: String?,\n  val nextStepDate: LocalDate?\n)\n`,

      companyDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Delete\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport androidx.room.Update\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface CompanyDao {\n\n  @Query("SELECT * FROM companies ORDER BY name COLLATE NOCASE")\n  fun observeAll(): Flow<List<CompanyEntity>>\n\n  @Query("SELECT * FROM companies WHERE id = :id")\n  fun observeById(id: String): Flow<CompanyEntity?>\n\n  @Query("SELECT * FROM companies WHERE id = :id")\n  suspend fun getById(id: String): CompanyEntity?\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: CompanyEntity)\n\n  @Update\n  suspend fun update(entity: CompanyEntity)\n\n  @Delete\n  suspend fun delete(entity: CompanyEntity)\n\n  @Query("DELETE FROM companies WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      contactDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.ContactEntity\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface ContactDao {\n  @Query("SELECT * FROM contacts WHERE companyId = :companyId ORDER BY name COLLATE NOCASE")\n  fun observeByCompany(companyId: String): Flow<List<ContactEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: ContactEntity)\n\n  @Query("DELETE FROM contacts WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      tenderDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TenderStatus\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface TenderDao {\n\n  @Query("SELECT * FROM tenders ORDER BY submissionDeadline ASC")\n  fun observeAll(): Flow<List<TenderEntity>>\n\n  @Query("SELECT * FROM tenders WHERE id = :id")\n  fun observeById(id: String): Flow<TenderEntity?>\n\n  @Query("SELECT * FROM tenders WHERE companyId = :companyId ORDER BY submissionDeadline ASC")\n  fun observeByCompany(companyId: String): Flow<List<TenderEntity>>\n\n  @Query("SELECT * FROM tenders WHERE status = :status ORDER BY submissionDeadline ASC")\n  fun observeByStatus(status: TenderStatus): Flow<List<TenderEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: TenderEntity)\n\n  @Query("DELETE FROM tenders WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      contractDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.model.ContractStatus\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface ContractDao {\n\n  @Query("SELECT * FROM contracts ORDER BY endDate ASC")\n  fun observeAll(): Flow<List<ContractEntity>>\n\n  @Query("SELECT * FROM contracts WHERE id = :id")\n  fun observeById(id: String): Flow<ContractEntity?>\n\n  @Query("SELECT * FROM contracts WHERE companyId = :companyId ORDER BY endDate ASC")\n  fun observeByCompany(companyId: String): Flow<List<ContractEntity>>\n\n  @Query("SELECT * FROM contracts WHERE status = :status ORDER BY endDate ASC")\n  fun observeByStatus(status: ContractStatus): Flow<List<ContractEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: ContractEntity)\n\n  @Query("DELETE FROM contracts WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      taskDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.Flow\nimport java.time.LocalDate\n\n@Dao\ninterface TaskDao {\n\n  @Query("SELECT * FROM tasks ORDER BY dueDate ASC")\n  fun observeAll(): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE id = :id")\n  fun observeById(id: String): Flow<TaskEntity?>\n\n  @Query("SELECT * FROM tasks WHERE relatedType = :relatedType AND relatedId = :relatedId ORDER BY dueDate ASC")\n  fun observeByRelated(relatedType: String, relatedId: String): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE dueDate = :date AND status != :doneStatus ORDER BY dueDate ASC")\n  fun observeDueOn(date: LocalDate, doneStatus: TaskStatus = TaskStatus.DONE): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE dueDate < :today AND status != :doneStatus ORDER BY dueDate ASC")\n  fun observeOverdue(today: LocalDate, doneStatus: TaskStatus = TaskStatus.DONE): Flow<List<TaskEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: TaskEntity)\n\n  @Query("UPDATE tasks SET status = :status WHERE id = :id")\n  suspend fun setStatus(id: String, status: TaskStatus)\n\n  @Query("DELETE FROM tasks WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      followUpDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.model.FollowUpType\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface FollowUpDao {\n\n  @Query("SELECT * FROM followups ORDER BY dateTime DESC")\n  fun observeAll(): Flow<List<FollowUpEntity>>\n\n  @Query("SELECT * FROM followups WHERE companyId = :companyId ORDER BY dateTime DESC")\n  fun observeByCompany(companyId: String): Flow<List<FollowUpEntity>>\n\n  @Query("SELECT * FROM followups WHERE type = :type ORDER BY dateTime DESC")\n  fun observeByType(type: FollowUpType): Flow<List<FollowUpEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: FollowUpEntity)\n\n  @Query("DELETE FROM followups WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      companyRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.Flow\n\nclass CompanyRepository(private val dao: CompanyDao) {\n  fun observeAll(): Flow<List<CompanyEntity>> = dao.observeAll()\n  fun observeById(id: String): Flow<CompanyEntity?> = dao.observeById(id)\n  suspend fun upsert(entity: CompanyEntity) = dao.upsert(entity)\n  suspend fun deleteById(id: String) = dao.deleteById(id)\n}\n`,

      tenderRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class TenderRow(\n  val tender: TenderEntity,\n  val companyName: String\n)\n\nclass TenderRepository(\n  private val tenderDao: TenderDao,\n  private val companyDao: CompanyDao\n) {\n\n  fun observeAllRows(): Flow<List<TenderRow>> = tenderDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "—"\n    }\n    list.map { TenderRow(it, companies[it.companyId] ?: "—") }\n  }\n\n  fun observeById(id: String) = tenderDao.observeById(id)\n\n  suspend fun upsert(entity: TenderEntity) = tenderDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = tenderDao.deleteById(id)\n}\n`,

      contractRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class ContractRow(\n  val contract: ContractEntity,\n  val companyName: String\n)\n\nclass ContractRepository(\n  private val contractDao: ContractDao,\n  private val companyDao: CompanyDao\n) {\n\n  fun observeAllRows(): Flow<List<ContractRow>> = contractDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "—"\n    }\n    list.map { ContractRow(it, companies[it.companyId] ?: "—") }\n  }\n\n  fun observeById(id: String) = contractDao.observeById(id)\n\n  suspend fun upsert(entity: ContractEntity) = contractDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = contractDao.deleteById(id)\n}\n`,

      taskRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.dao.TaskDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.RelatedType\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class TaskRow(\n  val task: TaskEntity,\n  val relatedTitle: String\n)\n\nclass TaskRepository(\n  private val taskDao: TaskDao,\n  private val companyDao: CompanyDao,\n  private val tenderDao: TenderDao,\n  private val contractDao: ContractDao\n) {\n\n  fun observeAllRows(): Flow<List<TaskRow>> = taskDao.observeAll().map { list ->\n    list.map { t ->\n      val title = when (t.relatedType) {\n        RelatedType.COMPANY -> companyDao.getById(t.relatedId)?.name\n        RelatedType.TENDER -> tenderDao.observeById(t.relatedId) // Flow; not ideal for sync\n          .let { null }\n        RelatedType.CONTRACT -> contractDao.observeById(t.relatedId)\n          .let { null }\n      }\n      TaskRow(t, title ?: "—")\n    }\n  }\n\n  fun observeAll(): Flow<List<TaskEntity>> = taskDao.observeAll()\n\n  fun observeById(id: String) = taskDao.observeById(id)\n\n  suspend fun upsert(entity: TaskEntity) = taskDao.upsert(entity)\n\n  suspend fun setStatus(id: String, status: ${s.packageName}.data.model.TaskStatus) = taskDao.setStatus(id, status)\n\n  suspend fun deleteById(id: String) = taskDao.deleteById(id)\n}\n`,

      followUpRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.FollowUpDao\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class FollowUpRow(\n  val followUp: FollowUpEntity,\n  val companyName: String\n)\n\nclass FollowUpRepository(\n  private val followUpDao: FollowUpDao,\n  private val companyDao: CompanyDao\n) {\n  fun observeAllRows(): Flow<List<FollowUpRow>> = followUpDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "—"\n    }\n    list.map { FollowUpRow(it, companies[it.companyId] ?: "—") }\n  }\n\n  fun observeAll(): Flow<List<FollowUpEntity>> = followUpDao.observeAll()\n\n  suspend fun upsert(entity: FollowUpEntity) = followUpDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = followUpDao.deleteById(id)\n}\n`,

      themeKt: (s) => `package ${s.packageName}.ui.theme\n\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.lightColorScheme\nimport androidx.compose.runtime.Composable\n\nprivate val LightColors = lightColorScheme(\n  primary = androidx.compose.ui.graphics.Color(0xFF0F172A),\n  secondary = androidx.compose.ui.graphics.Color(0xFF334155),\n  background = androidx.compose.ui.graphics.Color(0xFFF8FAFC),\n  surface = androidx.compose.ui.graphics.Color(0xFFFFFFFF)\n)\n\n@Composable\nfun TenderCRMTheme(content: @Composable () -> Unit) {\n  MaterialTheme(\n    colorScheme = LightColors,\n    typography = androidx.compose.material3.Typography(),\n    content = content\n  )\n}\n`,

      uiComponents: (s) => `package ${s.packageName}.ui.components\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.OutlinedButton\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.ui.Modifier\n\n@Composable\nfun TopActions(\n  primaryText: String,\n  onPrimary: () -> Unit,\n  secondaryText: String? = null,\n  onSecondary: (() -> Unit)? = null\n) {\n  Row(\n    modifier = Modifier.fillMaxWidth(),\n    horizontalArrangement = Arrangement.spacedBy(8.dp)\n  ) {\n    Button(onClick = onPrimary) { Text(primaryText) }\n    if (secondaryText != null && onSecondary != null) {\n      OutlinedButton(onClick = onSecondary) { Text(secondaryText) }\n    }\n  }\n}\n`,

      routes: (s) => `package ${s.packageName}.ui.navigation\n\nobject Routes {\n  const val Dashboard = "dashboard"\n  const val Companies = "companies"\n  const val CompanyDetails = "company/{id}"\n  const val Tenders = "tenders"\n  const val TenderDetails = "tender/{id}"\n  const val Contracts = "contracts"\n  const val ContractDetails = "contract/{id}"\n  const val Tasks = "tasks"\n  const val FollowUps = "followups"\n  const val BackupRestore = "backup"\n}\n`,

      navHost: (s) => `package ${s.packageName}.ui.navigation\n\nimport androidx.compose.runtime.Composable\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.navigation.NavType\nimport androidx.navigation.compose.NavHost\nimport androidx.navigation.compose.composable\nimport androidx.navigation.compose.rememberNavController\nimport androidx.navigation.navArgument\nimport ${s.packageName}.App\nimport ${s.packageName}.ui.screens.*\n\n@Composable\nfun AppNavHost() {\n  val navController = rememberNavController()\n  val app = LocalContext.current.applicationContext as App\n\n  NavHost(navController = navController, startDestination = Routes.Dashboard) {\n    composable(Routes.Dashboard) {\n      DashboardScreen(\n        nav = navController,\n        container = app.container\n      )\n    }\n    composable(Routes.Companies) { CompaniesScreen(navController, app.container) }\n    composable(Routes.CompanyDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      CompanyDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Tenders) { TendersScreen(navController, app.container) }\n    composable(Routes.TenderDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      TenderDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Contracts) { ContractsScreen(navController, app.container) }\n    composable(Routes.ContractDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      ContractDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Tasks) { TasksScreen(navController, app.container) }\n    composable(Routes.FollowUps) { FollowUpsScreen(navController, app.container) }\n    composable(Routes.BackupRestore) { BackupRestoreScreen(navController, app.container) }\n  }\n}\n`,

      dashboardScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.ui.navigation.Routes\nimport ${s.packageName}.vm.DashboardViewModel\n\n@Composable\nfun DashboardScreen(nav: NavController, container: AppContainer) {\n  val vm = DashboardViewModel(container)\n  val ui by vm.ui.collectAsState()\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text("لوحة التحكم", style = MaterialTheme.typography.titleLarge)\n      Text("ملخص سريع للمهام والمواعيد القادمة", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      QuickNavCard {\n        nav.navigate(Routes.Companies)\n      }\n    }\n\n    item {\n      SectionCard(title = "مهام اليوم", subtitle = "${'$'}{ui.tasksDueToday.size} مهمة") {\n        ui.tasksDueToday.take(5).forEach { Text("• ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "مهام متأخرة", subtitle = "${'$'}{ui.overdueTasks.size} مهمة") {\n        ui.overdueTasks.take(5).forEach { Text("• ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "مواعيد تقديم مناقصات قريبة", subtitle = "${'$'}{ui.upcomingTenderDeadlines.size} موعد") {\n        ui.upcomingTenderDeadlines.take(5).forEach { Text("• ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "عقود قريبة الانتهاء/التجديد", subtitle = "${'$'}{ui.upcomingContractDates.size} عقد") {\n        ui.upcomingContractDates.take(5).forEach { Text("• ${'$'}{it.title}") }\n      }\n    }\n  }\n}\n\n@Composable\nprivate fun QuickNavCard(onCompanies: () -> Unit) {\n  Card {\n    Column(modifier = Modifier.padding(16.dp)) {\n      Text("تنقل سريع", style = MaterialTheme.typography.titleMedium)\n      Text("افتح الشاشات الرئيسية من الأسفل", style = MaterialTheme.typography.bodySmall)\n    }\n  }\n}\n\n@Composable\nprivate fun SectionCard(title: String, subtitle: String, content: @Composable () -> Unit) {\n  Card {\n    Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n      Text(title, style = MaterialTheme.typography.titleMedium)\n      Text(subtitle, style = MaterialTheme.typography.bodySmall)\n      content()\n    }\n  }\n}\n`,

      companiesScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedButton\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.ui.navigation.Routes\nimport ${s.packageName}.vm.CompaniesViewModel\n\n@Composable\nfun CompaniesScreen(nav: NavController, container: AppContainer) {\n  val vm = CompaniesViewModel(container)\n  val companies by vm.companies.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween) {\n        Column {\n          Text("الشركات", style = MaterialTheme.typography.titleLarge)\n          Text("بحث/تصفية ستُضاف لاحقاً", style = MaterialTheme.typography.bodySmall)\n        }\n        Button(onClick = { vm.addSampleCompany() }) { Text("+ إضافة") }\n      }\n    }\n\n    items(companies, key = { it.id }) { c ->\n      Card(\n        modifier = Modifier.fillMaxWidth().clickable {\n          nav.navigate("company/${'$'}{c.id}")\n        }\n      ) {\n        Column(modifier = Modifier.padding(16.dp)) {\n          Text(c.name, style = MaterialTheme.typography.titleMedium)\n          Text(c.sector ?: "—", style = MaterialTheme.typography.bodySmall)\n          Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {\n            OutlinedButton(onClick = { vm.delete(c.id) }) { Text("حذف") }\n          }\n        }\n      }\n    }\n  }\n}\n`,

      companyDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.CompanyDetailsViewModel\n\n@Composable\nfun CompanyDetailsScreen(nav: NavController, container: AppContainer, companyId: String) {\n  val vm = CompanyDetailsViewModel(container, companyId)\n  val company by vm.company.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(company?.name ?: "شركة", style = MaterialTheme.typography.titleLarge)\n      Text("تفاصيل الشركة", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("القطاع: ${'$'}{company?.sector ?: "—"}")\n          Text("الهاتف: ${'$'}{company?.phone1 ?: "—"}")\n          Text("العنوان: ${'$'}{company?.address ?: "—"}")\n          Text("ملاحظات: ${'$'}{company?.notes ?: "—"}")\n        }\n      }\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n          Text("ملاحظة", style = MaterialTheme.typography.titleMedium)\n          Text("في النسخة الأولى: شاشة تفاصيل مبسطة.\nأضف Tabs للمناقصات/العقود/المتابعات/جهات الاتصال لاحقاً.")\n        }\n      }\n    }\n  }\n}\n`,

      tendersScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.TendersViewModel\n\n@Composable\nfun TendersScreen(nav: NavController, container: AppContainer) {\n  val vm = TendersViewModel(container)\n  val tenders by vm.tenders.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("المناقصات", style = MaterialTheme.typography.titleLarge)\n        Text("بحث/فلاتر ستُضاف لاحقاً", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleTender() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ إضافة") }\n      }\n    }\n\n    items(tenders, key = { it.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(row.tender.title, style = MaterialTheme.typography.titleMedium)\n          Text("الشركة: ${'$'}{row.companyName}", style = MaterialTheme.typography.bodySmall)\n          Text("الحالة: ${'$'}{row.tender.status}")\n          Text("آخر موعد: ${'$'}{row.tender.submissionDeadline}")\n        }\n      }\n    }\n  }\n}\n`,

      tenderDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.TenderDetailsViewModel\n\n@Composable\nfun TenderDetailsScreen(nav: NavController, container: AppContainer, tenderId: String) {\n  val vm = TenderDetailsViewModel(container, tenderId)\n  val tender by vm.tender.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(tender?.title ?: "مناقصة", style = MaterialTheme.typography.titleLarge)\n      Text("تفاصيل المناقصة", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("الحالة: ${'$'}{tender?.status ?: "—"}")\n          Text("النوع: ${'$'}{tender?.type ?: "—"}")\n          Text("آخر موعد: ${'$'}{tender?.submissionDeadline ?: "—"}")\n          Text("ملاحظات: ${'$'}{tender?.notes ?: "—"}")\n        }\n      }\n    }\n  }\n}\n`,

      contractsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.ContractsViewModel\n\n@Composable\nfun ContractsScreen(nav: NavController, container: AppContainer) {\n  val vm = ContractsViewModel(container)\n  val contracts by vm.contracts.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("العقود", style = MaterialTheme.typography.titleLarge)\n        Text("بحث/فلاتر ستُضاف لاحقاً", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleContract() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ إضافة") }\n      }\n    }\n\n    items(contracts, key = { it.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(row.contract.title, style = MaterialTheme.typography.titleMedium)\n          Text("الشركة: ${'$'}{row.companyName}", style = MaterialTheme.typography.bodySmall)\n          Text("الحالة: ${'$'}{row.contract.status}")\n          Text("النهاية: ${'$'}{row.contract.endDate}")\n        }\n      }\n    }\n  }\n}\n`,

      contractDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.ContractDetailsViewModel\n\n@Composable\nfun ContractDetailsScreen(nav: NavController, container: AppContainer, contractId: String) {\n  val vm = ContractDetailsViewModel(container, contractId)\n  val contract by vm.contract.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(contract?.title ?: "عقد", style = MaterialTheme.typography.titleLarge)\n      Text("تفاصيل العقد", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("الحالة: ${'$'}{contract?.status ?: "—"}")\n          Text("البداية: ${'$'}{contract?.startDate ?: "—"}")\n          Text("النهاية: ${'$'}{contract?.endDate ?: "—"}")\n          Text("القيمة: ${'$'}{contract?.value ?: "—"}")\n          Text("شروط الدفع: ${'$'}{contract?.paymentTerms ?: "—"}")\n        }\n      }\n    }\n  }\n}\n`,

      tasksScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.model.TaskStatus\nimport ${s.packageName}.vm.TasksViewModel\n\n@Composable\nfun TasksScreen(nav: NavController, container: AppContainer) {\n  val vm = TasksViewModel(container)\n  val tasks by vm.tasks.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("المهام", style = MaterialTheme.typography.titleLarge)\n        Text("تحديد منتهية/متأخرة سيتم تحسينه", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleTask() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ إضافة") }\n      }\n    }\n\n    items(tasks, key = { it.id }) { t ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(t.title, style = MaterialTheme.typography.titleMedium)\n          Text("استحقاق: ${'$'}{t.dueDate}")\n          Text("الحالة: ${'$'}{t.status}")\n          Button(onClick = { vm.markDone(t.id) }, enabled = t.status != TaskStatus.DONE) {\n            Text("تمت")\n          }\n        }\n      }\n    }\n  }\n}\n`,

      followupsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.FollowUpsViewModel\n\n@Composable\nfun FollowUpsScreen(nav: NavController, container: AppContainer) {\n  val vm = FollowUpsViewModel(container)\n  val followups by vm.followups.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("المتابعات", style = MaterialTheme.typography.titleLarge)\n        Text("إضافة نموذجية الآن، ثم تطوير فورم الإدخال لاحقاً", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleFollowUp() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ إضافة") }\n      }\n    }\n\n    items(followups, key = { it.followUp.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text("${'$'}{row.followUp.type}", style = MaterialTheme.typography.titleMedium)\n          Text("الشركة: ${'$'}{row.companyName}")\n          Text("الملخص: ${'$'}{row.followUp.summary}")\n          Text("التاريخ: ${'$'}{row.followUp.dateTime}")\n        }\n      }\n    }\n  }\n}\n`,

      backupRestoreScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport android.net.Uri\nimport androidx.activity.compose.rememberLauncherForActivityResult\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.remember\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.backup.BackupService\nimport ${s.packageName}.di.AppContainer\n\n@Composable\nfun BackupRestoreScreen(nav: NavController, container: AppContainer) {\n  val context = LocalContext.current\n  val backupService = remember { BackupService(context, container) }\n\n  val createJson = rememberLauncherForActivityResult(ActivityResultContracts.CreateDocument("application/json")) { uri: Uri? ->\n    if (uri != null) backupService.exportTo(uri)\n  }\n\n  val openJson = rememberLauncherForActivityResult(ActivityResultContracts.OpenDocument()) { uri: Uri? ->\n    if (uri != null) backupService.importFrom(uri)\n  }\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text("نسخ احتياطي/استعادة", style = MaterialTheme.typography.titleLarge)\n      Text("تصدير/استيراد JSON (نسخة أولى)", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n          Button(onClick = { createJson.launch("tender_crm_backup.json") }) { Text("تصدير JSON") }\n          Button(onClick = { openJson.launch(arrayOf("application/json")) }) { Text("استيراد JSON") }\n          Text("ملاحظة: الاستيراد سيقوم بعمل Upsert للعناصر.")\n        }\n      }\n    }\n  }\n}\n`,

      dashboardVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.MutableStateFlow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\n\ndata class DashboardUiState(\n  val tasksDueToday: List<TaskEntity> = emptyList(),\n  val overdueTasks: List<TaskEntity> = emptyList(),\n  val upcomingTenderDeadlines: List<TenderEntity> = emptyList(),\n  val upcomingContractDates: List<ContractEntity> = emptyList()\n)\n\nclass DashboardViewModel(private val container: AppContainer) : ViewModel() {\n\n  private val _ui = MutableStateFlow(DashboardUiState())\n  val ui: StateFlow<DashboardUiState> = _ui\n\n  init {\n    // Simple snapshot approach for v1\n    refresh()\n  }\n\n  private fun refresh() = viewModelScope.launch {\n    val today = LocalDate.now()\n    // For v1 we rely on flows in screens; here keep minimal
    container.taskRepository.observeAll().collect { tasks ->\n      val dueToday = tasks.filter { it.dueDate == today && it.status != TaskStatus.DONE }\n      val overdue = tasks.filter { it.dueDate.isBefore(today) && it.status != TaskStatus.DONE }\n      _ui.value = _ui.value.copy(tasksDueToday = dueToday, overdueTasks = overdue)\n    }\n  }\n}\n`,

      companiesVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass CompaniesViewModel(private val container: AppContainer) : ViewModel() {\n\n  val companies: StateFlow<List<CompanyEntity>> = container.companyRepository.observeAll()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleCompany() = viewModelScope.launch {\n    val now = LocalDateTime.now()\n    container.companyRepository.upsert(\n      CompanyEntity(\n        id = UUID.randomUUID().toString(),\n        name = "شركة تجريبية",\n        sector = "خاص",\n        address = "—",\n        phone1 = "0500000000",\n        phone2 = null,\n        email = null,\n        website = null,\n        notes = "تم إنشاؤها للتجربة",\n        createdAt = now,\n        updatedAt = now\n      )\n    )\n  }\n\n  fun delete(id: String) = viewModelScope.launch {\n    container.companyRepository.deleteById(id)\n  }\n}\n`,

      companyDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass CompanyDetailsViewModel(container: AppContainer, companyId: String) : ViewModel() {\n  val company: StateFlow<CompanyEntity?> = container.companyRepository.observeById(companyId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      tendersVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TenderStatus\nimport ${s.packageName}.data.model.TenderType\nimport ${s.packageName}.repo.TenderRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass TendersViewModel(private val container: AppContainer) : ViewModel() {\n\n  val tenders: StateFlow<List<TenderRow>> = container.tenderRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleTender() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val tender = TenderEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      title = "مناقصة تجريبية",\n      refNumber = null,\n      type = TenderType.TENDER,\n      status = TenderStatus.PREPARATION,\n      docsPurchaseDeadline = null,\n      submissionDeadline = LocalDate.now().plusDays(7),\n      technicalOpeningDate = null,\n      financialOpeningDate = null,\n      awardDate = null,\n      expectedValue = null,\n      finalValue = null,\n      primaryGuarantee = null,\n      finalGuarantee = null,\n      margin = null,\n      notes = "—",\n      createdAt = now,\n      updatedAt = now\n    )\n    container.tenderRepository.upsert(tender)\n  }\n}\n`,

      tenderDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass TenderDetailsViewModel(container: AppContainer, tenderId: String) : ViewModel() {\n  val tender: StateFlow<TenderEntity?> = container.tenderRepository.observeById(tenderId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      contractsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.model.ContractStatus\nimport ${s.packageName}.repo.ContractRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass ContractsViewModel(private val container: AppContainer) : ViewModel() {\n\n  val contracts: StateFlow<List<ContractRow>> = container.contractRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleContract() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val contract = ContractEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      title = "عقد تجريبي",\n      contractNumber = null,\n      startDate = LocalDate.now(),\n      endDate = LocalDate.now().plusMonths(6),\n      value = 10000.0,\n      paymentTerms = "شهري",\n      renewalDate = null,\n      status = ContractStatus.ACTIVE,\n      notes = "—",\n      createdAt = now,\n      updatedAt = now\n    )\n    container.contractRepository.upsert(contract)\n  }\n}\n`,

      contractDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass ContractDetailsViewModel(container: AppContainer, contractId: String) : ViewModel() {\n  val contract: StateFlow<ContractEntity?> = container.contractRepository.observeById(contractId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      tasksVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.RelatedType\nimport ${s.packageName}.data.model.TaskPriority\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass TasksViewModel(private val container: AppContainer) : ViewModel() {\n\n  val tasks: StateFlow<List<TaskEntity>> = container.taskRepository.observeAll()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleTask() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val task = TaskEntity(\n      id = UUID.randomUUID().toString(),\n      relatedType = RelatedType.COMPANY,\n      relatedId = companies.first().id,\n      title = "مهمة تجريبية",\n      description = "—",\n      dueDate = LocalDate.now().plusDays(1),\n      priority = TaskPriority.MEDIUM,\n      status = TaskStatus.NEW,\n      reminderOffset = 1,\n      createdAt = now,\n      updatedAt = now\n    )\n    container.taskRepository.upsert(task)\n\n    // schedule notification\n    container.notificationScheduler.scheduleTask(task)\n  }\n\n  fun markDone(id: String) = viewModelScope.launch {\n    container.taskRepository.setStatus(id, TaskStatus.DONE)\n    container.notificationScheduler.cancel("task_${'$'}id")\n  }\n}\n`,

      followupsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.model.FollowUpType\nimport ${s.packageName}.repo.FollowUpRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass FollowUpsViewModel(private val container: AppContainer) : ViewModel() {\n\n  val followups: StateFlow<List<FollowUpRow>> = container.followUpRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleFollowUp() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n\n    val fu = FollowUpEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      tenderId = null,\n      contractId = null,\n      type = FollowUpType.CALL,\n      dateTime = LocalDateTime.now(),\n      contactName = "—",\n      summary = "اتصال للتنسيق",\n      nextStep = null,\n      nextStepDate = null\n    )\n    container.followUpRepository.upsert(fu)\n  }\n}\n`,

      notificationWorker: (s) => `package ${s.packageName}.notify\n\nimport android.app.NotificationChannel\nimport android.app.NotificationManager\nimport android.content.Context\nimport androidx.core.app.NotificationCompat\nimport androidx.core.app.NotificationManagerCompat\nimport androidx.work.CoroutineWorker\nimport androidx.work.WorkerParameters\nimport ${s.packageName}.R\n\nclass NotificationWorker(\n  appContext: Context,\n  params: WorkerParameters\n) : CoroutineWorker(appContext, params) {\n\n  override suspend fun doWork(): Result {\n    val title = inputData.getString(KEY_TITLE) ?: "تذكير"\n    val message = inputData.getString(KEY_MESSAGE) ?: ""\n\n    ensureChannel()\n\n    val notif = NotificationCompat.Builder(applicationContext, CHANNEL_ID)\n      .setSmallIcon(android.R.drawable.ic_dialog_info)\n      .setContentTitle(title)\n      .setContentText(message)\n      .setPriority(NotificationCompat.PRIORITY_HIGH)\n      .setAutoCancel(true)\n      .build()\n\n    NotificationManagerCompat.from(applicationContext).notify((System.currentTimeMillis() % Int.MAX_VALUE).toInt(), notif)\n    return Result.success()\n  }\n\n  private fun ensureChannel() {\n    val nm = applicationContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\n    val channel = NotificationChannel(CHANNEL_ID, "تذكيرات", NotificationManager.IMPORTANCE_HIGH)\n    nm.createNotificationChannel(channel)\n  }\n\n  companion object {\n    const val CHANNEL_ID = "reminders"\n    const val KEY_TITLE = "title"\n    const val KEY_MESSAGE = "message"\n  }\n}\n`,

      notificationScheduler: (s) => `package ${s.packageName}.notify\n\nimport android.content.Context\nimport androidx.work.ExistingWorkPolicy\nimport androidx.work.OneTimeWorkRequestBuilder\nimport androidx.work.WorkManager\nimport androidx.work.workDataOf\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.time.ZoneId\nimport java.util.concurrent.TimeUnit\n\nclass NotificationScheduler(private val context: Context) {\n\n  private val wm: WorkManager by lazy { WorkManager.getInstance(context) }\n\n  fun scheduleTask(task: TaskEntity) {\n    val reminderDays = task.reminderOffset\n    val triggerDate = task.dueDate.minusDays(reminderDays.toLong())\n    val title = "تذكير مهمة"\n    val message = task.title\n    scheduleAt(workName = "task_${'$'}{task.id}", localDate = triggerDate, title = title, message = message)\n  }\n\n  fun scheduleTenderDeadline(tender: TenderEntity, daysBefore: Long = 2) {\n    val triggerDate = tender.submissionDeadline.minusDays(daysBefore)\n    scheduleAt(\n      workName = "tender_${'$'}{tender.id}",\n      localDate = triggerDate,\n      title = "موعد تقديم مناقصة",\n      message = "${'$'}{tender.title}"\n    )\n  }\n\n  fun scheduleContractRenewal(contract: ContractEntity, daysBefore: Long = 14) {\n    val next = contract.renewalDate ?: contract.endDate\n    val triggerDate = next.minusDays(daysBefore)\n    scheduleAt(\n      workName = "contract_${'$'}{contract.id}",\n      localDate = triggerDate,\n      title = "تجديد/انتهاء عقد",\n      message = "${'$'}{contract.title}"\n    )\n  }\n\n  fun cancel(workName: String) {\n    wm.cancelUniqueWork(workName)\n  }\n\n  private fun scheduleAt(workName: String, localDate: LocalDate, title: String, message: String) {\n    val now = System.currentTimeMillis()\n    val triggerMillis = localDate.atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()\n    val delay = (triggerMillis - now).coerceAtLeast(0L)\n\n    val req = OneTimeWorkRequestBuilder<NotificationWorker>()\n      .setInitialDelay(delay, TimeUnit.MILLISECONDS)\n      .setInputData(workDataOf(\n        NotificationWorker.KEY_TITLE to title,\n        NotificationWorker.KEY_MESSAGE to message\n      ))\n      .build()\n\n    wm.enqueueUniqueWork(workName, ExistingWorkPolicy.REPLACE, req)\n  }\n}\n`,

      backupModels: (s) => `package ${s.packageName}.backup\n\nimport kotlinx.serialization.Serializable\nimport ${s.packageName}.data.local.entity.*\n\n@Serializable\ndata class BackupPayload(\n  val companies: List<CompanyEntitySer>,\n  val contacts: List<ContactEntitySer>,\n  val tenders: List<TenderEntitySer>,\n  val contracts: List<ContractEntitySer>,\n  val tasks: List<TaskEntitySer>,\n  val followups: List<FollowUpEntitySer>\n)\n\n// Serialization-friendly DTOs (Room entities contain java.time)\n@Serializable data class CompanyEntitySer(\n  val id: String,\n  val name: String,\n  val sector: String? = null,\n  val address: String? = null,\n  val phone1: String? = null,\n  val phone2: String? = null,\n  val email: String? = null,\n  val website: String? = null,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class ContactEntitySer(\n  val id: String,\n  val companyId: String,\n  val name: String,\n  val role: String? = null,\n  val mobile: String? = null,\n  val email: String? = null,\n  val notes: String? = null\n)\n\n@Serializable data class TenderEntitySer(\n  val id: String,\n  val companyId: String,\n  val title: String,\n  val refNumber: String? = null,\n  val type: String,\n  val status: String,\n  val docsPurchaseDeadlineEpochDay: Long? = null,\n  val submissionDeadlineEpochDay: Long,\n  val technicalOpeningDateEpochDay: Long? = null,\n  val financialOpeningDateEpochDay: Long? = null,\n  val awardDateEpochDay: Long? = null,\n  val expectedValue: Double? = null,\n  val finalValue: Double? = null,\n  val primaryGuarantee: Double? = null,\n  val finalGuarantee: Double? = null,\n  val margin: Double? = null,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class ContractEntitySer(\n  val id: String,\n  val companyId: String,\n  val title: String,\n  val contractNumber: String? = null,\n  val startDateEpochDay: Long,\n  val endDateEpochDay: Long,\n  val value: Double,\n  val paymentTerms: String? = null,\n  val renewalDateEpochDay: Long? = null,\n  val status: String,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class TaskEntitySer(\n  val id: String,\n  val relatedType: String,\n  val relatedId: String,\n  val title: String,\n  val description: String? = null,\n  val dueDateEpochDay: Long,\n  val priority: String,\n  val status: String,\n  val reminderOffset: Int,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class FollowUpEntitySer(\n  val id: String,\n  val companyId: String,\n  val tenderId: String? = null,\n  val contractId: String? = null,\n  val type: String,\n  val dateTimeEpoch: Long,\n  val contactName: String? = null,\n  val summary: String,\n  val nextStep: String? = null,\n  val nextStepDateEpochDay: Long? = null\n)\n`,

      backupService: (s) => `package ${s.packageName}.backup\n\nimport android.content.Context\nimport android.net.Uri\nimport android.widget.Toast\nimport androidx.core.net.toFile\nimport ${s.packageName}.di.AppContainer\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.launch\nimport kotlinx.serialization.encodeToString\nimport kotlinx.serialization.json.Json\n\nclass BackupService(\n  private val context: Context,\n  private val container: AppContainer\n) {\n\n  private val scope = CoroutineScope(Dispatchers.IO)\n  private val json = Json { prettyPrint = true; ignoreUnknownKeys = true }\n\n  fun exportTo(uri: Uri) {\n    scope.launch {\n      try {\n        // NOTE: For v1 we export only companies (extend to all tables)
        val companies = container.companyRepository.observeAll()\n          .stateIn(CoroutineScope(Dispatchers.IO), kotlinx.coroutines.flow.SharingStarted.Eagerly, emptyList()).value\n          .map { it.toSer() }\n\n        val payload = BackupPayload(\n          companies = companies,\n          contacts = emptyList(),\n          tenders = emptyList(),\n          contracts = emptyList(),\n          tasks = emptyList(),\n          followups = emptyList()\n        )\n        context.contentResolver.openOutputStream(uri)?.use { out ->\n          out.write(json.encodeToString(payload).toByteArray())\n        }\n        toast("تم تصدير النسخة الاحتياطية")\n      } catch (t: Throwable) {\n        toast("فشل التصدير: ${'$'}{t.message}")\n      }\n    }\n  }\n\n  fun importFrom(uri: Uri) {\n    scope.launch {\n      try {\n        val text = context.contentResolver.openInputStream(uri)?.use { it.readBytes().decodeToString() } ?: return@launch\n        val payload = json.decodeFromString(BackupPayload.serializer(), text)\n        // NOTE: for v1 import companies only
        payload.companies.forEach { ser ->\n          container.companyRepository.upsert(ser.toEntity())\n        }\n        toast("تم الاستيراد")\n      } catch (t: Throwable) {\n        toast("فشل الاستيراد: ${'$'}{t.message}")\n      }\n    }\n  }\n\n  private fun toast(msg: String) {\n    CoroutineScope(Dispatchers.Main).launch {\n      Toast.makeText(context, msg, Toast.LENGTH_LONG).show()\n    }\n  }\n}\n\n// Mapping helpers\nprivate fun CompanyEntitySer.toEntity(): ${s.packageName}.data.local.entity.CompanyEntity {\n  val created = java.time.LocalDateTime.ofInstant(java.time.Instant.ofEpochMilli(createdAtEpoch), java.time.ZoneId.systemDefault())\n  val updated = java.time.LocalDateTime.ofInstant(java.time.Instant.ofEpochMilli(updatedAtEpoch), java.time.ZoneId.systemDefault())\n  return ${s.packageName}.data.local.entity.CompanyEntity(\n    id = id,\n    name = name,\n    sector = sector,\n    address = address,\n    phone1 = phone1,\n    phone2 = phone2,\n    email = email,\n    website = website,\n    notes = notes,\n    createdAt = created,\n    updatedAt = updated\n  )\n}\n\nprivate fun ${s.packageName}.data.local.entity.CompanyEntity.toSer(): CompanyEntitySer {\n  val created = this.createdAt.atZone(java.time.ZoneId.systemDefault()).toInstant().toEpochMilli()\n  val updated = this.updatedAt.atZone(java.time.ZoneId.systemDefault()).toInstant().toEpochMilli()\n  return CompanyEntitySer(\n    id = id,\n    name = name,\n    sector = sector,\n    address = address,\n    phone1 = phone1,\n    phone2 = phone2,\n    email = email,\n    website = website,\n    notes = notes,\n    createdAtEpoch = created,\n    updatedAtEpoch = updated\n  )\n}\n`,

      unitTest: (s) => `package ${s.packageName}\n\nimport org.junit.Test\n\nclass ExampleUnitTest {\n  @Test fun addition_isCorrect() {\n    assert(2 + 2 == 4)\n  }\n}\n`,

      instrumentedTest: (s) => `package ${s.packageName}\n\nimport androidx.test.ext.junit.runners.AndroidJUnit4\nimport org.junit.Test\nimport org.junit.runner.RunWith\n\n@RunWith(AndroidJUnit4::class)\nclass ExampleInstrumentedTest {\n  @Test fun useAppContext() {\n    // Placeholder\n  }\n}\n`
    };

    function escapeXml(s) {
      return (s ?? '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // =============================
    // Store operations
    // =============================
    function upsert(collection, obj) {
      state[collection] = state[collection] || [];
      const idx = state[collection].findIndex(x => x.id === obj.id);
      if (idx >= 0) state[collection][idx] = obj;
      else state[collection].push(obj);

      // Immediately save to server
      if (authState?.accessToken) {
        const serverData = convertToServerFormat(collection, obj);
        apiFetch(`/api/data/${collection}`, {
          method: 'POST',
          body: JSON.stringify(serverData)
        }).then(res => {
          if (res.ok) console.log(`Saved ${collection} to server:`, obj.id);
          else console.error(`Failed to save ${collection}:`, res.status);
        }).catch(err => console.error(`Error saving ${collection}:`, err));
      }
    }

    // =============================
    // Boot
    // =============================
    async function initApp() {
      // Clear data cache on every load to ensure fresh data from server
      const authData = localStorage.getItem(AUTH_KEY); // Keep auth

      // Reset state to default (clear cached data)
      state = defaultState();

      // Restore auth
      if (authData) {
        try {
          authState = JSON.parse(authData);
        } catch { }
      }

      // Mount shell first
      mountShell();

      // If logged in, load fresh data from server
      if (authState?.accessToken) {
        console.log('Loading fresh data from server...');
        await loadDataFromServerFormatted();
        console.log('Data loaded, rendering...');
        renderRoute();
      }
    }

    initApp();
  </script>
</body>

</html>