<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%236366f1' rx='20' width='100' height='100'/%3E%3Ctext x='50' y='65' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3EÙ…%3C/text%3E%3C/svg%3E" />
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      color-scheme: light;
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-gradient-soft: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.3);
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg-gradient-soft);
    }

    /* Premium Shadows */
    .shadow-soft {
      box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .shadow-glow {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    .shadow-card {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.02);
    }

    /* Glassmorphism */
    .glass {
      background: var(--glass-bg);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .glass-dark {
      background: rgba(15, 23, 42, 0.85);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
    }

    /* Gradient Text */
    .gradient-text {
      background: var(--bg-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient Buttons */
    .btn-gradient {
      background: var(--bg-gradient);
      color: white;
      border: none;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-gradient:hover::before {
      left: 100%;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse-soft {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .animate-fadeInUp {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    .animate-slideInRight {
      animation: slideInRight 0.4s ease-out forwards;
    }

    .animate-pulse-soft {
      animation: pulse-soft 2s ease-in-out infinite;
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    /* Hover Effects */
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
    }

    /* Card Styles */
    .card-modern {
      background: white;
      border-radius: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .card-modern:hover {
      border-color: rgba(99, 102, 241, 0.2);
    }

    /* Input Styles */
    .input-modern {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      outline: none;
    }

    /* Badge Styles */
    .badge-gradient {
      background: var(--bg-gradient);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Table Styles */
    .table-modern {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-modern th {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
    }

    .table-modern tr:hover td {
      background: #f8fafc;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4f46e5;
    }

    /* Other utilities */
    .grid-autofit {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    input[type="date"],
    input[type="datetime-local"],
    select {
      color-scheme: light;
    }

    textarea {
      resize: vertical;
    }

    /* Loading Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="app" class="min-h-screen"></div>

  <template id="tpl-shell">
    <div class="min-h-screen flex flex-row-reverse" data-shell>
      <aside id="sidebar"
        class="hidden md:flex w-80 max-w-[85vw] bg-white border-l border-slate-200 p-4 flex-col gap-4 nav-aside">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-lg font-bold">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯</h1>
            <p class="text-xs text-slate-500 mt-1">Ù†Ø³Ø®Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ù†Ù…ÙˆØ°Ø¬ + Ù…ÙˆÙ„Ù‘Ø¯ Ù…Ø´Ø±ÙˆØ¹ Android)</p>
          </div>
          <span
            class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Ù…Ø­Ù„ÙŠ</span>
        </div>

        <div class="relative">
          <input id="navSearch" type="search" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©..."
            class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300" />
        </div>

        <div id="navSidebar" class="flex flex-col gap-2 overflow-auto nav-scroll"></div>

        <div class="mt-auto text-xs text-slate-500 leading-6">
          <div class="flex items-center justify-between">
            <span>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†:</span>
            <span id="storageState" class="font-semibold">â€”</span>
          </div>
          <div class="flex items-center justify-between">
            <span>Ø¢Ø®Ø± Ø­ÙØ¸:</span>
            <span id="lastSaved" class="font-semibold">â€”</span>
          </div>
          <div class="mt-2 p-2 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">
            Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ ÙˆÙŠØ¨ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙÙƒØ±Ø©. Ø²Ø± <b>Ù…Ø´Ø±ÙˆØ¹ Android</b> ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆÙ„ÙŠØ¯ Ù‡ÙŠÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ Kotlin/Compose/Room Ù‚Ø§Ø¨Ù„
            Ù„Ù„ØªØ´ØºÙŠÙ„.
          </div>
        </div>
      </aside>

      <main class="flex-1 p-4 pb-24 md:p-8 md:pb-8 md:mr-80 nav-main overflow-x-hidden">
        <div class="w-full max-w-full min-w-0 md:max-w-6xl mx-auto">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 id="pageTitle" class="text-xl font-bold"></h2>
              <p id="pageSubtitle" class="text-sm text-slate-600 mt-1"></p>
            </div>
            <div id="pageActions" class="flex items-center gap-2"></div>
          </div>

          <div id="content" class="mt-6"></div>

          <footer class="mt-10 text-xs text-slate-500">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© RTL â€¢ ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ â€¢ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨Ø§Øª â€¢ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±</div>
              <div class="kbd">v1.0-prototype</div>
            </div>
          </footer>
        </div>
      </main>

      <div id="navMobile" class="md:hidden"></div>
    </div>
  </template>

  <template id="tpl-modal">
    <div class="fixed inset-0 z-[9999]" data-app-modal>
      <div class="absolute inset-0 bg-slate-900/40" data-close></div>
      <div class="absolute inset-0 flex items-end md:items-center justify-center p-0 md:p-6">
        <div
          class="w-full md:w-[560px] md:max-w-[92vw] bg-white shadow-soft border border-slate-200 rounded-t-2xl md:rounded-2xl flex flex-col"
          data-app-modal-card>
          <div class="p-4 border-b border-slate-200 flex items-start justify-between gap-3 min-w-0">
            <div class="min-w-0">
              <h3 class="text-base font-bold" data-title></h3>
              <p class="text-xs text-slate-500 mt-1" data-subtitle></p>
            </div>
            <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="p-4 overflow-auto" data-body></div>
          <div class="p-4 border-t border-slate-200 flex items-center justify-between gap-2 min-w-0"
            data-app-modal-footer>
            <div class="text-xs text-slate-500" data-hint></div>
            <div class="flex items-center gap-2">
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-cancel>Ø¥Ù„ØºØ§Ø¡</button>
              <button class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" data-ok>Ø­ÙØ¸</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-empty">
    <div class="border border-dashed border-slate-300 rounded-2xl p-8 bg-white text-center">
      <div class="text-lg font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
      <div class="text-sm text-slate-600 mt-2" data-msg></div>
      <div class="mt-5" data-actions></div>
    </div>
  </template>

  <script>
    // =============================
    // Utilities
    // =============================
    const $ = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

    const nowTs = () => Date.now();
    const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + "_" + Date.now()));

    const pad2 = (n) => String(n).padStart(2, '0');
    const toISODate = (ts) => {
      if (!ts) return '';
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    };
    const fromISODate = (s) => {
      if (!s) return null;
      const [y, m, d] = s.split('-').map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
    };
    const toISODatetimeLocal = (ts) => {
      if (!ts) return '';
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };
    const fromISODatetimeLocal = (s) => {
      if (!s) return null;
      const d = new Date(s);
      const t = d.getTime();
      return Number.isFinite(t) ? t : null;
    };

    const fmtDate = (ts) => ts ? new Intl.DateTimeFormat('ar', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(ts)) : 'â€”';
    const fmtDateTime = (ts) => ts ? new Intl.DateTimeFormat('ar', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).format(new Date(ts)) : 'â€”';

    const startOfDay = (ts) => {
      const d = new Date(ts);
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    };

    const daysFromNow = (n) => startOfDay(Date.now() + n * 24 * 60 * 60 * 1000);

    const escapeHtml = (s) => (s ?? '').toString().replace(/[&<>"']+/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c] || c));

    // =============================
    // Local store (LocalStorage JSON)
    // =============================
    const STORE_KEY = 'tcrm_offline_v1';
    const AUTH_KEY = 'tcrm_auth_v1';
    const defaultState = () => ({
      meta: { lastSavedAt: null },
      companies: [],
      contacts: [],
      tenders: [],
      contracts: [],
      tasks: [],
      followups: [],
      settings: {
        // Android generator settings
        android: {
          appName: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯',
          applicationId: 'com.example.tendercrm',
          packageName: 'com.example.tendercrm',
          minSdk: 26,
          targetSdk: 35,
          kotlinVersion: '2.0.21',
          agpVersion: '8.5.2',
          composeBom: '2024.10.00',
          roomVersion: '2.6.1',
          workVersion: '2.9.1',
          navVersion: '2.8.4',
          serializationVersion: '1.7.3'
        }
      }
    });

    function loadState() {
      try {
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return defaultState();
        const st = JSON.parse(raw);
        return { ...defaultState(), ...st, settings: { ...defaultState().settings, ...(st.settings || {}) } };
      } catch {
        return defaultState();
      }
    }

    function saveState(st) {
      st.meta = st.meta || {};
      st.meta.lastSavedAt = nowTs();
      localStorage.setItem(STORE_KEY, JSON.stringify(st));
      renderShellMeta();
    }

    let state = loadState();

    function loadAuth() {
      try {
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) return { accessToken: null, refreshToken: null, role: null, email: null };
        const a = JSON.parse(raw);
        return { accessToken: a.accessToken || null, refreshToken: a.refreshToken || null, role: a.role || null, email: a.email || null };
      } catch {
        return { accessToken: null, refreshToken: null, role: null, email: null };
      }
    }

    function saveAuth(auth) {
      localStorage.setItem(AUTH_KEY, JSON.stringify(auth));
    }

    function clearAuth() {
      try { localStorage.removeItem(AUTH_KEY); } catch { }
    }

    let authState = loadAuth();

    const API_BASE = window.__API_BASE__ || "http://localhost:4000";

    async function apiFetch(path, opts = {}) {
      const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
      const headers = new Headers(opts.headers || {});
      if (!headers.has('Content-Type') && opts.body) headers.set('Content-Type', 'application/json');
      if (authState?.accessToken) headers.set('Authorization', `Bearer ${authState.accessToken}`);

      const doReq = async () => {
        const res = await fetch(url, { ...opts, headers, credentials: 'include' });
        return res;
      };

      let res = await doReq();
      if (res.status !== 401) return res;

      if (!authState?.refreshToken) return res;
      const refreshed = await refreshAccessToken();
      if (!refreshed) return res;
      headers.set('Authorization', `Bearer ${authState.accessToken}`);
      return await doReq();
    }

    async function refreshAccessToken() {
      try {
        const res = await fetch(`${API_BASE}/api/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ refreshToken: authState.refreshToken })
        });
        if (!res.ok) return false;
        const data = await res.json();
        if (!data?.accessToken) return false;
        authState = { ...authState, accessToken: data.accessToken };
        saveAuth(authState);
        return true;
      } catch {
        return false;
      }
    }

    async function logoutServer() {
      try {
        if (!authState?.refreshToken) return;
        await fetch(`${API_BASE}/api/auth/logout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ refreshToken: authState.refreshToken })
        });
      } catch { }
    }

    function renderShellMeta() {
      const size = new Blob([localStorage.getItem(STORE_KEY) || '']).size;
      const storageState = $('#storageState');
      const lastSaved = $('#lastSaved');
      if (storageState) storageState.textContent = `${(size / 1024).toFixed(1)} KB`;
      if (lastSaved) lastSaved.textContent = state?.meta?.lastSavedAt ? fmtDateTime(state.meta.lastSavedAt) : 'â€”';
    }

    // =============================
    // Domain helpers
    // =============================
    const Enums = {
      TenderType: ['TENDER', 'PRACTICE', 'CONTRACT', 'DIRECT_SALE'],
      TenderStatus: ['PREPARATION', 'OFFER_IN_PROGRESS', 'SUBMITTED', 'AWARDED', 'LOST', 'IN_PROGRESS', 'COMPLETED'],
      ContractStatus: ['ACTIVE', 'EXPIRED', 'SUSPENDED'],
      TaskPriority: ['HIGH', 'MEDIUM', 'LOW'],
      TaskStatus: ['NEW', 'IN_PROGRESS', 'DONE', 'OVERDUE'],
      RelatedType: ['COMPANY', 'TENDER', 'CONTRACT'],
      FollowUpType: ['CALL', 'VISIT', 'EMAIL', 'WHATSAPP', 'OTHER']
    };

    const labels = {
      TenderType: { TENDER: 'Ù…Ù†Ø§Ù‚ØµØ©', PRACTICE: 'Ù…Ù…Ø§Ø±Ø³Ø©', CONTRACT: 'ØªØ¹Ø§Ù‚Ø¯', DIRECT_SALE: 'Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±' },
      TenderStatus: {
        PREPARATION: 'ØªØ­Ø¶ÙŠØ±',
        OFFER_IN_PROGRESS: 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø±Ø¶',
        SUBMITTED: 'ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…',
        AWARDED: 'ØªØ±Ø³ÙŠØ©',
        LOST: 'Ø®Ø³Ø§Ø±Ø©',
        IN_PROGRESS: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
        COMPLETED: 'Ù…ÙƒØªÙ…Ù„'
      },
      ContractStatus: { ACTIVE: 'Ø³Ø§Ø±ÙŠ', EXPIRED: 'Ù…Ù†ØªÙ‡ÙŠ', SUSPENDED: 'Ù…ÙˆÙ‚ÙˆÙ' },
      TaskPriority: { HIGH: 'Ø¹Ø§Ù„ÙŠØ©', MEDIUM: 'Ù…ØªÙˆØ³Ø·Ø©', LOW: 'Ù…Ù†Ø®ÙØ¶Ø©' },
      TaskStatus: { NEW: 'Ø¬Ø¯ÙŠØ¯Ø©', IN_PROGRESS: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', DONE: 'Ù…Ù†ØªÙ‡ÙŠØ©', OVERDUE: 'Ù…ØªØ£Ø®Ø±Ø©' },
      RelatedType: { COMPANY: 'Ø´Ø±ÙƒØ©', TENDER: 'Ù…Ù†Ø§Ù‚ØµØ©', CONTRACT: 'Ø¹Ù‚Ø¯' },
      FollowUpType: { CALL: 'Ø§ØªØµØ§Ù„', VISIT: 'Ø²ÙŠØ§Ø±Ø©', EMAIL: 'Ø¨Ø±ÙŠØ¯', WHATSAPP: 'ÙˆØ§ØªØ³Ø§Ø¨', OTHER: 'Ø£Ø®Ø±Ù‰' }
    };

    function getCompanyName(companyId) {
      return state.companies.find(c => c.id === companyId)?.name || 'â€”';
    }
    function getTenderTitle(tenderId) {
      return state.tenders.find(t => t.id === tenderId)?.title || 'â€”';
    }
    function getContractTitle(contractId) {
      return state.contracts.find(c => c.id === contractId)?.title || 'â€”';
    }

    function computeTaskStatus(task) {
      if (task.status === 'DONE') return 'DONE';
      const due = task.dueDate;
      if (!due) return task.status || 'NEW';
      if (startOfDay(due) < startOfDay(nowTs())) return 'OVERDUE';
      return task.status || 'NEW';
    }

    function normalizeTasksStatuses() {
      let changed = false;
      state.tasks = state.tasks.map(t => {
        const s = computeTaskStatus(t);
        if (t.status !== s) { changed = true; return { ...t, status: s, updatedAt: nowTs() }; }
        return t;
      });
      if (changed) saveState(state);
    }

    // =============================
    // UI components helpers
    // =============================
    function setPage(title, subtitle, actions = []) {
      $('#pageTitle').textContent = title;
      $('#pageSubtitle').textContent = subtitle || '';
      const wrap = $('#pageActions');
      wrap.innerHTML = '';
      actions.forEach(a => wrap.appendChild(a));
    }

    function mkBtn(label, variant = 'primary', onClick) {
      const btn = document.createElement('button');
      btn.type = 'button';
      const base = 'px-3 py-2 rounded-lg text-sm border transition';
      const styles = {
        primary: 'bg-slate-900 text-white border-slate-900 hover:bg-slate-800',
        secondary: 'bg-white text-slate-900 border-slate-200 hover:bg-slate-50',
        danger: 'bg-rose-600 text-white border-rose-600 hover:bg-rose-700',
        ghost: 'bg-transparent text-slate-700 border-transparent hover:bg-slate-100'
      };
      btn.className = `${base} ${styles[variant] || styles.primary}`;
      btn.textContent = label;
      btn.addEventListener('click', onClick);
      return btn;
    }

    function mkBadge(text, color = 'slate') {
      const span = document.createElement('span');
      const map = {
        slate: 'bg-slate-100 text-slate-700 border-slate-200',
        emerald: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        amber: 'bg-amber-50 text-amber-800 border-amber-200',
        rose: 'bg-rose-50 text-rose-700 border-rose-200',
        blue: 'bg-blue-50 text-blue-700 border-blue-200'
      };
      span.className = `text-xs px-2 py-1 rounded-full border ${map[color] || map.slate}`;
      span.textContent = text;
      return span;
    }

    function mkCard(title, subtitle, bodyEl) {
      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const h = document.createElement('div');
      h.className = 'flex items-start justify-between gap-3';
      const left = document.createElement('div');
      left.innerHTML = `<div class="text-sm font-bold">${escapeHtml(title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(subtitle || '')}</div>`;
      h.appendChild(left);
      card.appendChild(h);
      if (bodyEl) {
        const b = document.createElement('div');
        b.className = 'mt-4';
        b.appendChild(bodyEl);
        card.appendChild(b);
      }
      return card;
    }

    function mkTable(headers, rows) {
      const wrap = document.createElement('div');
      wrap.className = 'overflow-auto border border-slate-200 rounded-2xl bg-white';
      const table = document.createElement('table');
      table.className = 'min-w-[900px] w-full text-sm';
      const thead = document.createElement('thead');
      thead.className = 'bg-slate-50 border-b border-slate-200';
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.className = 'text-right px-4 py-3 font-semibold text-slate-700';
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      const tbody = document.createElement('tbody');
      rows.forEach(r => tbody.appendChild(r));
      table.appendChild(thead);
      table.appendChild(tbody);
      wrap.appendChild(table);
      return wrap;
    }

    function mkTr(cells) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-100 hover:bg-slate-50';
      cells.forEach(c => {
        const td = document.createElement('td');
        td.className = 'px-4 py-3 align-top';
        if (c instanceof Node) td.appendChild(c); else td.innerHTML = c;
        tr.appendChild(td);
      });
      return tr;
    }

    function mkField({ label, type = 'text', value = '', placeholder = '', options = null, rows = 3, help = '' }) {
      const wrap = document.createElement('div');
      wrap.className = 'flex flex-col gap-1';
      const l = document.createElement('label');
      l.className = 'text-xs font-semibold text-slate-700';
      l.textContent = label;
      wrap.appendChild(l);

      let input;
      if (type === 'select') {
        input = document.createElement('select');
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        (options || []).forEach(opt => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          input.appendChild(o);
        });
        input.value = value ?? '';
      } else if (type === 'textarea') {
        input = document.createElement('textarea');
        input.rows = rows;
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        input.placeholder = placeholder;
        input.value = value ?? '';
      } else {
        input = document.createElement('input');
        input.type = type;
        input.className = 'w-full px-3 py-2 rounded-lg border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300';
        input.placeholder = placeholder;
        input.value = value ?? '';
      }

      wrap.appendChild(input);

      if (help) {
        const h = document.createElement('div');
        h.className = 'text-[11px] text-slate-500';
        h.textContent = help;
        wrap.appendChild(h);
      }
      return { wrap, input };
    }

    function mkTwoCols(...nodes) {
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';
      nodes.forEach(n => grid.appendChild(n));
      return grid;
    }

    function openModal({ title, subtitle = '', hint = '', okText = 'Ø­ÙØ¸', cancelText = 'Ø¥Ù„ØºØ§Ø¡', body, onOk }) {
      document.body.classList.remove('drawer-open');
      const tpl = $('#tpl-modal');
      const node = tpl.content.cloneNode(true);
      const root = node.firstElementChild;
      $('[data-title]', root).textContent = title;
      $('[data-subtitle]', root).textContent = subtitle;
      $('[data-hint]', root).textContent = hint;
      const okBtn = $('[data-ok]', root);
      okBtn.textContent = okText;
      const cancelBtn = $('[data-cancel]', root);
      cancelBtn.textContent = cancelText;
      $('[data-body]', root).appendChild(body);

      const close = () => root.remove();
      $$('[data-close]', root).forEach(b => b.addEventListener('click', close));
      cancelBtn.addEventListener('click', close);
      okBtn.addEventListener('click', async () => {
        try {
          okBtn.disabled = true;
          okBtn.classList.add('opacity-60');
          await onOk?.(close);
        } finally {
          okBtn.disabled = false;
          okBtn.classList.remove('opacity-60');
        }
      });

      const card = $('[data-app-modal-card]', root);
      if (card) {
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        if (isMobile) {
          card.style.maxHeight = 'calc(100vh - 72px)';
          card.style.width = '100vw';
          card.style.borderBottomLeftRadius = '0px';
          card.style.borderBottomRightRadius = '0px';
          card.style.paddingBottom = 'env(safe-area-inset-bottom)';
        } else {
          card.style.maxHeight = '80vh';
        }
      }

      document.body.appendChild(root);
      return root;
    }

    function confirmDialog({ title = 'ØªØ£ÙƒÙŠØ¯', message = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', confirmText = 'Ø­Ø°Ù', danger = true }) {
      return new Promise((resolve) => {
        const body = document.createElement('div');
        body.className = 'text-sm text-slate-700 leading-7';
        body.textContent = message;
        openModal({
          title,
          subtitle: danger ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.' : '',
          hint: '',
          okText: confirmText,
          cancelText: 'Ø¥Ù„ØºØ§Ø¡',
          body,
          onOk: async (close) => { resolve(true); close(); }
        });
        // Cancel returns false
        const modals = $$('#tpl-modal');
        // no-op; handled by user
        setTimeout(() => {
          // If user closes without OK
          const onRemove = () => resolve(false);
          // Not reliable to detect; we keep false until ok.
          // We'll resolve false only when cancel pressed by hooking? We'll do in openModal cancel.
        }, 0);
      });
    }

    function mkEmpty(msg, actions = []) {
      const tpl = $('#tpl-empty');
      const node = tpl.content.cloneNode(true);
      const root = node.firstElementChild;
      $('[data-msg]', root).textContent = msg;
      const actionsWrap = $('[data-actions]', root);
      actions.forEach(a => actionsWrap.appendChild(a));
      return root;
    }

    // =============================
    // Shell + routing
    // =============================
    function mountShell() {
      const shell = $('#tpl-shell').content.cloneNode(true);
      $('#app').innerHTML = '';
      $('#app').appendChild(shell);
      // Style hooks
      const style = document.createElement('style');
      style.textContent = `
        .nav-item { text-align: right; padding: .65rem .75rem; border-radius: .75rem; border: 1px solid transparent; color: rgb(15 23 42); }
        .nav-item:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .nav-item.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .btn-nav { padding: .6rem .7rem; border-radius: .75rem; border: 1px solid rgb(226 232 240); background: white; font-size: .8rem; }
        .btn-nav:hover { background: rgb(248 250 252); }
        .chip { padding: .25rem .55rem; border-radius: 999px; border: 1px solid rgb(226 232 240); background: white; font-size: .75rem; color: rgb(51 65 85); }
        .nav-aside { position: fixed; top: 0; bottom: 0; right: 0; z-index: 40; }
        .nav-main { padding-bottom: calc(120px + env(safe-area-inset-bottom)); }
        .nav-scroll { max-height: calc(100vh - 260px); }
        .nav-link { width: 100%; text-align: right; display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .7rem .75rem; border-radius: .9rem; border: 1px solid transparent; color: rgb(15 23 42); background: transparent; }
        .nav-link:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .nav-link.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .nav-link:focus-visible { outline: 2px solid rgb(148 163 184); outline-offset: 2px; }
        .nav-badge { min-width: 28px; height: 20px; padding: 0 8px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; border: 1px solid rgb(226 232 240); background: rgb(248 250 252); color: rgb(51 65 85); }
        .nav-link.active .nav-badge { border-color: rgba(255,255,255,.25); background: rgba(255,255,255,.15); color: white; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 50; background: white; border-top: 1px solid rgb(226 232 240); padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); }
        .bottom-nav-inner { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; }
        .bottom-nav-btn { height: 44px; border-radius: 14px; border: 1px solid transparent; background: transparent; color: rgb(15 23 42); font-size: 13px; font-weight: 600; }
        .bottom-nav-btn:hover { background: rgb(248 250 252); border-color: rgb(226 232 240); }
        .bottom-nav-btn.active { background: rgb(15 23 42); color: white; border-color: rgb(15 23 42); }
        .drawer { position: fixed; inset: 0; z-index: 60; pointer-events: none; }
        .drawer-overlay { position: absolute; inset: 0; background: rgba(15,23,42,.45); opacity: 0; transition: opacity 180ms ease; }
        .drawer-sheet { position: absolute; left: 0; right: 0; bottom: 0; background: white; border-top-left-radius: 18px; border-top-right-radius: 18px; border-top: 1px solid rgb(226 232 240); transform: translateY(12px) translateY(100%); transition: transform 220ms ease; max-height: 78vh; overflow: auto; padding: 12px 14px 16px; }
        body.drawer-open .drawer { pointer-events: auto; }
        body.drawer-open .drawer-overlay { opacity: 1; }
        body.drawer-open .drawer-sheet { transform: translateY(0); }
        .drawer-title { font-weight: 800; font-size: 14px; color: rgb(15 23 42); }
        .drawer-close { height: 44px; padding: 0 14px; border-radius: 14px; border: 1px solid rgb(226 232 240); background: white; font-size: 13px; font-weight: 700; }
        @media (min-width: 768px) {
          .nav-main { padding-bottom: 0; }
        }
      `;
      document.head.appendChild(style);

      if (!window.__navDelegationInstalled) {
        window.__navDelegationInstalled = true;
        document.addEventListener('click', (e) => {
          const navBtn = e.target.closest('[data-nav]');
          if (navBtn) {
            const to = navBtn.getAttribute('data-nav');
            if (to) location.hash = to;
            return;
          }
          const moreBtn = e.target.closest('[data-nav-more]');
          if (moreBtn) {
            document.body.classList.add('drawer-open');
            return;
          }
          const closeBtn = e.target.closest('[data-nav-drawer-close]');
          if (closeBtn) {
            document.body.classList.remove('drawer-open');
            return;
          }
          const logoutBtn = e.target.closest('[data-nav-logout]');
          if (logoutBtn) {
            logout();
            return;
          }
        });
      }

      renderShellMeta();
      window.addEventListener('hashchange', renderRoute);
      document.addEventListener('keydown', (e) => {
        if (!e.altKey) return;
        const map = {
          '1': '#/home', '2': '#/companies', '3': '#/tenders', '4': '#/contracts', '5': '#/tasks', '6': '#/followups', '7': '#/android'
        };
        if (map[e.key]) {
          e.preventDefault();
          location.hash = map[e.key];
        }
      });
      renderRoute();
    }

    async function logout() {
      document.body.classList.remove('drawer-open');
      await logoutServer();
      authState = { accessToken: null, refreshToken: null, role: null, email: null };
      clearAuth();
      location.hash = '#/login';
    }

    function renderNav(activeRoute, userRole, counts) {
      const items = [
        { key: 'home', label: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', href: '#/home', group: 'main' },
        { key: 'companies', label: 'Ø§Ù„Ø´Ø±ÙƒØ§Øª', href: '#/companies', group: 'main', badge: Number(counts?.companies || 0), badgeColor: 'slate' },
        { key: 'tenders', label: 'Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª', href: '#/tenders', group: 'more' },
        { key: 'contracts', label: 'Ø§Ù„Ø¹Ù‚ÙˆØ¯', href: '#/contracts', group: 'more' },
        { key: 'tasks', label: 'Ø§Ù„Ù…Ù‡Ø§Ù…', href: '#/tasks', group: 'main', badge: Number(counts?.overdueTasks || 0), badgeColor: 'rose' },
        { key: 'followups', label: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª', href: '#/followups', group: 'more' },
        { key: 'backup', label: 'Ù†Ø³Ø®/Ø§Ø³ØªØ¹Ø§Ø¯Ø©', href: '#/backup', group: 'more' },
        { key: 'settings', label: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', href: '#/settings', group: 'more' },
        ...(userRole === 'admin' ? [{ key: 'android', label: 'Ù…ÙˆÙ„Ù‘Ø¯ Android', href: '#/android', group: 'more' }] : [])
      ];

      const isActive = (href) => (activeRoute || '#/home') === href;
      const badgeHtml = (n, variant = 'slate') => {
        if (!Number.isFinite(n) || n <= 0) return '';
        const extra = variant === 'rose' ? 'style="border-color: rgb(254 202 202); background: rgb(254 242 242); color: rgb(159 18 57);"' : '';
        return `<span class="nav-badge" ${extra}>${escapeHtml(n)}</span>`;
      };

      const link = (it) => {
        const active = isActive(it.href);
        return `
          <button class="nav-link ${active ? 'active' : ''}" data-nav="${it.href}" data-nav-item data-nav-title="${escapeHtml(it.label)}" aria-current="${active ? 'page' : 'false'}">
            <span class="font-semibold">${escapeHtml(it.label)}</span>
            ${badgeHtml(it.badge || 0, it.badgeColor)}
          </button>
        `;
      };

      const sidebarHtml = `
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-extrabold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
            <div class="text-xs text-slate-500">Alt+1..7</div>
          </div>
          <div class="flex flex-col gap-1 mt-3">
            ${items.map(link).join('')}
          </div>
          <button class="nav-link mt-2" data-nav-logout data-nav-title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
            <span class="font-semibold text-rose-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            <span class="text-xs text-rose-700">â†©</span>
          </button>
        </div>
      `;

      const bottomHtml = `
        <div class="bottom-nav" role="navigation" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
          <div class="bottom-nav-inner">
            <button class="bottom-nav-btn ${isActive('#/home') ? 'active' : ''}" data-nav="#/home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button class="bottom-nav-btn ${isActive('#/companies') ? 'active' : ''}" data-nav="#/companies">Ø§Ù„Ø´Ø±ÙƒØ§Øª</button>
            <button class="bottom-nav-btn ${isActive('#/tasks') ? 'active' : ''}" data-nav="#/tasks">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
            <button class="bottom-nav-btn" data-nav-more>Ø§Ù„Ù…Ø²ÙŠØ¯</button>
          </div>
        </div>

        <div class="drawer" aria-hidden="false">
          <div class="drawer-overlay" data-nav-drawer-close></div>
          <div class="drawer-sheet" role="dialog" aria-label="Ø§Ù„Ù…Ø²ÙŠØ¯">
            <div class="flex items-center justify-between gap-3">
              <div class="drawer-title">Ø§Ù„Ù…Ø²ÙŠØ¯</div>
              <button class="drawer-close" data-nav-drawer-close>Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div class="mt-3 flex flex-col gap-1">
              ${items.filter(it => it.group === 'more').map(link).join('')}
              <button class="nav-link mt-2" data-nav-logout data-nav-title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                <span class="font-semibold text-rose-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                <span class="text-xs text-rose-700">â†©</span>
              </button>
            </div>
          </div>
        </div>
      `;

      return { sidebarHtml, bottomHtml };
    }

    function applyNav(activeRoute) {
      const userRole = authState?.role || null;
      const companiesCount = Array.isArray(state?.companies) ? state.companies.length : 0;
      const overdueTasksCount = Array.isArray(state?.tasks) ? state.tasks.filter(t => computeTaskStatus(t) === 'OVERDUE').length : 0;
      const counts = { companies: companiesCount, overdueTasks: overdueTasksCount };

      const nav = renderNav(activeRoute, userRole, counts);

      const sidebar = $('#navSidebar');
      if (sidebar) sidebar.innerHTML = nav.sidebarHtml;

      const mobile = $('#navMobile');
      if (mobile) mobile.innerHTML = nav.bottomHtml;

      const search = $('#navSearch');
      if (search && !search.__bound) {
        search.__bound = true;
        search.addEventListener('input', () => {
          const q = (search.value || '').trim().toLowerCase();
          const nodes = $$('[data-nav-item]');
          nodes.forEach(n => {
            const title = (n.getAttribute('data-nav-title') || '').toLowerCase();
            const hit = !q || title.includes(q);
            n.classList.toggle('hidden', !hit);
          });
        });
      }
    }

    function renderRoute() {
      normalizeTasksStatuses();

      const hashFull = location.hash || '#/home';
      const activeHash = hashFull.split('?')[0] || '#/home';
      const [pathOnly] = hashFull.replace('#', '').split('?');

      const isAuthRoute = pathOnly === '/login' || pathOnly === '/register';
      const isAuthed = !!authState?.accessToken;

      if (!isAuthed && !isAuthRoute) {
        location.hash = '#/login';
        return;
      }

      if (isAuthed) {
        applyNav(activeHash);
      } else {
        const sidebar = $('#navSidebar');
        if (sidebar) sidebar.innerHTML = '';
        const mobile = $('#navMobile');
        if (mobile) mobile.innerHTML = '';
      }

      const [path, qStr] = hashFull.replace('#', '').split('?');
      const q = new URLSearchParams(qStr || '');

      const content = $('#content');
      content.innerHTML = '';

      if (path === '/login') return renderLogin(content, q);
      if (path === '/register') return renderRegister(content, q);

      if (path === '/home') return renderHome(content);
      if (path === '/companies') return renderCompanies(content, q);
      if (path === '/company') return renderCompanyDetails(content, q.get('id'));
      if (path === '/tenders') return renderTenders(content, q);
      if (path === '/tender') return renderTenderDetails(content, q.get('id'));
      if (path === '/contracts') return renderContracts(content, q);
      if (path === '/contract') return renderContractDetails(content, q.get('id'));
      if (path === '/tasks') return renderTasks(content, q);
      if (path === '/followups') return renderFollowups(content, q);
      if (path === '/backup') return renderBackup(content);
      if (path === '/settings') return renderSettings(content);
      if (path === '/android') return renderAndroidGenerator(content);

      location.hash = '#/home';
    }

    function renderSettings(root) {
      setPage('Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù‚Ø±ÙŠØ¨Ø§Ù‹).');
      const box = document.createElement('div');
      box.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      box.innerHTML = `
        <div class="text-sm font-bold">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
        <div class="text-sm text-slate-600 mt-2 leading-7">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹. Ø­Ø§Ù„ÙŠØ§Ù‹ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙØ­Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ùˆ Ù…ÙˆÙ„Ù‘Ø¯ Android.</div>
      `;
      root.appendChild(box);
    }

    function renderLogin(root, q) {
      // Hide sidebar and footer for login page
      const sidebar = $('#sidebar');
      const navMobile = $('#navMobile');
      if (sidebar) sidebar.style.display = 'none';
      if (navMobile) navMobile.style.display = 'none';

      setPage('', '');

      // Create full-page login container
      root.innerHTML = `
        <div class="min-h-[80vh] flex items-center justify-center animate-fadeInUp">
          <div class="w-full max-w-md">
            <!-- Logo & Header -->
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-glow animate-float">
                <span class="text-3xl font-bold text-white">Ù…</span>
              </div>
              <h1 class="text-2xl font-bold gradient-text">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯</h1>
              <p class="text-slate-500 mt-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
            </div>
            
            <!-- Login Card -->
            <div class="card-modern p-8 shadow-soft hover-lift">
              <form id="loginForm" class="space-y-5">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                  <input 
                    id="loginEmail" 
                    type="email" 
                    value="${escapeHtml(q.get('email') || authState?.email || '')}"
                    placeholder="name@example.com" 
                    class="input-modern w-full"
                    autocomplete="email"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                  <input 
                    id="loginPassword" 
                    type="password" 
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                    class="input-modern w-full"
                    autocomplete="current-password"
                  />
                </div>
                
                <button 
                  type="submit" 
                  id="loginBtn"
                  class="w-full py-3 px-4 rounded-xl btn-gradient font-bold text-lg flex items-center justify-center gap-2"
                >
                  <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                  <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                  </svg>
                </button>
                
                <div class="relative my-6">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200"></div>
                  </div>
                  <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-slate-500">Ø£Ùˆ</span>
                  </div>
                </div>
                
                <button 
                  type="button" 
                  id="registerBtn"
                  class="w-full py-3 px-4 rounded-xl border-2 border-indigo-100 bg-indigo-50/50 text-indigo-600 font-semibold hover:bg-indigo-100 transition-all"
                >
                  Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
              </form>
              
              <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200">
                <div class="flex items-start gap-3">
                  <span class="text-xl">ğŸ’¡</span>
                  <div>
                    <div class="text-sm font-semibold text-amber-800">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
                    <div class="text-xs text-amber-700 mt-1 leading-relaxed">Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙŠØµØ¨Ø­ Ù…Ø¯ÙŠØ± (admin) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-xs text-slate-400">
              <span>Ù†Ø³Ø®Ø© 2.0</span>
              <span class="mx-2">â€¢</span>
              <span>ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø¢Ù…Ù†</span>
            </div>
          </div>
        </div>
      `;

      // Attach event listeners
      const form = $('#loginForm', root);
      const btnLogin = $('#loginBtn', root);
      const btnRegister = $('#registerBtn', root);

      btnRegister.addEventListener('click', () => {
        const email = ($('#loginEmail', root)?.value || '').trim();
        location.hash = email ? `#/register?email=${encodeURIComponent(email)}` : '#/register';
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        const email = $('#loginEmail', root).value.trim();
        const password = $('#loginPassword', root).value;

        if (!email || !password) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');

        btnLogin.disabled = true;
        btnLogin.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) return alert(data?.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');

          authState = { accessToken: data.accessToken, refreshToken: data.refreshToken, role: data.role || null, email };
          saveAuth(authState);
          location.hash = '#/home';
          renderRoute();
        } finally {
          btnLogin.disabled = false;
          btnLogin.innerHTML = `
            <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
          `;
        };
      };
    }

    function renderRegister(root, q) {
      // Hide sidebar and footer for register page
      const sidebar = $('#sidebar');
      const navMobile = $('#navMobile');
      if (sidebar) sidebar.style.display = 'none';
      if (navMobile) navMobile.style.display = 'none';

      setPage('', '');

      root.innerHTML = `
        <div class="min-h-[80vh] flex items-center justify-center animate-fadeInUp">
          <div class="w-full max-w-md">
            <!-- Logo & Header -->
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-glow animate-float">
                <span class="text-3xl font-bold text-white">+</span>
              </div>
              <h1 class="text-2xl font-bold gradient-text">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
              <p class="text-slate-500 mt-2">Ø³Ø¬Ù‘Ù„ Ø¨Ø±ÙŠØ¯Ùƒ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</p>
            </div>
            
            <!-- Register Card -->
            <div class="card-modern p-8 shadow-soft hover-lift">
              <form id="registerForm" class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                  <input 
                    id="regEmail" 
                    type="email" 
                    value="${escapeHtml(q.get('email') || '')}"
                    placeholder="name@example.com" 
                    class="input-modern w-full"
                    autocomplete="email"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                  <input 
                    id="regPassword" 
                    type="password" 
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                    class="input-modern w-full"
                    autocomplete="new-password"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                  <input 
                    id="regPassword2" 
                    type="password" 
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                    class="input-modern w-full"
                    autocomplete="new-password"
                  />
                </div>
                
                <button 
                  type="submit" 
                  id="registerBtn"
                  class="w-full py-3 px-4 rounded-xl btn-gradient font-bold text-lg flex items-center justify-center gap-2 mt-6"
                >
                  <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                  </svg>
                </button>
                
                <button 
                  type="button" 
                  id="backBtn"
                  class="w-full py-3 px-4 rounded-xl border-2 border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                  </svg>
                  <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                </button>
              </form>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-xs text-slate-400">
              <span>Ù†Ø³Ø®Ø© 2.0</span>
              <span class="mx-2">â€¢</span>
              <span>Ø­Ø³Ø§Ø¨Ùƒ Ø¢Ù…Ù† ÙˆÙ…Ø´ÙØ±</span>
            </div>
          </div>
        </div>
      `;

      // Attach event listeners
      const form = $('#registerForm', root);
      const btnRegister = $('#registerBtn', root);
      const btnBack = $('#backBtn', root);

      btnBack.addEventListener('click', () => {
        const email = ($('#regEmail', root)?.value || '').trim();
        location.hash = email ? `#/login?email=${encodeURIComponent(email)}` : '#/login';
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        const email = $('#regEmail', root).value.trim();
        const password = $('#regPassword', root).value;
        const password2 = $('#regPassword2', root).value;

        if (!email || !password) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
        if (password.length < 8) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        if (password !== password2) return alert('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.');

        btnRegister.disabled = true;
        btnRegister.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          const res = await fetch(`${API_BASE}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) return alert(data?.error || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
          location.hash = `#/login?email=${encodeURIComponent(email)}`;
        } finally {
          btnRegister.disabled = false;
          btnRegister.innerHTML = `
            <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
            </svg>
          `;
        }
      };
    }

    // =============================
    // Dashboard
    // =============================
    function renderHome(root) {
      setPage('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'Ù…Ù„Ø®Ù‘Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.');

      const today = startOfDay(nowTs());
      const in7 = daysFromNow(7);
      const in30 = daysFromNow(30);

      const tasks = state.tasks.map(t => ({ ...t, status: computeTaskStatus(t) }));
      const dueToday = tasks.filter(t => t.dueDate && startOfDay(t.dueDate) === today && t.status !== 'DONE');
      const overdue = tasks.filter(t => t.status === 'OVERDUE');

      const upcomingTenders = state.tenders
        .filter(t => t.submissionDeadline)
        .map(t => ({ ...t, submissionDeadline: t.submissionDeadline }))
        .filter(t => startOfDay(t.submissionDeadline) >= today && startOfDay(t.submissionDeadline) <= in7)
        .sort((a, b) => a.submissionDeadline - b.submissionDeadline)
        .slice(0, 8);

      const expiringContracts = state.contracts
        .map(c => ({ ...c, nextDate: c.renewalDate || c.endDate }))
        .filter(c => c.nextDate)
        .filter(c => startOfDay(c.nextDate) >= today && startOfDay(c.nextDate) <= in30)
        .sort((a, b) => a.nextDate - b.nextDate)
        .slice(0, 8);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4';

      const box1 = mkCard('Ù…Ù‡Ø§Ù… Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…', `${dueToday.length} Ù…Ù‡Ù…Ø©`, (() => {
        const el = document.createElement('div');
        if (!dueToday.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„ÙŠÙˆÙ….</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        dueToday.slice(0, 7).forEach(t => list.appendChild(taskRow(t)));
        const more = mkBtn('ÙØªØ­ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…', 'secondary', () => location.hash = '#/tasks?filter=today');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(list);
        el.appendChild(more);
        return el;
      })());

      const box2 = mkCard('Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©', `${overdue.length} Ù…Ù‡Ù…Ø©`, (() => {
        const el = document.createElement('div');
        if (!overdue.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        overdue.slice(0, 7).forEach(t => list.appendChild(taskRow(t)));
        const more = mkBtn('ÙØªØ­ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©', 'secondary', () => location.hash = '#/tasks?filter=overdue');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(list);
        el.appendChild(more);
        return el;
      })());

      const box3 = mkCard('Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù†Ø§Ù‚ØµØ§Øª Ù‚Ø±ÙŠØ¨Ø© (7 Ø£ÙŠØ§Ù…)', `${upcomingTenders.length} Ù…ÙˆØ¹Ø¯`, (() => {
        const el = document.createElement('div');
        if (!upcomingTenders.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ù‚Ø±ÙŠØ¨Ø©.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        upcomingTenders.forEach(t => {
          const row = document.createElement('div');
          row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';
          row.innerHTML = `
            <div>
              <div class="font-semibold text-sm">${escapeHtml(t.title)}</div>
              <div class="text-xs text-slate-600 mt-1">${escapeHtml(getCompanyName(t.companyId))} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(labels.TenderStatus[t.status] || t.status)}</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-500">Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯</div>
              <div class="text-sm font-bold">${fmtDate(t.submissionDeadline)}</div>
              <button class="mt-2 text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50" data-open>ÙØªØ­</button>
            </div>
          `;
          $('[data-open]', row).addEventListener('click', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`);
          list.appendChild(row);
        });
        el.appendChild(list);
        const more = mkBtn('ÙØªØ­ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª', 'secondary', () => location.hash = '#/tenders');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(more);
        return el;
      })());

      const box4 = mkCard('Ø¹Ù‚ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ (30 ÙŠÙˆÙ…)', `${expiringContracts.length} Ø¹Ù‚Ø¯`, (() => {
        const el = document.createElement('div');
        if (!expiringContracts.length) {
          el.innerHTML = '<div class="text-sm text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.</div>';
          return el;
        }
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-2';
        expiringContracts.forEach(c => {
          const row = document.createElement('div');
          row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';
          row.innerHTML = `
            <div>
              <div class="font-semibold text-sm">${escapeHtml(c.title)}</div>
              <div class="text-xs text-slate-600 mt-1">${escapeHtml(getCompanyName(c.companyId))} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(labels.ContractStatus[c.status] || c.status)}</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-500">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
              <div class="text-sm font-bold">${fmtDate(c.nextDate)}</div>
              <button class="mt-2 text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50" data-open>ÙØªØ­</button>
            </div>
          `;
          $('[data-open]', row).addEventListener('click', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`);
          list.appendChild(row);
        });
        el.appendChild(list);
        const more = mkBtn('ÙØªØ­ ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯', 'secondary', () => location.hash = '#/contracts');
        more.classList.add('w-full', 'mt-2');
        el.appendChild(more);
        return el;
      })());

      grid.appendChild(box1);
      grid.appendChild(box2);
      grid.appendChild(box3);
      grid.appendChild(box4);
      root.appendChild(grid);

      // Quick actions
      const actions = document.createElement('div');
      actions.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      actions.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm font-bold">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
            <div class="text-xs text-slate-500 mt-1">Ø£Ø¶Ù Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø³Ø±Ø¹Ø© Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ„Ù‘Ø¯ Android Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø§Ù‡Ø².</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="chip" data-act="addCompany">+ Ø´Ø±ÙƒØ©</button>
            <button class="chip" data-act="addTender">+ Ù…Ù†Ø§Ù‚ØµØ©</button>
            <button class="chip" data-act="addContract">+ Ø¹Ù‚Ø¯</button>
            <button class="chip" data-act="addTask">+ Ù…Ù‡Ù…Ø©</button>
            <button class="chip" data-act="addFollow">+ Ù…ØªØ§Ø¨Ø¹Ø©</button>
          </div>
        </div>
      `;
      $('[data-act="addCompany"]', actions).addEventListener('click', () => openCompanyForm());
      $('[data-act="addTender"]', actions).addEventListener('click', () => openTenderForm());
      $('[data-act="addContract"]', actions).addEventListener('click', () => openContractForm());
      $('[data-act="addTask"]', actions).addEventListener('click', () => openTaskForm());
      $('[data-act="addFollow"]', actions).addEventListener('click', () => openFollowUpForm());
      root.appendChild(actions);

      // Web notification helper (while page open)
      const note = document.createElement('div');
      note.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      note.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm font-bold">ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <div class="text-xs text-slate-500 mt-1">Ù‡Ø°Ø§ Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø· (Ù„Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©). Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Android ÙŠØ³ØªØ®Ø¯Ù… WorkManager.</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-req>Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <button class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" data-test>Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
          </div>
        </div>
      `;
      $('[data-req]', note).addEventListener('click', async () => {
        if (!('Notification' in window)) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
        const p = await Notification.requestPermission();
        alert('Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ù†: ' + p);
      });
      $('[data-test]', note).addEventListener('click', () => {
        if (!('Notification' in window)) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.');
        if (Notification.permission !== 'granted') return alert('ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø°Ù† Ø£ÙˆÙ„Ø§Ù‹.');
        new Notification('ØªØ°ÙƒÙŠØ±', { body: 'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.' });
      });
      root.appendChild(note);
    }

    function taskRow(t) {
      const row = document.createElement('div');
      row.className = 'p-3 rounded-xl border border-slate-200 bg-white flex items-start justify-between gap-3';

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="font-semibold text-sm">${escapeHtml(t.title)}</div>
        <div class="text-xs text-slate-600 mt-1">
          ${escapeHtml(labels.RelatedType[t.relatedType] || t.relatedType)}: ${escapeHtml(getRelatedName(t.relatedType, t.relatedId))}
          â€¢ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${fmtDate(t.dueDate)}
        </div>
      `;

      const right = document.createElement('div');
      right.className = 'flex flex-col items-end gap-2';
      const badges = document.createElement('div');
      badges.className = 'flex flex-wrap gap-1 justify-end';
      badges.appendChild(mkBadge(labels.TaskPriority[t.priority] || t.priority, t.priority === 'HIGH' ? 'rose' : (t.priority === 'MEDIUM' ? 'amber' : 'slate')));
      badges.appendChild(mkBadge(labels.TaskStatus[t.status] || t.status, t.status === 'OVERDUE' ? 'rose' : (t.status === 'DONE' ? 'emerald' : 'blue')));
      right.appendChild(badges);

      const actions = document.createElement('div');
      actions.className = 'flex gap-2';
      const doneBtn = document.createElement('button');
      doneBtn.className = 'text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50';
      doneBtn.textContent = 'ØªÙ…Øª';
      doneBtn.disabled = t.status === 'DONE';
      doneBtn.addEventListener('click', () => {
        updateTask(t.id, { status: 'DONE', updatedAt: nowTs() });
        renderRoute();
      });
      const openBtn = document.createElement('button');
      openBtn.className = 'text-xs px-2 py-1 rounded-lg border border-slate-200 hover:bg-slate-50';
      openBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
      openBtn.addEventListener('click', () => openTaskForm(t));

      actions.appendChild(doneBtn);
      actions.appendChild(openBtn);
      right.appendChild(actions);

      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    function getRelatedName(type, id) {
      if (type === 'COMPANY') return getCompanyName(id);
      if (type === 'TENDER') return getTenderTitle(id);
      if (type === 'CONTRACT') return getContractTitle(id);
      return 'â€”';
    }

    // =============================
    // Companies
    // =============================
    function renderCompanies(root, q) {
      setPage('Ø§Ù„Ø´Ø±ÙƒØ§Øª', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ).', [
        mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©', 'primary', () => openCompanyForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'Ø¨Ø­Ø«', placeholder: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...', value: q.get('s') || '' });
      const sector = mkField({
        label: 'ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø·Ø§Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
        type: 'select',
        value: q.get('sector') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...uniqueSectors().map(s => ({ value: s, label: s }))]
      });

      const row = mkTwoCols(search.wrap, sector.wrap);
      controls.appendChild(row);

      const apply = mkBtn('ØªØ·Ø¨ÙŠÙ‚', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (sector.input.value) params.set('sector', sector.input.value);
        location.hash = `#/companies?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);

      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const sec = q.get('sector') || '';
      let items = [...state.companies];
      if (s) items = items.filter(c => (c.name || '').toLowerCase().includes(s) || (c.phone1 || '').includes(s) || (c.phone2 || '').includes(s));
      if (sec) items = items.filter(c => (c.sector || '') === sec);
      items.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));

      if (!items.length) {
        root.appendChild(mkEmpty('Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø´Ø±ÙƒØ© Ø«Ù… Ø£Ø¶Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©', 'primary', () => openCompanyForm()),
          mkBtn('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'secondary', () => location.hash = '#/backup')
        ]));
        return;
      }

      const rows = items.map(c => {
        const name = document.createElement('div');
        name.innerHTML = `<div class="font-semibold">${escapeHtml(c.name)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(c.sector || 'â€”')} â€¢ ${escapeHtml(c.phone1 || 'â€”')}</div>`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('ÙØªØ­', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(c.id)}`));
        actions.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openCompanyForm(c)));
        actions.appendChild(mkBtn('Ø­Ø°Ù', 'danger', async () => {
          const ok = confirm(`Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© "${c.name}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª (Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª) Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹.`);
          if (!ok) return;
          deleteCompanyCascade(c.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([
          name,
          `<div class="text-xs text-slate-600">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(c.address || 'â€”')}<br/>Ø§Ù„Ø¨Ø±ÙŠØ¯: ${escapeHtml(c.email || 'â€”')}<br/>Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${escapeHtml(c.website || 'â€”')}</div>`,
          actions
        ]);
      });

      root.appendChild(mkTable(['Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
    }

    function uniqueSectors() {
      const set = new Set(state.companies.map(c => (c.sector || '').trim()).filter(Boolean));
      return Array.from(set).sort((a, b) => a.localeCompare(b, 'ar'));
    }

    function openCompanyForm(existing = null) {
      const isEdit = !!existing;
      const body = document.createElement('div');

      const fName = mkField({ label: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© *', value: existing?.name || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© XYZ' });
      const fSector = mkField({ label: 'Ø§Ù„Ù‚Ø·Ø§Ø¹/Ø§Ù„Ù†ÙˆØ¹', value: existing?.sector || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø­ÙƒÙˆÙ…ÙŠ / Ø®Ø§Øµ / Ù…Ù‚Ø§ÙˆÙ„Ø§Øª...' });
      const fAddress = mkField({ label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', value: existing?.address || '', placeholder: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...' });
      const fPhone1 = mkField({ label: 'Ù‡Ø§ØªÙ 1 (Ø£Ø³Ø§Ø³ÙŠ)', value: existing?.phone1 || '', placeholder: '05xxxxxxxx' });
      const fPhone2 = mkField({ label: 'Ù‡Ø§ØªÙ 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', value: existing?.phone2 || '' });
      const fEmail = mkField({ label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'email', value: existing?.email || '' });
      const fWebsite = mkField({ label: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'url', value: existing?.website || '' });
      const fNotes = mkField({ label: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©', type: 'textarea', rows: 4, value: existing?.notes || '', placeholder: 'Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©...' });

      body.appendChild(mkTwoCols(fName.wrap, fSector.wrap));
      body.appendChild(mkTwoCols(fPhone1.wrap, fPhone2.wrap));
      body.appendChild(mkTwoCols(fEmail.wrap, fWebsite.wrap));
      body.appendChild(fAddress.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ©' : 'Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©',
        subtitle: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ©.',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const name = fName.input.value.trim();
          if (!name) return alert('Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ø·Ù„ÙˆØ¨.');
          const obj = {
            id: existing?.id || uuid(),
            name,
            sector: fSector.input.value.trim() || null,
            address: fAddress.input.value.trim() || null,
            phone1: fPhone1.input.value.trim() || null,
            phone2: fPhone2.input.value.trim() || null,
            email: fEmail.input.value.trim() || null,
            website: fWebsite.input.value.trim() || null,
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };
          upsert('companies', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function deleteCompanyCascade(companyId) {
      state.companies = state.companies.filter(c => c.id !== companyId);
      state.contacts = state.contacts.filter(c => c.companyId !== companyId);
      state.followups = state.followups.filter(f => f.companyId !== companyId);
      const tendersToDelete = new Set(state.tenders.filter(t => t.companyId === companyId).map(t => t.id));
      const contractsToDelete = new Set(state.contracts.filter(c => c.companyId === companyId).map(c => c.id));
      state.tenders = state.tenders.filter(t => t.companyId !== companyId);
      state.contracts = state.contracts.filter(c => c.companyId !== companyId);
      state.tasks = state.tasks.filter(t => {
        if (t.relatedType === 'COMPANY' && t.relatedId === companyId) return false;
        if (t.relatedType === 'TENDER' && tendersToDelete.has(t.relatedId)) return false;
        if (t.relatedType === 'CONTRACT' && contractsToDelete.has(t.relatedId)) return false;
        return true;
      });
      state.followups = state.followups.filter(f => !(tendersToDelete.has(f.tenderId) || contractsToDelete.has(f.contractId)));
    }

    function renderCompanyDetails(root, id) {
      const company = state.companies.find(c => c.id === id);
      if (!company) {
        setPage('Ø§Ù„Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'Ù‚Ø¯ ØªÙƒÙˆÙ† Ø­ÙØ°ÙØª Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.');
        root.appendChild(mkEmpty('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.', [
          mkBtn('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø±ÙƒØ§Øª', 'secondary', () => location.hash = '#/companies')
        ]));
        return;
      }

      setPage(company.name, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ© + Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª + Ø§Ù„Ø¹Ù‚ÙˆØ¯ + Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ + Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª.', [
        mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openCompanyForm(company)),
        mkBtn('+ Ù…Ù†Ø§Ù‚ØµØ©', 'primary', () => openTenderForm({ companyId: company.id })),
        mkBtn('+ Ø¹Ù‚Ø¯', 'secondary', () => openContractForm({ companyId: company.id })),
        mkBtn('+ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„', 'secondary', () => openContactForm({ companyId: company.id })),
        mkBtn('+ Ù…ØªØ§Ø¨Ø¹Ø©', 'secondary', () => openFollowUpForm({ companyId: company.id }))
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const info = document.createElement('div');
      info.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      info.innerHTML = `
        <div class="text-sm font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ù‚Ø·Ø§Ø¹</div><div class="font-semibold mt-1">${escapeHtml(company.sector || 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="font-semibold mt-1">${escapeHtml(company.phone1 || 'â€”')}</div><div class="text-xs text-slate-600 mt-1">${escapeHtml(company.phone2 || '')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ø¨Ø±ÙŠØ¯</div><div class="font-semibold mt-1">${escapeHtml(company.email || 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div class="font-semibold mt-1">${escapeHtml(company.website || 'â€”')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div><div class="font-semibold mt-1">${escapeHtml(company.address || 'â€”')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(company.notes || 'â€”')}</div></div>
        </div>
      `;

      const stats = document.createElement('div');
      stats.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const tendersCount = state.tenders.filter(t => t.companyId === company.id).length;
      const contractsCount = state.contracts.filter(c => c.companyId === company.id).length;
      const contactsCount = state.contacts.filter(c => c.companyId === company.id).length;
      const followCount = state.followups.filter(f => f.companyId === company.id).length;
      stats.innerHTML = `
        <div class="text-sm font-bold">Ù…Ù„Ø®Øµ</div>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…Ù†Ø§Ù‚ØµØ§Øª</div><div class="text-xl font-bold mt-1">${tendersCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø¹Ù‚ÙˆØ¯</div><div class="text-xl font-bold mt-1">${contractsCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„</div><div class="text-xl font-bold mt-1">${contactsCount}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…ØªØ§Ø¨Ø¹Ø§Øª</div><div class="text-xl font-bold mt-1">${followCount}</div></div>
        </div>
        <div class="mt-4 text-xs text-slate-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${fmtDateTime(company.createdAt)} â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${fmtDateTime(company.updatedAt)}</div>
      `;

      top.appendChild(info);
      top.appendChild(stats);
      root.appendChild(top);

      // Tabs section
      const tabs = document.createElement('div');
      tabs.className = 'mt-4 bg-white border border-slate-200 rounded-2xl shadow-soft';
      tabs.innerHTML = `
        <div class="flex flex-wrap gap-2 p-3 border-b border-slate-200">
          <button class="chip" data-tab="tenders">Ù…Ù†Ø§Ù‚ØµØ§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
          <button class="chip" data-tab="contracts">Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©</button>
          <button class="chip" data-tab="contacts">Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</button>
          <button class="chip" data-tab="followups">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª</button>
        </div>
        <div class="p-4" data-tab-body></div>
      `;
      const body = $('[data-tab-body]', tabs);

      const setTab = (name) => {
        $$('[data-tab]', tabs).forEach(b => b.classList.toggle('bg-slate-900', b.getAttribute('data-tab') === name));
        $$('[data-tab]', tabs).forEach(b => b.classList.toggle('text-white', b.getAttribute('data-tab') === name));
        body.innerHTML = '';
        if (name === 'tenders') body.appendChild(companyTendersView(company.id));
        if (name === 'contracts') body.appendChild(companyContractsView(company.id));
        if (name === 'contacts') body.appendChild(companyContactsView(company.id));
        if (name === 'followups') body.appendChild(companyFollowupsView(company.id));
      };

      $$('[data-tab]', tabs).forEach(b => b.addEventListener('click', () => setTab(b.getAttribute('data-tab'))));
      setTab('tenders');
      root.appendChild(tabs);
    }

    function companyTendersView(companyId) {
      const wrap = document.createElement('div');
      const items = state.tenders.filter(t => t.companyId === companyId).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      if (!items.length) {
        wrap.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ù‚ØµØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¹Ø¯.', [mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©', 'primary', () => openTenderForm({ companyId }))]));
        return wrap;
      }
      const rows = items.map(t => mkTr([
        `<div class="font-semibold">${escapeHtml(t.title)}<div class="text-xs text-slate-500 mt-1">Ø±Ù‚Ù…: ${escapeHtml(t.refNumber || 'â€”')}</div></div>`,
        `<div class="text-xs text-slate-600">Ø§Ù„Ù†ÙˆØ¹: ${escapeHtml(labels.TenderType[t.type] || t.type)}<br/>Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(labels.TenderStatus[t.status] || t.status)}<br/>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯: <b>${fmtDate(t.submissionDeadline)}</b></div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('ÙØªØ­', 'secondary', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`));
          a.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openTenderForm(t)));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©', 'ØªÙØ§ØµÙŠÙ„', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
      return wrap;
    }

    function companyContractsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.contracts.filter(c => c.companyId === companyId).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      if (!items.length) {
        wrap.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¹Ø¯.', [mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯', 'primary', () => openContractForm({ companyId }))]));
        return wrap;
      }
      const rows = items.map(c => mkTr([
        `<div class="font-semibold">${escapeHtml(c.title)}<div class="text-xs text-slate-500 mt-1">Ø±Ù‚Ù…: ${escapeHtml(c.contractNumber || 'â€”')}</div></div>`,
        `<div class="text-xs text-slate-600">Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(labels.ContractStatus[c.status] || c.status)}<br/>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${fmtDate(c.startDate)}<br/>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${fmtDate(c.endDate)}</b></div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('ÙØªØ­', 'secondary', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`));
          a.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openContractForm(c)));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['Ø§Ù„Ø¹Ù‚Ø¯', 'ØªÙØ§ØµÙŠÙ„', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
      return wrap;
    }

    function companyContactsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.contacts.filter(c => c.companyId === companyId).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between gap-2 mb-3';
      header.appendChild(mkBadge(`${items.length} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„`, 'slate'));
      header.appendChild(mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„', 'primary', () => openContactForm({ companyId })));
      wrap.appendChild(header);

      if (!items.length) {
        wrap.appendChild(mkEmpty('Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙƒØ© (Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ + Ø§Ù„Ø¬ÙˆØ§Ù„/ÙˆØ§ØªØ³Ø§Ø¨).', [mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„', 'primary', () => openContactForm({ companyId }))]));
        return wrap;
      }

      const rows = items.map(p => mkTr([
        `<div class="font-semibold">${escapeHtml(p.name)}<div class="text-xs text-slate-500 mt-1">${escapeHtml(p.role || 'â€”')}</div></div>`,
        `<div class="text-xs text-slate-600">Ø§Ù„Ø¬ÙˆØ§Ù„/ÙˆØ§ØªØ³Ø§Ø¨: ${escapeHtml(p.mobile || 'â€”')}<br/>Ø§Ù„Ø¨Ø±ÙŠØ¯: ${escapeHtml(p.email || 'â€”')}<br/>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${escapeHtml(p.notes || 'â€”')}</div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openContactForm(p)));
          a.appendChild(mkBtn('Ø­Ø°Ù', 'danger', () => {
            const ok = confirm(`Ø­Ø°Ù Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ "${p.name}"ØŸ`);
            if (!ok) return;
            state.contacts = state.contacts.filter(x => x.id !== p.id);
            saveState(state);
            renderRoute();
          }));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['Ø§Ù„Ø§Ø³Ù…', 'ØªÙØ§ØµÙŠÙ„', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
      return wrap;
    }

    function companyFollowupsView(companyId) {
      const wrap = document.createElement('div');
      const items = state.followups.filter(f => f.companyId === companyId).sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0));
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between gap-2 mb-3';
      header.appendChild(mkBadge(`${items.length} Ù…ØªØ§Ø¨Ø¹Ø©`, 'slate'));
      header.appendChild(mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©', 'primary', () => openFollowUpForm({ companyId })));
      wrap.appendChild(header);

      if (!items.length) {
        wrap.appendChild(mkEmpty('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØºÙŠØ±Ù‡Ø§.', [mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©', 'primary', () => openFollowUpForm({ companyId }))]));
        return wrap;
      }

      const rows = items.map(f => mkTr([
        `<div class="font-semibold">${escapeHtml(labels.FollowUpType[f.type] || f.type)}<div class="text-xs text-slate-500 mt-1">${fmtDateTime(f.dateTime)}</div></div>`,
        `<div class="text-xs text-slate-600">Ø§Ù„Ø´Ø®Øµ: ${escapeHtml(f.contactName || 'â€”')}<br/>Ø§Ù„Ù…Ù„Ø®Øµ: ${escapeHtml(f.summary || 'â€”')}<br/>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: ${escapeHtml(f.nextStep || 'â€”')} â€¢ ${fmtDate(f.nextStepDate)}</div>`,
        (() => {
          const a = document.createElement('div');
          a.className = 'flex gap-2 justify-end';
          a.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openFollowUpForm(f)));
          a.appendChild(mkBtn('Ø­Ø°Ù', 'danger', () => {
            const ok = confirm('Ø­Ø°Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
            if (!ok) return;
            state.followups = state.followups.filter(x => x.id !== f.id);
            saveState(state);
            renderRoute();
          }));
          return a;
        })()
      ]));
      wrap.appendChild(mkTable(['Ø§Ù„Ù†Ø´Ø§Ø·', 'ØªÙØ§ØµÙŠÙ„', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
      return wrap;
    }

    // =============================
    // Contacts
    // =============================
    function openContactForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ© *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'Ø§Ø®ØªØ± Ø´Ø±ÙƒØ©...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const fName = mkField({ label: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ *', value: existing?.name || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯' });
      const fRole = mkField({ label: 'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ', value: existing?.role || '', placeholder: 'Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª' });
      const fMobile = mkField({ label: 'Ø¬ÙˆØ§Ù„ / ÙˆØ§ØªØ³Ø§Ø¨', value: existing?.mobile || '', placeholder: '05xxxxxxxx' });
      const fEmail = mkField({ label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'email', value: existing?.email || '' });
      const fNotes = mkField({ label: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', type: 'textarea', rows: 3, value: existing?.notes || '', placeholder: 'Ù…Ø«Ø§Ù„: ÙŠÙØ¶Ù‘Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ØµØ±...' });

      body.appendChild(mkTwoCols(fCompany.wrap, fName.wrap));
      body.appendChild(mkTwoCols(fRole.wrap, fMobile.wrap));
      body.appendChild(fEmail.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„' : 'Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„',
        subtitle: 'Ø±Ø¨Ø· Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø±ÙƒØ© Ù…Ø­Ø¯Ø¯Ø©.',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const name = fName.input.value.trim();
          if (!companyId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©.');
          if (!name) return alert('Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ù…Ø·Ù„ÙˆØ¨.');
          const obj = {
            id: existing?.id || uuid(),
            companyId,
            name,
            role: fRole.input.value.trim() || null,
            mobile: fMobile.input.value.trim() || null,
            email: fEmail.input.value.trim() || null,
            notes: fNotes.input.value.trim() || null
          };
          upsert('contacts', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    // =============================
    // Tenders
    // =============================
    function renderTenders(root, q) {
      setPage('Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª/Ø§Ù„ÙØ±Øµ', 'Ø¨Ø­Ø« ÙˆØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø´Ø±ÙƒØ© ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹.', [
        mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©', 'primary', () => openTenderForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'Ø¨Ø­Ø«', placeholder: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹...', value: q.get('s') || '' });
      const status = mkField({
        label: 'Ø§Ù„Ø­Ø§Ù„Ø©',
        type: 'select',
        value: q.get('status') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...Enums.TenderStatus.map(v => ({ value: v, label: labels.TenderStatus[v] || v }))]
      });
      const company = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ©',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const from = mkField({ label: 'Ù…Ù† ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(search.wrap, status.wrap));
      controls.appendChild(mkTwoCols(company.wrap, from.wrap));
      controls.appendChild(mkTwoCols(to.wrap, document.createElement('div')));

      const apply = mkBtn('ØªØ·Ø¨ÙŠÙ‚', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (status.input.value) params.set('status', status.input.value);
        if (company.input.value) params.set('company', company.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/tenders?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const st = q.get('status') || '';
      const comp = q.get('company') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.tenders];
      if (s) items = items.filter(t => (t.title || '').toLowerCase().includes(s) || (t.refNumber || '').toLowerCase().includes(s));
      if (st) items = items.filter(t => t.status === st);
      if (comp) items = items.filter(t => t.companyId === comp);
      if (fromTs) items = items.filter(t => t.submissionDeadline && startOfDay(t.submissionDeadline) >= startOfDay(fromTs));
      if (toTs) items = items.filter(t => t.submissionDeadline && startOfDay(t.submissionDeadline) <= startOfDay(toTs));
      items.sort((a, b) => (a.submissionDeadline || Infinity) - (b.submissionDeadline || Infinity));

      if (!items.length) {
        root.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ù‚ØµØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«/Ø§Ù„ØªØµÙÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©', 'primary', () => openTenderForm()),
          mkBtn('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ©', 'secondary', () => location.hash = '#/tenders')
        ]));
        return;
      }

      const rows = items.map(t => {
        const title = document.createElement('div');
        title.innerHTML = `<div class="font-semibold">${escapeHtml(t.title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(getCompanyName(t.companyId))}</div>`;
        const statusBadge = document.createElement('div');
        statusBadge.className = 'flex flex-col items-start gap-2';
        statusBadge.appendChild(mkBadge(labels.TenderStatus[t.status] || t.status, t.status === 'AWARDED' ? 'emerald' : (t.status === 'LOST' ? 'rose' : 'blue')));
        statusBadge.appendChild(mkBadge(labels.TenderType[t.type] || t.type, 'slate'));

        const dateInfo = document.createElement('div');
        dateInfo.className = 'text-xs text-slate-600';
        dateInfo.innerHTML = `Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ…: <b>${fmtDate(t.submissionDeadline)}</b><br/>ÙØªØ­ ÙÙ†ÙŠ: ${fmtDate(t.technicalOpeningDate)} â€¢ ÙØªØ­ Ù…Ø§Ù„ÙŠ: ${fmtDate(t.financialOpeningDate)}`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('ÙØªØ­', 'secondary', () => location.hash = `#/tender?id=${encodeURIComponent(t.id)}`));
        actions.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openTenderForm(t)));
        actions.appendChild(mkBtn('Ø­Ø°Ù', 'danger', () => {
          const ok = confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© "${t.title}"ØŸ`);
          if (!ok) return;
          deleteTenderCascade(t.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([title, statusBadge, dateInfo, actions]);
      });

      root.appendChild(mkTable(['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
    }

    function openTenderForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ© *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'Ø§Ø®ØªØ± Ø´Ø±ÙƒØ©...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))],
        help: 'ÙŠÙØ¶Ù‘Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© Ø¨Ù‡Ø§.'
      });
      const fTitle = mkField({ label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©/Ø§Ù„ÙØ±ØµØ© *', value: existing?.title || '', placeholder: 'Ù…Ø«Ø§Ù„: ØªÙˆØ±ÙŠØ¯ Ù…Ø¹Ø¯Ø§Øª...' });
      const fRef = mkField({ label: 'Ø±Ù‚Ù…/Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', value: existing?.refNumber || '' });
      const fType = mkField({
        label: 'Ø§Ù„Ù†ÙˆØ¹',
        type: 'select',
        value: existing?.type || 'TENDER',
        options: Enums.TenderType.map(v => ({ value: v, label: labels.TenderType[v] || v }))
      });
      const fStatus = mkField({
        label: 'Ø§Ù„Ø­Ø§Ù„Ø©',
        type: 'select',
        value: existing?.status || 'PREPARATION',
        options: Enums.TenderStatus.map(v => ({ value: v, label: labels.TenderStatus[v] || v }))
      });

      const fDocsDeadline = mkField({ label: 'Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒØ±Ø§Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.docsPurchaseDeadline) });
      const fSubmission = mkField({ label: 'Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ *', type: 'date', value: toISODate(existing?.submissionDeadline) });
      const fTechOpen = mkField({ label: 'ÙØªØ­ Ø§Ù„Ù…Ø¸Ø±ÙˆÙ Ø§Ù„ÙÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.technicalOpeningDate) });
      const fFinOpen = mkField({ label: 'ÙØªØ­ Ø§Ù„Ù…Ø¸Ø±ÙˆÙ Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.financialOpeningDate) });
      const fAward = mkField({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±Ø³ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.awardDate) });

      const fExpectedValue = mkField({ label: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'number', value: existing?.expectedValue ?? '' });
      const fFinalValue = mkField({ label: 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'number', value: existing?.finalValue ?? '' });
      const fPrimaryG = mkField({ label: 'Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'number', value: existing?.primaryGuarantee ?? '' });
      const fFinalG = mkField({ label: 'Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'number', value: existing?.finalGuarantee ?? '' });
      const fMargin = mkField({ label: 'Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'number', value: existing?.margin ?? '' });

      const fNotes = mkField({ label: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', type: 'textarea', rows: 4, value: existing?.notes || '', placeholder: 'Ù…Ù†Ø§ÙØ³ÙŠÙ†ØŒ Ø´Ø±ÙˆØ· Ø®Ø§ØµØ©ØŒ ...' });

      body.appendChild(mkTwoCols(fCompany.wrap, fTitle.wrap));
      body.appendChild(mkTwoCols(fRef.wrap, fType.wrap));
      body.appendChild(mkTwoCols(fStatus.wrap, fSubmission.wrap));
      body.appendChild(mkTwoCols(fDocsDeadline.wrap, fTechOpen.wrap));
      body.appendChild(mkTwoCols(fFinOpen.wrap, fAward.wrap));

      const finHeader = document.createElement('div');
      finHeader.className = 'mt-3 text-sm font-bold';
      finHeader.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
      body.appendChild(finHeader);
      body.appendChild(mkTwoCols(fExpectedValue.wrap, fFinalValue.wrap));
      body.appendChild(mkTwoCols(fPrimaryG.wrap, fFinalG.wrap));
      body.appendChild(mkTwoCols(fMargin.wrap, document.createElement('div')));
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ù‚ØµØ©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ù‚ØµØ©',
        subtitle: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø´Ø±ÙƒØ© + Ø¹Ù†ÙˆØ§Ù† + Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ….',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const title = fTitle.input.value.trim();
          const submission = fromISODate(fSubmission.input.value);
          if (!companyId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©.');
          if (!title) return alert('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨.');
          if (!submission) return alert('Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø·Ù„ÙˆØ¨.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            title,
            refNumber: fRef.input.value.trim() || null,
            type: fType.input.value,
            status: fStatus.input.value,
            docsPurchaseDeadline: fromISODate(fDocsDeadline.input.value),
            submissionDeadline: submission,
            technicalOpeningDate: fromISODate(fTechOpen.input.value),
            financialOpeningDate: fromISODate(fFinOpen.input.value),
            awardDate: fromISODate(fAward.input.value),
            expectedValue: toNumOrNull(fExpectedValue.input.value),
            finalValue: toNumOrNull(fFinalValue.input.value),
            primaryGuarantee: toNumOrNull(fPrimaryG.input.value),
            finalGuarantee: toNumOrNull(fFinalG.input.value),
            margin: toNumOrNull(fMargin.input.value),
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };
          upsert('tenders', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function toNumOrNull(v) {
      const s = (v ?? '').toString().trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function deleteTenderCascade(tenderId) {
      state.tenders = state.tenders.filter(t => t.id !== tenderId);
      state.tasks = state.tasks.filter(t => !(t.relatedType === 'TENDER' && t.relatedId === tenderId));
      state.followups = state.followups.filter(f => f.tenderId !== tenderId);
    }

    function renderTenderDetails(root, id) {
      const t = state.tenders.find(x => x.id === id);
      if (!t) {
        setPage('Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'Ù‚Ø¯ ØªÙƒÙˆÙ† Ø­ÙØ°ÙØª Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.');
        root.appendChild(mkEmpty('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.', [mkBtn('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª', 'secondary', () => location.hash = '#/tenders')]));
        return;
      }
      const companyName = getCompanyName(t.companyId);
      setPage(t.title, `Ø§Ù„Ø´Ø±ÙƒØ©: ${companyName}`, [
        mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openTenderForm(t)),
        mkBtn('+ Ù…Ù‡Ù…Ø© Ù…Ø±ØªØ¨Ø·Ø©', 'primary', () => openTaskForm({ relatedType: 'TENDER', relatedId: t.id })),
        mkBtn('ÙØªØ­ Ø§Ù„Ø´Ø±ÙƒØ©', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(t.companyId)}`)
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const basic = document.createElement('div');
      basic.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      basic.innerHTML = `
        <div class="text-sm font-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ù†ÙˆØ¹</div><div class="font-semibold mt-1">${escapeHtml(labels.TenderType[t.type] || t.type)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="font-semibold mt-1">${escapeHtml(labels.TenderStatus[t.status] || t.status)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø±Ù‚Ù…/Ù…Ø±Ø¬Ø¹</div><div class="font-semibold mt-1">${escapeHtml(t.refNumber || 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ…</div><div class="font-semibold mt-1">${fmtDate(t.submissionDeadline)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒØ±Ø§Ø³Ø©</div><div class="font-semibold mt-1">${fmtDate(t.docsPurchaseDeadline)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ÙØªØ­ ÙÙ†ÙŠ/Ù…Ø§Ù„ÙŠ</div><div class="font-semibold mt-1">${fmtDate(t.technicalOpeningDate)} / ${fmtDate(t.financialOpeningDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±Ø³ÙŠØ©</div><div class="font-semibold mt-1">${fmtDate(t.awardDate)}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(t.notes || 'â€”')}</div></div>
        </div>
      `;

      const financial = document.createElement('div');
      financial.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      financial.innerHTML = `
        <div class="text-sm font-bold">Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ</div>
        <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…ØªÙˆÙ‚Ø¹Ø©</div><div class="font-semibold mt-1">${escapeHtml(t.expectedValue ?? 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù†Ù‡Ø§Ø¦ÙŠØ©</div><div class="font-semibold mt-1">${escapeHtml(t.finalValue ?? 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø¶Ù…Ø§Ù† Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</div><div class="font-semibold mt-1">${escapeHtml(t.primaryGuarantee ?? 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø¶Ù…Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="font-semibold mt-1">${escapeHtml(t.finalGuarantee ?? 'â€”')}</div></div>
          <div class="col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù‡Ø§Ù…Ø´</div><div class="font-semibold mt-1">${escapeHtml(t.margin ?? 'â€”')}</div></div>
        </div>
        <div class="mt-4 text-xs text-slate-500">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${fmtDateTime(t.updatedAt)}</div>
      `;

      top.appendChild(basic);
      top.appendChild(financial);
      root.appendChild(top);

      // Related tasks
      const related = state.tasks.filter(x => x.relatedType === 'TENDER' && x.relatedId === t.id)
        .map(x => ({ ...x, status: computeTaskStatus(x) }))
        .sort((a, b) => (a.dueDate || Infinity) - (b.dueDate || Infinity));

      const tasksBox = document.createElement('div');
      tasksBox.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      tasksBox.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">Ù…Ù‡Ø§Ù… Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©</div>
            <div class="text-xs text-slate-500 mt-1">${related.length} Ù…Ù‡Ù…Ø©</div>
          </div>
        </div>
      `;
      const list = document.createElement('div');
      list.className = 'mt-3 flex flex-col gap-2';
      if (!related.length) {
        list.appendChild(mkEmpty('Ø£Ø¶Ù Ù…Ù‡Ø§Ù… Ù…Ø«Ù„: Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒØ±Ø§Ø³Ø©ØŒ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠØŒ Ø¥Ù„Ø®.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', 'primary', () => openTaskForm({ relatedType: 'TENDER', relatedId: t.id }))
        ]));
      } else {
        related.forEach(tt => list.appendChild(taskRow(tt)));
      }
      tasksBox.appendChild(list);
      root.appendChild(tasksBox);
    }

    // =============================
    // Contracts
    // =============================
    function renderContracts(root, q) {
      setPage('Ø§Ù„Ø¹Ù‚ÙˆØ¯', 'Ø¨Ø­Ø« ÙˆØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø´Ø±ÙƒØ© ÙˆØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©/Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.', [
        mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯', 'primary', () => openContractForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const search = mkField({ label: 'Ø¨Ø­Ø«', placeholder: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯...', value: q.get('s') || '' });
      const status = mkField({
        label: 'Ø§Ù„Ø­Ø§Ù„Ø©',
        type: 'select',
        value: q.get('status') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...Enums.ContractStatus.map(v => ({ value: v, label: labels.ContractStatus[v] || v }))]
      });
      const company = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ©',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const from = mkField({ label: 'Ù…Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ©/ØªØ¬Ø¯ÙŠØ¯', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ©/ØªØ¬Ø¯ÙŠØ¯', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(search.wrap, status.wrap));
      controls.appendChild(mkTwoCols(company.wrap, from.wrap));
      controls.appendChild(mkTwoCols(to.wrap, document.createElement('div')));

      const apply = mkBtn('ØªØ·Ø¨ÙŠÙ‚', 'secondary', () => {
        const params = new URLSearchParams();
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        if (status.input.value) params.set('status', status.input.value);
        if (company.input.value) params.set('company', company.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/contracts?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const s = (q.get('s') || '').toLowerCase();
      const st = q.get('status') || '';
      const comp = q.get('company') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.contracts];
      if (s) items = items.filter(c => (c.title || '').toLowerCase().includes(s) || (c.contractNumber || '').toLowerCase().includes(s));
      if (st) items = items.filter(c => c.status === st);
      if (comp) items = items.filter(c => c.companyId === comp);
      if (fromTs) items = items.filter(c => {
        const dt = c.renewalDate || c.endDate;
        return dt && startOfDay(dt) >= startOfDay(fromTs);
      });
      if (toTs) items = items.filter(c => {
        const dt = c.renewalDate || c.endDate;
        return dt && startOfDay(dt) <= startOfDay(toTs);
      });
      items.sort((a, b) => ((a.renewalDate || a.endDate || Infinity) - (b.renewalDate || b.endDate || Infinity)));

      if (!items.length) {
        root.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«/Ø§Ù„ØªØµÙÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯', 'primary', () => openContractForm()),
          mkBtn('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ©', 'secondary', () => location.hash = '#/contracts')
        ]));
        return;
      }

      const rows = items.map(c => {
        const title = document.createElement('div');
        title.innerHTML = `<div class="font-semibold">${escapeHtml(c.title)}</div><div class="text-xs text-slate-500 mt-1">${escapeHtml(getCompanyName(c.companyId))}</div>`;

        const statusBadge = document.createElement('div');
        statusBadge.className = 'flex flex-col items-start gap-2';
        statusBadge.appendChild(mkBadge(labels.ContractStatus[c.status] || c.status, c.status === 'ACTIVE' ? 'emerald' : (c.status === 'EXPIRED' ? 'rose' : 'amber')));

        const dateInfo = document.createElement('div');
        dateInfo.className = 'text-xs text-slate-600';
        dateInfo.innerHTML = `Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${fmtDate(c.startDate)}<br/>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${fmtDate(c.endDate)}</b><br/>ØªØ¬Ø¯ÙŠØ¯: ${fmtDate(c.renewalDate)}`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('ÙØªØ­', 'secondary', () => location.hash = `#/contract?id=${encodeURIComponent(c.id)}`));
        actions.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openContractForm(c)));
        actions.appendChild(mkBtn('Ø­Ø°Ù', 'danger', () => {
          const ok = confirm(`Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ "${c.title}"ØŸ`);
          if (!ok) return;
          deleteContractCascade(c.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([title, statusBadge, dateInfo, actions]);
      });

      root.appendChild(mkTable(['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
    }

    function openContractForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ© *',
        type: 'select',
        value: (existing?.companyId || defaults.companyId || ''),
        options: [{ value: '', label: 'Ø§Ø®ØªØ± Ø´Ø±ÙƒØ©...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const fTitle = mkField({ label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø¯ *', value: existing?.title || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ ØµÙŠØ§Ù†Ø©...' });
      const fNumber = mkField({ label: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', value: existing?.contractNumber || '' });

      const fStart = mkField({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *', type: 'date', value: toISODate(existing?.startDate) });
      const fEnd = mkField({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© *', type: 'date', value: toISODate(existing?.endDate) });
      const fRenewal = mkField({ label: 'ØªØ§Ø±ÙŠØ® ØªØ¬Ø¯ÙŠØ¯/Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.renewalDate) });

      const fValue = mkField({ label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ *', type: 'number', value: existing?.value ?? '' });
      const fPayment = mkField({ label: 'Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹', value: existing?.paymentTerms || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø´Ù‡Ø±ÙŠ / Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ / Ø¯ÙØ¹Ø§Øª...' });
      const fStatus = mkField({
        label: 'Ø§Ù„Ø­Ø§Ù„Ø©',
        type: 'select',
        value: existing?.status || 'ACTIVE',
        options: Enums.ContractStatus.map(v => ({ value: v, label: labels.ContractStatus[v] || v }))
      });

      const fNotes = mkField({ label: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', type: 'textarea', rows: 4, value: existing?.notes || '' });

      body.appendChild(mkTwoCols(fCompany.wrap, fTitle.wrap));
      body.appendChild(mkTwoCols(fNumber.wrap, fStatus.wrap));
      body.appendChild(mkTwoCols(fStart.wrap, fEnd.wrap));
      body.appendChild(mkTwoCols(fRenewal.wrap, fValue.wrap));
      body.appendChild(fPayment.wrap);
      body.appendChild(fNotes.wrap);

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù‚Ø¯' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯',
        subtitle: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: Ø´Ø±ÙƒØ© + Ø¹Ù†ÙˆØ§Ù† + Ø¨Ø¯Ø§ÙŠØ© + Ù†Ù‡Ø§ÙŠØ© + Ù‚ÙŠÙ…Ø©.',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const title = fTitle.input.value.trim();
          const startDate = fromISODate(fStart.input.value);
          const endDate = fromISODate(fEnd.input.value);
          const value = toNumOrNull(fValue.input.value);
          if (!companyId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©.');
          if (!title) return alert('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø·Ù„ÙˆØ¨.');
          if (!startDate) return alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨.');
          if (!endDate) return alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨.');
          if (value === null) return alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø©.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            title,
            contractNumber: fNumber.input.value.trim() || null,
            startDate,
            endDate,
            value,
            paymentTerms: fPayment.input.value.trim() || null,
            renewalDate: fromISODate(fRenewal.input.value),
            status: fStatus.input.value,
            notes: fNotes.input.value.trim() || null,
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };

          upsert('contracts', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function deleteContractCascade(contractId) {
      state.contracts = state.contracts.filter(c => c.id !== contractId);
      state.tasks = state.tasks.filter(t => !(t.relatedType === 'CONTRACT' && t.relatedId === contractId));
      state.followups = state.followups.filter(f => f.contractId !== contractId);
    }

    function renderContractDetails(root, id) {
      const c = state.contracts.find(x => x.id === id);
      if (!c) {
        setPage('Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­ÙØ°Ù Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡.');
        root.appendChild(mkEmpty('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.', [mkBtn('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù‚ÙˆØ¯', 'secondary', () => location.hash = '#/contracts')]));
        return;
      }
      const companyName = getCompanyName(c.companyId);
      setPage(c.title, `Ø§Ù„Ø´Ø±ÙƒØ©: ${companyName}`, [
        mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openContractForm(c)),
        mkBtn('+ Ù…Ù‡Ù…Ø© Ù…Ø±ØªØ¨Ø·Ø©', 'primary', () => openTaskForm({ relatedType: 'CONTRACT', relatedId: c.id })),
        mkBtn('ÙØªØ­ Ø§Ù„Ø´Ø±ÙƒØ©', 'secondary', () => location.hash = `#/company?id=${encodeURIComponent(c.companyId)}`)
      ]);

      const top = document.createElement('div');
      top.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4';

      const basic = document.createElement('div');
      basic.className = 'lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      basic.innerHTML = `
        <div class="text-sm font-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="font-semibold mt-1">${escapeHtml(labels.ContractStatus[c.status] || c.status)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</div><div class="font-semibold mt-1">${escapeHtml(c.contractNumber || 'â€”')}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div><div class="font-semibold mt-1">${fmtDate(c.startDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</div><div class="font-semibold mt-1">${fmtDate(c.endDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬Ø¯ÙŠØ¯/Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div><div class="font-semibold mt-1">${fmtDate(c.renewalDate)}</div></div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯</div><div class="font-semibold mt-1">${escapeHtml(c.value ?? 'â€”')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(c.paymentTerms || 'â€”')}</div></div>
          <div class="md:col-span-2 p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div><div class="mt-1 whitespace-pre-wrap">${escapeHtml(c.notes || 'â€”')}</div></div>
        </div>
      `;

      const side = document.createElement('div');
      side.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      const next = c.renewalDate || c.endDate;
      const days = next ? Math.round((startOfDay(next) - startOfDay(nowTs())) / (24 * 60 * 60 * 1000)) : null;
      side.innerHTML = `
        <div class="text-sm font-bold">ØªÙ†Ø¨ÙŠÙ‡</div>
        <div class="mt-3 p-3 rounded-xl bg-slate-50 border border-slate-200">
          <div class="text-xs text-slate-500">Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ®</div>
          <div class="text-lg font-bold mt-1">${fmtDate(next)}</div>
          <div class="text-xs text-slate-600 mt-1">${days === null ? 'â€”' : (days >= 0 ? `Ø¨Ø¹Ø¯ ${days} ÙŠÙˆÙ…` : `Ù…Ù†Ø° ${Math.abs(days)} ÙŠÙˆÙ…`)}</div>
        </div>
        <div class="mt-4 text-xs text-slate-500">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${fmtDateTime(c.updatedAt)}</div>
      `;

      top.appendChild(basic);
      top.appendChild(side);
      root.appendChild(top);

      // Related tasks
      const related = state.tasks.filter(x => x.relatedType === 'CONTRACT' && x.relatedId === c.id)
        .map(x => ({ ...x, status: computeTaskStatus(x) }))
        .sort((a, b) => (a.dueDate || Infinity) - (b.dueDate || Infinity));

      const tasksBox = document.createElement('div');
      tasksBox.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      tasksBox.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">Ù…Ù‡Ø§Ù… Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯</div>
            <div class="text-xs text-slate-500 mt-1">${related.length} Ù…Ù‡Ù…Ø©</div>
          </div>
        </div>
      `;
      const list = document.createElement('div');
      list.className = 'mt-3 flex flex-col gap-2';
      if (!related.length) {
        list.appendChild(mkEmpty('Ø£Ø¶Ù Ù…Ù‡Ø§Ù… Ù…Ø«Ù„: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ØŒ ØªØ¬Ù‡ÙŠØ² Ù…Ø³ØªÙ†Ø¯Ø§ØªØŒ Ø¥Ù„Ø®.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', 'primary', () => openTaskForm({ relatedType: 'CONTRACT', relatedId: c.id }))
        ]));
      } else {
        related.forEach(tt => list.appendChild(taskRow(tt)));
      }
      tasksBox.appendChild(list);
      root.appendChild(tasksBox);
    }

    // =============================
    // Tasks
    // =============================
    function renderTasks(root, q) {
      setPage('Ø§Ù„Ù…Ù‡Ø§Ù…', 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ø¹ ÙÙ„Ø§ØªØ± (Ø§Ù„ÙŠÙˆÙ…/Ù…ØªØ£Ø®Ø±Ø©/Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©).', [
        mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', 'primary', () => openTaskForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const filter = mkField({
        label: 'ÙÙ„ØªØ± Ø³Ø±ÙŠØ¹',
        type: 'select',
        value: q.get('filter') || '',
        options: [
          { value: '', label: 'Ø§Ù„ÙƒÙ„' },
          { value: 'today', label: 'Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…' },
          { value: 'overdue', label: 'Ù…ØªØ£Ø®Ø±Ø©' },
          { value: 'open', label: 'ØºÙŠØ± Ù…Ù†ØªÙ‡ÙŠØ©' },
          { value: 'done', label: 'Ù…Ù†ØªÙ‡ÙŠØ©' }
        ]
      });
      const priority = mkField({
        label: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©',
        type: 'select',
        value: q.get('priority') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...Enums.TaskPriority.map(v => ({ value: v, label: labels.TaskPriority[v] || v }))]
      });
      const relatedType = mkField({
        label: 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·',
        type: 'select',
        value: q.get('rt') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...Enums.RelatedType.map(v => ({ value: v, label: labels.RelatedType[v] || v }))]
      });
      const search = mkField({ label: 'Ø¨Ø­Ø«', placeholder: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©...', value: q.get('s') || '' });

      controls.appendChild(mkTwoCols(filter.wrap, priority.wrap));
      controls.appendChild(mkTwoCols(relatedType.wrap, search.wrap));

      const apply = mkBtn('ØªØ·Ø¨ÙŠÙ‚', 'secondary', () => {
        const params = new URLSearchParams();
        if (filter.input.value) params.set('filter', filter.input.value);
        if (priority.input.value) params.set('priority', priority.input.value);
        if (relatedType.input.value) params.set('rt', relatedType.input.value);
        if (search.input.value.trim()) params.set('s', search.input.value.trim());
        location.hash = `#/tasks?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const today = startOfDay(nowTs());
      let items = state.tasks.map(t => ({ ...t, status: computeTaskStatus(t) }));

      const f = q.get('filter') || '';
      if (f === 'today') items = items.filter(t => t.dueDate && startOfDay(t.dueDate) === today && t.status !== 'DONE');
      if (f === 'overdue') items = items.filter(t => t.status === 'OVERDUE');
      if (f === 'open') items = items.filter(t => t.status !== 'DONE');
      if (f === 'done') items = items.filter(t => t.status === 'DONE');

      const pr = q.get('priority') || '';
      if (pr) items = items.filter(t => t.priority === pr);

      const rt = q.get('rt') || '';
      if (rt) items = items.filter(t => t.relatedType === rt);

      const s = (q.get('s') || '').toLowerCase();
      if (s) items = items.filter(t => (t.title || '').toLowerCase().includes(s));

      items.sort((a, b) => (a.status === 'OVERDUE' ? -1 : 0) - (b.status === 'OVERDUE' ? -1 : 0) || (a.dueDate || Infinity) - (b.dueDate || Infinity));

      if (!items.length) {
        root.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø©. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±.', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©', 'primary', () => openTaskForm()),
          mkBtn('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±', 'secondary', () => location.hash = '#/tasks')
        ]));
        return;
      }

      const list = document.createElement('div');
      list.className = 'mt-4 flex flex-col gap-2';
      items.forEach(t => list.appendChild(taskRow(t)));
      root.appendChild(list);
    }

    function openTaskForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fRelatedType = mkField({
        label: 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· *',
        type: 'select',
        value: existing?.relatedType || defaults.relatedType || 'COMPANY',
        options: Enums.RelatedType.map(v => ({ value: v, label: labels.RelatedType[v] || v }))
      });

      const fRelatedId = mkField({
        label: 'Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø· *',
        type: 'select',
        value: existing?.relatedId || defaults.relatedId || '',
        options: [{ value: '', label: 'â€”' }]
      });

      const fTitle = mkField({ label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *', value: existing?.title || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ ÙƒØ±Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙˆØ·' });
      const fDesc = mkField({ label: 'Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'textarea', rows: 3, value: existing?.description || '' });
      const fDue = mkField({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ *', type: 'date', value: toISODate(existing?.dueDate) });

      const fPriority = mkField({
        label: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©',
        type: 'select',
        value: existing?.priority || 'MEDIUM',
        options: Enums.TaskPriority.map(v => ({ value: v, label: labels.TaskPriority[v] || v }))
      });

      const fStatus = mkField({
        label: 'Ø§Ù„Ø­Ø§Ù„Ø©',
        type: 'select',
        value: existing?.status || 'NEW',
        options: Enums.TaskStatus.map(v => ({ value: v, label: labels.TaskStatus[v] || v }))
      });

      const fReminder = mkField({
        label: 'ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø£ÙŠØ§Ù…)',
        type: 'select',
        value: (existing?.reminderOffset ?? 1).toString(),
        options: [
          { value: '0', label: 'Ø¨Ø¯ÙˆÙ†' },
          { value: '1', label: 'Ù‚Ø¨Ù„ ÙŠÙˆÙ…' },
          { value: '2', label: 'Ù‚Ø¨Ù„ ÙŠÙˆÙ…ÙŠÙ†' },
          { value: '3', label: 'Ù‚Ø¨Ù„ 3 Ø£ÙŠØ§Ù…' },
          { value: '7', label: 'Ù‚Ø¨Ù„ Ø£Ø³Ø¨ÙˆØ¹' }
        ],
        help: 'ÙÙŠ Android Ø³ÙŠØªÙ… Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… WorkManager.'
      });

      function refreshRelatedOptions() {
        const rt = fRelatedType.input.value;
        let opts = [{ value: '', label: 'Ø§Ø®ØªØ±...' }];
        if (rt === 'COMPANY') opts = opts.concat(state.companies.map(c => ({ value: c.id, label: c.name })));
        if (rt === 'TENDER') opts = opts.concat(state.tenders.map(t => ({ value: t.id, label: `${t.title} â€” ${getCompanyName(t.companyId)}` })));
        if (rt === 'CONTRACT') opts = opts.concat(state.contracts.map(c => ({ value: c.id, label: `${c.title} â€” ${getCompanyName(c.companyId)}` })));
        fRelatedId.input.innerHTML = '';
        opts.forEach(o => {
          const el = document.createElement('option');
          el.value = o.value;
          el.textContent = o.label;
          fRelatedId.input.appendChild(el);
        });

        // Keep current selection if exists
        const current = existing?.relatedId || defaults.relatedId || '';
        if (current && opts.some(o => o.value === current)) fRelatedId.input.value = current;
        else fRelatedId.input.value = '';
      }

      fRelatedType.input.addEventListener('change', refreshRelatedOptions);

      body.appendChild(mkTwoCols(fRelatedType.wrap, fRelatedId.wrap));
      body.appendChild(mkTwoCols(fTitle.wrap, fDue.wrap));
      body.appendChild(mkTwoCols(fPriority.wrap, fStatus.wrap));
      body.appendChild(fReminder.wrap);
      body.appendChild(fDesc.wrap);
      refreshRelatedOptions();

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©',
        subtitle: 'Ø§Ø±Ø¨Ø· Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø´Ø±ÙƒØ© Ø£Ùˆ Ù…Ù†Ø§Ù‚ØµØ© Ø£Ùˆ Ø¹Ù‚Ø¯.',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const relatedType = fRelatedType.input.value;
          const relatedId = fRelatedId.input.value;
          const title = fTitle.input.value.trim();
          const dueDate = fromISODate(fDue.input.value);
          if (!relatedType) return alert('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·.');
          if (!relatedId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·.');
          if (!title) return alert('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø·Ù„ÙˆØ¨.');
          if (!dueDate) return alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…Ø·Ù„ÙˆØ¨.');

          const obj = {
            id: existing?.id || uuid(),
            relatedType,
            relatedId,
            title,
            description: fDesc.input.value.trim() || null,
            dueDate,
            priority: fPriority.input.value,
            status: fStatus.input.value,
            reminderOffset: Number(fReminder.input.value || '0'),
            createdAt: existing?.createdAt || nowTs(),
            updatedAt: nowTs()
          };

          upsert('tasks', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    function updateTask(id, patch) {
      const idx = state.tasks.findIndex(t => t.id === id);
      if (idx < 0) return;
      state.tasks[idx] = { ...state.tasks[idx], ...patch };
      saveState(state);
    }

    // =============================
    // Follow-ups
    // =============================
    function renderFollowups(root, q) {
      setPage('Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª/Ø§Ù„Ø£Ù†Ø´Ø·Ø©', 'Ø³Ø¬Ù„ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨...', [
        mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©', 'primary', () => openFollowUpForm())
      ]);

      const controls = document.createElement('div');
      controls.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';

      const company = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ©',
        type: 'select',
        value: q.get('company') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });
      const type = mkField({
        label: 'Ø§Ù„Ù†ÙˆØ¹',
        type: 'select',
        value: q.get('type') || '',
        options: [{ value: '', label: 'Ø§Ù„ÙƒÙ„' }, ...Enums.FollowUpType.map(v => ({ value: v, label: labels.FollowUpType[v] || v }))]
      });
      const from = mkField({ label: 'Ù…Ù† ØªØ§Ø±ÙŠØ®', type: 'date', value: q.get('from') || '' });
      const to = mkField({ label: 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®', type: 'date', value: q.get('to') || '' });

      controls.appendChild(mkTwoCols(company.wrap, type.wrap));
      controls.appendChild(mkTwoCols(from.wrap, to.wrap));

      const apply = mkBtn('ØªØ·Ø¨ÙŠÙ‚', 'secondary', () => {
        const params = new URLSearchParams();
        if (company.input.value) params.set('company', company.input.value);
        if (type.input.value) params.set('type', type.input.value);
        if (from.input.value) params.set('from', from.input.value);
        if (to.input.value) params.set('to', to.input.value);
        location.hash = `#/followups?${params.toString()}`;
      });
      apply.classList.add('mt-3');
      controls.appendChild(apply);
      root.appendChild(controls);

      const comp = q.get('company') || '';
      const tp = q.get('type') || '';
      const fromTs = fromISODate(q.get('from') || '');
      const toTs = fromISODate(q.get('to') || '');

      let items = [...state.followups];
      if (comp) items = items.filter(f => f.companyId === comp);
      if (tp) items = items.filter(f => f.type === tp);
      if (fromTs) items = items.filter(f => f.dateTime && startOfDay(f.dateTime) >= startOfDay(fromTs));
      if (toTs) items = items.filter(f => f.dateTime && startOfDay(f.dateTime) <= startOfDay(toTs));
      items.sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0));

      if (!items.length) {
        root.appendChild(mkEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø´Ø±ÙƒØ© (ÙˆÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù…Ù†Ø§Ù‚ØµØ©/Ø¹Ù‚Ø¯).', [
          mkBtn('+ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©', 'primary', () => openFollowUpForm()),
          mkBtn('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±', 'secondary', () => location.hash = '#/followups')
        ]));
        return;
      }

      const rows = items.slice(0, 200).map(f => {
        const left = document.createElement('div');
        left.innerHTML = `<div class="font-semibold">${escapeHtml(labels.FollowUpType[f.type] || f.type)} â€¢ ${fmtDateTime(f.dateTime)}</div>
          <div class="text-xs text-slate-500 mt-1">Ø§Ù„Ø´Ø±ÙƒØ©: ${escapeHtml(getCompanyName(f.companyId))}</div>`;

        const mid = document.createElement('div');
        mid.className = 'text-xs text-slate-600';
        const tenderPart = f.tenderId ? `Ù…Ù†Ø§Ù‚ØµØ©: ${escapeHtml(getTenderTitle(f.tenderId))}<br/>` : '';
        const contractPart = f.contractId ? `Ø¹Ù‚Ø¯: ${escapeHtml(getContractTitle(f.contractId))}<br/>` : '';
        mid.innerHTML = `${tenderPart}${contractPart}Ø§Ù„Ø´Ø®Øµ: ${escapeHtml(f.contactName || 'â€”')}<br/>Ø§Ù„Ù…Ù„Ø®Øµ: ${escapeHtml(f.summary || 'â€”')}`;

        const right = document.createElement('div');
        right.className = 'text-xs text-slate-600';
        right.innerHTML = `Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: ${escapeHtml(f.nextStep || 'â€”')}<br/>ØªØ§Ø±ÙŠØ®Ù‡Ø§: <b>${fmtDate(f.nextStepDate)}</b>`;

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 justify-end';
        actions.appendChild(mkBtn('ØªØ¹Ø¯ÙŠÙ„', 'secondary', () => openFollowUpForm(f)));
        actions.appendChild(mkBtn('Ø­Ø°Ù', 'danger', () => {
          const ok = confirm('Ø­Ø°Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
          if (!ok) return;
          state.followups = state.followups.filter(x => x.id !== f.id);
          saveState(state);
          renderRoute();
        }));

        return mkTr([left, mid, right, actions]);
      });

      root.appendChild(mkTable(['Ø§Ù„Ù†Ø´Ø§Ø·', 'ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], rows));
    }

    function openFollowUpForm(existingOrDefaults = null) {
      const existing = (existingOrDefaults && existingOrDefaults.id) ? existingOrDefaults : null;
      const defaults = existing ? {} : (existingOrDefaults || {});
      const isEdit = !!existing;

      const body = document.createElement('div');

      const fCompany = mkField({
        label: 'Ø§Ù„Ø´Ø±ÙƒØ© *',
        type: 'select',
        value: existing?.companyId || defaults.companyId || '',
        options: [{ value: '', label: 'Ø§Ø®ØªØ± Ø´Ø±ÙƒØ©...' }, ...state.companies.map(c => ({ value: c.id, label: c.name }))]
      });

      const fType = mkField({
        label: 'Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·',
        type: 'select',
        value: existing?.type || 'CALL',
        options: Enums.FollowUpType.map(v => ({ value: v, label: labels.FollowUpType[v] || v }))
      });

      const fDateTime = mkField({ label: 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª *', type: 'datetime-local', value: toISODatetimeLocal(existing?.dateTime || nowTs()) });

      const fTender = mkField({ label: 'Ù…Ù†Ø§Ù‚ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'select', value: existing?.tenderId || '', options: [{ value: '', label: 'â€”' }] });
      const fContract = mkField({ label: 'Ø¹Ù‚Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'select', value: existing?.contractId || '', options: [{ value: '', label: 'â€”' }] });

      const fContact = mkField({ label: 'Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ', value: existing?.contactName || '', placeholder: 'Ù…Ø«Ø§Ù„: Ø£. Ù…Ø­Ù…Ø¯' });
      const fSummary = mkField({ label: 'Ù…Ù„Ø®Øµ *', type: 'textarea', rows: 4, value: existing?.summary || '' });
      const fNext = mkField({ label: 'Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', value: existing?.nextStep || '' });
      const fNextDate = mkField({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', type: 'date', value: toISODate(existing?.nextStepDate) });

      function refreshTenderContractOptions() {
        const companyId = fCompany.input.value;
        const tenders = state.tenders.filter(t => t.companyId === companyId);
        const contracts = state.contracts.filter(c => c.companyId === companyId);

        fTender.input.innerHTML = '';
        [{ value: '', label: 'â€”' }].concat(tenders.map(t => ({ value: t.id, label: t.title }))).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          fTender.input.appendChild(opt);
        });

        fContract.input.innerHTML = '';
        [{ value: '', label: 'â€”' }].concat(contracts.map(c => ({ value: c.id, label: c.title }))).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          fContract.input.appendChild(opt);
        });

        if (existing?.tenderId && tenders.some(t => t.id === existing.tenderId)) fTender.input.value = existing.tenderId; else fTender.input.value = '';
        if (existing?.contractId && contracts.some(c => c.id === existing.contractId)) fContract.input.value = existing.contractId; else fContract.input.value = '';
      }

      fCompany.input.addEventListener('change', refreshTenderContractOptions);

      body.appendChild(mkTwoCols(fCompany.wrap, fType.wrap));
      body.appendChild(mkTwoCols(fDateTime.wrap, fContact.wrap));
      body.appendChild(mkTwoCols(fTender.wrap, fContract.wrap));
      body.appendChild(fSummary.wrap);
      body.appendChild(mkTwoCols(fNext.wrap, fNextDate.wrap));

      refreshTenderContractOptions();

      openModal({
        title: isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØ§Ø¨Ø¹Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©',
        subtitle: 'Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø´Ø±ÙƒØ© (Ù…Ø·Ù„ÙˆØ¨) ÙˆØ¨Ù…Ù†Ø§Ù‚ØµØ©/Ø¹Ù‚Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).',
        hint: 'Ø­Ù‚ÙˆÙ„ * Ù…Ø·Ù„ÙˆØ¨Ø©.',
        okText: isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©',
        body,
        onOk: async (close) => {
          const companyId = fCompany.input.value;
          const type = fType.input.value;
          const dateTime = fromISODatetimeLocal(fDateTime.input.value);
          const summary = fSummary.input.value.trim();
          if (!companyId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©.');
          if (!dateTime) return alert('Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù…Ø·Ù„ÙˆØ¨.');
          if (!summary) return alert('Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ø·Ù„ÙˆØ¨.');

          const obj = {
            id: existing?.id || uuid(),
            companyId,
            tenderId: fTender.input.value || null,
            contractId: fContract.input.value || null,
            type,
            dateTime,
            contactName: fContact.input.value.trim() || null,
            summary,
            nextStep: fNext.input.value.trim() || null,
            nextStepDate: fromISODate(fNextDate.input.value)
          };

          upsert('followups', obj);
          saveState(state);
          close();
          renderRoute();
        }
      });
    }

    // =============================
    // Backup / Restore
    // =============================
    function renderBackup(root) {
      setPage('Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ / Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ù…Ø­Ù„ÙŠ (Ø¨Ø³ÙŠØ·).');

      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      card.innerHTML = `
        <div class="text-sm font-bold">ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <div class="text-xs text-slate-500 mt-1">Ù‡Ø°Ø§ ÙŠØµØ¯Ù‘Ø±/ÙŠØ³ØªÙˆØ±Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆÙŠØ¨. ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Android ÙŠÙˆØ¬Ø¯ Ù‡ÙŠÙƒÙ„ Backup/Restore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù JSON Ø¹Ø¨Ø± SAF.</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'mt-4 flex flex-col md:flex-row gap-2';

      const exportBtn = mkBtn('ØªØµØ¯ÙŠØ± JSON', 'primary', () => {
        const payload = {
          exportedAt: new Date().toISOString(),
          version: 1,
          data: state
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `tcrm_backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      const importWrap = document.createElement('div');
      importWrap.className = 'flex items-center gap-2';
      const file = document.createElement('input');
      file.type = 'file';
      file.accept = 'application/json';
      file.className = 'block text-sm';

      const importBtn = mkBtn('Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'secondary', async () => {
        const f = file.files?.[0];
        if (!f) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹.');
        const text = await f.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch { return alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.'); }
        const incoming = parsed.data || parsed;
        if (!incoming || typeof incoming !== 'object') return alert('Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± ØµØ§Ù„Ø­.');
        const ok = confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ');
        if (!ok) return;
        state = { ...defaultState(), ...incoming };
        saveState(state);
        alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
        renderRoute();
      });

      const wipeBtn = mkBtn('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'danger', () => {
        const ok = confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ');
        if (!ok) return;
        state = defaultState();
        saveState(state);
        renderRoute();
      });

      actions.appendChild(exportBtn);
      importWrap.appendChild(file);
      importWrap.appendChild(importBtn);
      actions.appendChild(importWrap);
      actions.appendChild(wipeBtn);

      card.appendChild(actions);
      root.appendChild(card);

      const help = document.createElement('div');
      help.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      help.innerHTML = `
        <div class="text-sm font-bold">Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Android</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <ul class="list-disc pr-5">
            <li>Ù†Ø³Ø®Ø© Android Ø³ØªØ³ØªØ®Ø¯Ù… Room Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·.</li>
            <li>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ/Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³ØªÙƒÙˆÙ† Ø¹Ø¨Ø± Ù…Ù„Ù JSON Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Storage Access Framework.</li>
            <li>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³ØªÙØ¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… WorkManager Ù…Ø¹ Ù‚Ù†ÙˆØ§Øª Ø¥Ø´Ø¹Ø§Ø± (NotificationChannel).</li>
          </ul>
        </div>
      `;
      root.appendChild(help);
    }

    // =============================
    // Android Project Generator
    // =============================
    function renderAndroidGenerator(root) {
      setPage('ØªÙˆÙ„ÙŠØ¯ Ù…Ø´Ø±ÙˆØ¹ Android Studio', 'ÙŠÙ†Ø´Ø¦ ZIP Ù„Ù…Ø´Ø±ÙˆØ¹ Kotlin + Jetpack Compose + Room + WorkManager (RTL Ø¹Ø±Ø¨ÙŠ) + MVVM.', [
        mkBtn('ØªØ­Ù…ÙŠÙ„ ZIP Ø§Ù„Ø¢Ù†', 'primary', () => downloadAndroidZip())
      ]);

      const card = document.createElement('div');
      card.className = 'bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      card.innerHTML = `
        <div class="text-sm font-bold">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
        <div class="text-xs text-slate-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø²Ù…Ø© ÙˆØ§Ù„Ù€ SDK ÙˆØ§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯. (Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø¹Ù…Ù„ÙŠØ© ÙˆØ¨Ø³ÙŠØ·Ø©)</div>
      `;

      const s = state.settings.android;

      const fAppName = mkField({ label: 'Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', value: s.appName });
      const fAppId = mkField({ label: 'applicationId', value: s.applicationId, placeholder: 'com.yourname.tendercrm' });
      const fPkg = mkField({ label: 'packageName', value: s.packageName, placeholder: 'com.yourname.tendercrm' });
      const fMin = mkField({ label: 'minSdk', type: 'number', value: s.minSdk });
      const fTarget = mkField({ label: 'targetSdk', type: 'number', value: s.targetSdk });

      const fKotlin = mkField({ label: 'Kotlin', value: s.kotlinVersion });
      const fAgp = mkField({ label: 'Android Gradle Plugin', value: s.agpVersion });
      const fComposeBom = mkField({ label: 'Compose BOM', value: s.composeBom });
      const fRoom = mkField({ label: 'Room', value: s.roomVersion });
      const fWork = mkField({ label: 'WorkManager', value: s.workVersion });
      const fNav = mkField({ label: 'Navigation Compose', value: s.navVersion });
      const fSer = mkField({ label: 'kotlinx.serialization', value: s.serializationVersion });

      const form = document.createElement('div');
      form.className = 'mt-4 grid grid-cols-1 md:grid-cols-2 gap-3';
      [fAppName, fAppId, fPkg, fMin, fTarget, fKotlin, fAgp, fComposeBom, fRoom, fWork, fNav, fSer].forEach(x => form.appendChild(x.wrap));

      const saveBtn = mkBtn('Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'secondary', () => {
        state.settings.android = {
          appName: fAppName.input.value.trim() || s.appName,
          applicationId: fAppId.input.value.trim() || s.applicationId,
          packageName: fPkg.input.value.trim() || s.packageName,
          minSdk: Number(fMin.input.value || s.minSdk),
          targetSdk: Number(fTarget.input.value || s.targetSdk),
          kotlinVersion: fKotlin.input.value.trim() || s.kotlinVersion,
          agpVersion: fAgp.input.value.trim() || s.agpVersion,
          composeBom: fComposeBom.input.value.trim() || s.composeBom,
          roomVersion: fRoom.input.value.trim() || s.roomVersion,
          workVersion: fWork.input.value.trim() || s.workVersion,
          navVersion: fNav.input.value.trim() || s.navVersion,
          serializationVersion: fSer.input.value.trim() || s.serializationVersion
        };
        saveState(state);
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ ZIP.');
      });
      saveBtn.classList.add('mt-3');

      card.appendChild(form);
      card.appendChild(saveBtn);
      root.appendChild(card);

      const arch = document.createElement('div');
      arch.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      arch.innerHTML = `
        <div class="text-sm font-bold">Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© (MVVM) + Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ø²Ù…</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <div class="text-xs text-slate-500">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ„Ù‘Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:</div>
          <pre class="mt-3 p-3 rounded-xl bg-slate-950 text-slate-100 overflow-auto text-xs"><code>\
${escapeHtml(renderPackageStructure())}\
</code></pre>
          <div class="mt-3 text-xs text-slate-600">
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Repository + ViewModel Ø¨Ø¯ÙˆÙ† DI framework (Ø¨Ø³ÙŠØ·). ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Hilt Ù„Ø§Ø­Ù‚Ø§Ù‹.
          </div>
        </div>
      `;
      root.appendChild(arch);

      const how = document.createElement('div');
      how.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      how.innerHTML = `
        <div class="text-sm font-bold">ÙƒÙŠÙ ØªØ´ØºÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Android StudioØŸ</div>
        <div class="text-sm text-slate-700 leading-7 mt-2">
          <ol class="list-decimal pr-5">
            <li>Ø§Ø¶ØºØ· <b>ØªØ­Ù…ÙŠÙ„ ZIP</b> Ø«Ù… ÙÙƒ Ø§Ù„Ø¶ØºØ·.</li>
            <li>Ø§ÙØªØ­ Android Studio â†’ <span class="kbd">Open</span> ÙˆØ§Ø®ØªØ± Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</li>
            <li>Ø§Ù†ØªØ¸Ø± Gradle Sync (Ù‚Ø¯ ÙŠØ·Ù„Ø¨ ØªÙ†Ø²ÙŠÙ„ SDK/Build Tools).</li>
            <li>Ø´ØºÙ‘Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¹Ø¨Ø± USB Ø£Ùˆ <span class="kbd">Build â†’ Build APK(s)</span>.</li>
          </ol>
          <div class="mt-3 text-xs text-slate-600">Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ù…Ø´ÙƒÙ„Ø© ØªÙˆØ§ÙÙ‚ Ø¥ØµØ¯Ø§Ø±Ø§Øª (AGP/Kotlin/Compose BOM)ØŒ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø«Ù… Ø£Ø¹Ø¯ ØªÙ†Ø²ÙŠÙ„ ZIP.</div>
        </div>
      `;
      root.appendChild(how);

      const preview = document.createElement('div');
      preview.className = 'mt-4 bg-white border border-slate-200 rounded-2xl p-4 shadow-soft';
      preview.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù…Ø§ Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡</div>
            <div class="text-xs text-slate-500 mt-1">Ù…Ù‚ØªØ·ÙØ§Øª (ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©) Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰.</div>
          </div>
          <button class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50" data-refresh>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        </div>
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4" data-previews></div>
      `;
      const previews = $('[data-previews]', preview);
      const refresh = () => {
        previews.innerHTML = '';
        const settings = state.settings.android;
        const samples = getAndroidFileSamples(settings);
        samples.forEach(s => {
          const el = document.createElement('div');
          el.className = 'border border-slate-200 rounded-2xl overflow-hidden';
          el.innerHTML = `
            <div class="px-3 py-2 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
              <div class="text-xs font-semibold">${escapeHtml(s.path)}</div>
              <div class="text-[11px] text-slate-500">Ù…Ù‚ØªØ·Ù</div>
            </div>
            <pre class="p-3 text-xs bg-slate-950 text-slate-100 overflow-auto max-h-64"><code>${escapeHtml(s.content)}</code></pre>
          `;
          previews.appendChild(el);
        });
      };
      $('[data-refresh]', preview).addEventListener('click', refresh);
      refresh();
      root.appendChild(preview);
    }

    function renderPackageStructure() {
      return `app/src/main/java/<package>/\
  App.kt\
  MainActivity.kt\
  di/\
    AppContainer.kt\
  data/\
    local/\
      AppDatabase.kt\
      Converters.kt\
      dao/\
        CompanyDao.kt\
        ContactDao.kt\
        TenderDao.kt\
        ContractDao.kt\
        TaskDao.kt\
        FollowUpDao.kt\
      entity/\
        CompanyEntity.kt\
        ContactEntity.kt\
        TenderEntity.kt\
        ContractEntity.kt\
        TaskEntity.kt\
        FollowUpEntity.kt\
      model/\
        Enums.kt\
  repo/\
    CompanyRepository.kt\
    TenderRepository.kt\
    ContractRepository.kt\
    TaskRepository.kt\
    FollowUpRepository.kt\
  ui/\
    navigation/\
      Routes.kt\
      AppNavHost.kt\
    screens/\
      DashboardScreen.kt\
      CompaniesScreen.kt\
      CompanyDetailsScreen.kt\
      TendersScreen.kt\
      TenderDetailsScreen.kt\
      ContractsScreen.kt\
      ContractDetailsScreen.kt\
      TasksScreen.kt\
      FollowUpsScreen.kt\
      BackupRestoreScreen.kt\
    components/\
      Ui.kt\
    theme/\
      Theme.kt\
  vm/\
    DashboardViewModel.kt\
    CompaniesViewModel.kt\
    CompanyDetailsViewModel.kt\
    TendersViewModel.kt\
    TenderDetailsViewModel.kt\
    ContractsViewModel.kt\
    ContractDetailsViewModel.kt\
    TasksViewModel.kt\
    FollowUpsViewModel.kt\
  notify/\
    NotificationWorker.kt\
    NotificationScheduler.kt\
  backup/\
    BackupModels.kt\
    BackupService.kt`;
    }

    function getAndroidFileSamples(settings) {
      const pkg = settings.packageName;
      const samplePaths = [
        { path: 'app/build.gradle.kts', content: androidTemplates.appBuildGradle(settings).split('\n').slice(0, 70).join('\n') + '\nâ€¦' },
        { path: 'MainActivity.kt', content: androidTemplates.mainActivity(settings).split('\n').slice(0, 90).join('\n') + '\nâ€¦' },
        { path: 'CompanyEntity.kt', content: androidTemplates.companyEntity(settings).split('\n').slice(0, 120).join('\n') + '\nâ€¦' },
        { path: 'NotificationScheduler.kt', content: androidTemplates.notificationScheduler(settings).split('\n').slice(0, 140).join('\n') + '\nâ€¦' }
      ];
      return samplePaths;
    }

    async function downloadAndroidZip() {
      // persist current settings first
      saveState(state);
      const settings = state.settings.android;

      // Basic validation
      if (!/^[a-zA-Z0-9_.]+$/.test(settings.applicationId)) {
        alert('applicationId ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
      }
      if (!/^[a-zA-Z0-9_.]+$/.test(settings.packageName)) {
        alert('packageName ØºÙŠØ± ØµØ§Ù„Ø­.');
        return;
      }

      const zip = await buildAndroidZip(settings);
      const blob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `TenderCRM_Android_${settings.applicationId}.zip`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function packageToPath(pkg) {
      return pkg.split('.').join('/');
    }

    async function buildAndroidZip(settings) {
      const zip = new JSZip();
      const pkgPath = packageToPath(settings.packageName);

      // Root files
      zip.file('settings.gradle.kts', androidTemplates.settingsGradle(settings));
      zip.file('build.gradle.kts', androidTemplates.rootBuildGradle(settings));
      zip.file('gradle.properties', androidTemplates.gradleProperties(settings));
      zip.file('README.md', androidTemplates.readme(settings));

      // app module
      zip.file('app/build.gradle.kts', androidTemplates.appBuildGradle(settings));
      zip.file('app/proguard-rules.pro', androidTemplates.proguard());
      zip.file('app/src/main/AndroidManifest.xml', androidTemplates.manifest(settings));

      // resources
      zip.file('app/src/main/res/values/strings.xml', androidTemplates.strings(settings));
      zip.file('app/src/main/res/values/themes.xml', androidTemplates.themes(settings));
      zip.file('app/src/main/res/xml/backup_rules.xml', androidTemplates.backupRules());
      zip.file('app/src/main/res/drawable/ic_launcher_background.xml', androidTemplates.launcherBg());
      zip.file('app/src/main/res/drawable-v24/ic_launcher_foreground.xml', androidTemplates.launcherFg());
      zip.file('app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml', androidTemplates.launcherXml());
      zip.file('app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml', androidTemplates.launcherXmlRound());

      // Kotlin sources
      const base = `app/src/main/java/${pkgPath}`;
      zip.file(`${base}/App.kt`, androidTemplates.appKt(settings));
      zip.file(`${base}/MainActivity.kt`, androidTemplates.mainActivity(settings));

      zip.file(`${base}/di/AppContainer.kt`, androidTemplates.appContainer(settings));

      zip.file(`${base}/data/model/Enums.kt`, androidTemplates.enumsKt(settings));

      zip.file(`${base}/data/local/Converters.kt`, androidTemplates.converters(settings));
      zip.file(`${base}/data/local/AppDatabase.kt`, androidTemplates.database(settings));

      zip.file(`${base}/data/local/entity/CompanyEntity.kt`, androidTemplates.companyEntity(settings));
      zip.file(`${base}/data/local/entity/ContactEntity.kt`, androidTemplates.contactEntity(settings));
      zip.file(`${base}/data/local/entity/TenderEntity.kt`, androidTemplates.tenderEntity(settings));
      zip.file(`${base}/data/local/entity/ContractEntity.kt`, androidTemplates.contractEntity(settings));
      zip.file(`${base}/data/local/entity/TaskEntity.kt`, androidTemplates.taskEntity(settings));
      zip.file(`${base}/data/local/entity/FollowUpEntity.kt`, androidTemplates.followUpEntity(settings));

      zip.file(`${base}/data/local/dao/CompanyDao.kt`, androidTemplates.companyDao(settings));
      zip.file(`${base}/data/local/dao/ContactDao.kt`, androidTemplates.contactDao(settings));
      zip.file(`${base}/data/local/dao/TenderDao.kt`, androidTemplates.tenderDao(settings));
      zip.file(`${base}/data/local/dao/ContractDao.kt`, androidTemplates.contractDao(settings));
      zip.file(`${base}/data/local/dao/TaskDao.kt`, androidTemplates.taskDao(settings));
      zip.file(`${base}/data/local/dao/FollowUpDao.kt`, androidTemplates.followUpDao(settings));

      zip.file(`${base}/repo/CompanyRepository.kt`, androidTemplates.companyRepo(settings));
      zip.file(`${base}/repo/TenderRepository.kt`, androidTemplates.tenderRepo(settings));
      zip.file(`${base}/repo/ContractRepository.kt`, androidTemplates.contractRepo(settings));
      zip.file(`${base}/repo/TaskRepository.kt`, androidTemplates.taskRepo(settings));
      zip.file(`${base}/repo/FollowUpRepository.kt`, androidTemplates.followUpRepo(settings));

      zip.file(`${base}/ui/theme/Theme.kt`, androidTemplates.themeKt(settings));
      zip.file(`${base}/ui/components/Ui.kt`, androidTemplates.uiComponents(settings));

      zip.file(`${base}/ui/navigation/Routes.kt`, androidTemplates.routes(settings));
      zip.file(`${base}/ui/navigation/AppNavHost.kt`, androidTemplates.navHost(settings));

      zip.file(`${base}/ui/screens/DashboardScreen.kt`, androidTemplates.dashboardScreen(settings));
      zip.file(`${base}/ui/screens/CompaniesScreen.kt`, androidTemplates.companiesScreen(settings));
      zip.file(`${base}/ui/screens/CompanyDetailsScreen.kt`, androidTemplates.companyDetailsScreen(settings));
      zip.file(`${base}/ui/screens/TendersScreen.kt`, androidTemplates.tendersScreen(settings));
      zip.file(`${base}/ui/screens/TenderDetailsScreen.kt`, androidTemplates.tenderDetailsScreen(settings));
      zip.file(`${base}/ui/screens/ContractsScreen.kt`, androidTemplates.contractsScreen(settings));
      zip.file(`${base}/ui/screens/ContractDetailsScreen.kt`, androidTemplates.contractDetailsScreen(settings));
      zip.file(`${base}/ui/screens/TasksScreen.kt`, androidTemplates.tasksScreen(settings));
      zip.file(`${base}/ui/screens/FollowUpsScreen.kt`, androidTemplates.followupsScreen(settings));
      zip.file(`${base}/ui/screens/BackupRestoreScreen.kt`, androidTemplates.backupRestoreScreen(settings));

      zip.file(`${base}/vm/DashboardViewModel.kt`, androidTemplates.dashboardVm(settings));
      zip.file(`${base}/vm/CompaniesViewModel.kt`, androidTemplates.companiesVm(settings));
      zip.file(`${base}/vm/CompanyDetailsViewModel.kt`, androidTemplates.companyDetailsVm(settings));
      zip.file(`${base}/vm/TendersViewModel.kt`, androidTemplates.tendersVm(settings));
      zip.file(`${base}/vm/TenderDetailsViewModel.kt`, androidTemplates.tenderDetailsVm(settings));
      zip.file(`${base}/vm/ContractsViewModel.kt`, androidTemplates.contractsVm(settings));
      zip.file(`${base}/vm/ContractDetailsViewModel.kt`, androidTemplates.contractDetailsVm(settings));
      zip.file(`${base}/vm/TasksViewModel.kt`, androidTemplates.tasksVm(settings));
      zip.file(`${base}/vm/FollowUpsViewModel.kt`, androidTemplates.followupsVm(settings));

      zip.file(`${base}/notify/NotificationWorker.kt`, androidTemplates.notificationWorker(settings));
      zip.file(`${base}/notify/NotificationScheduler.kt`, androidTemplates.notificationScheduler(settings));

      zip.file(`${base}/backup/BackupModels.kt`, androidTemplates.backupModels(settings));
      zip.file(`${base}/backup/BackupService.kt`, androidTemplates.backupService(settings));

      // Tests placeholders
      zip.file('app/src/test/java/' + pkgPath + '/ExampleUnitTest.kt', androidTemplates.unitTest(settings));
      zip.file('app/src/androidTest/java/' + pkgPath + '/ExampleInstrumentedTest.kt', androidTemplates.instrumentedTest(settings));

      return zip;
    }

    const androidTemplates = {
      settingsGradle: (s) => `pluginManagement {\n  repositories {\n    google()\n    mavenCentral()\n    gradlePluginPortal()\n  }\n}\n\ndependencyResolutionManagement {\n  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)\n  repositories {\n    google()\n    mavenCentral()\n  }\n}\n\nrootProject.name = "TenderCRM"\ninclude(":app")\n`,

      rootBuildGradle: (s) => `plugins {\n  id("com.android.application") version "${s.agpVersion}" apply false\n  id("org.jetbrains.kotlin.android") version "${s.kotlinVersion}" apply false\n  id("com.google.devtools.ksp") version "${s.kotlinVersion}-1.0.20" apply false\n  id("org.jetbrains.kotlin.plugin.serialization") version "${s.kotlinVersion}" apply false\n}\n`,

      gradleProperties: () => `org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8\nandroid.useAndroidX=true\nkotlin.code.style=official\nandroid.nonTransitiveRClass=true\n`,

      appBuildGradle: (s) => `plugins {\n  id("com.android.application")\n  id("org.jetbrains.kotlin.android")\n  id("com.google.devtools.ksp")\n  id("org.jetbrains.kotlin.plugin.serialization")\n}\n\nandroid {\n  namespace = "${s.packageName}"\n  compileSdk = ${s.targetSdk}\n\n  defaultConfig {\n    applicationId = "${s.applicationId}"\n    minSdk = ${s.minSdk}\n    targetSdk = ${s.targetSdk}\n    versionCode = 1\n    versionName = "1.0"\n\n    testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"\n    vectorDrawables {\n      useSupportLibrary = true\n    }\n  }\n\n  buildTypes {\n    release {\n      isMinifyEnabled = false\n      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")\n    }\n  }\n\n  compileOptions {\n    sourceCompatibility = JavaVersion.VERSION_17\n    targetCompatibility = JavaVersion.VERSION_17\n  }\n  kotlinOptions {\n    jvmTarget = "17"\n  }\n\n  buildFeatures {\n    compose = true\n  }\n\n  composeOptions {\n    // Compose compiler is managed by the Kotlin plugin in recent versions\n  }\n\n  packaging {\n    resources {\n      excludes += "/META-INF/{AL2.0,LGPL2.1}"\n    }\n  }\n}\n\ndependencies {\n  val composeBom = platform("androidx.compose:compose-bom:${s.composeBom}")\n  implementation(composeBom)\n  androidTestImplementation(composeBom)\n\n  implementation("androidx.core:core-ktx:1.15.0")\n  implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.8.7")\n  implementation("androidx.activity:activity-compose:1.9.3")\n\n  // Compose\n  implementation("androidx.compose.ui:ui")\n  implementation("androidx.compose.ui:ui-tooling-preview")\n  implementation("androidx.compose.material3:material3")\n  implementation("androidx.navigation:navigation-compose:${s.navVersion}")\n  implementation("androidx.lifecycle:lifecycle-runtime-compose:2.8.7")\n\n  // Room (KSP)\n  implementation("androidx.room:room-runtime:${s.roomVersion}")\n  implementation("androidx.room:room-ktx:${s.roomVersion}")\n  ksp("androidx.room:room-compiler:${s.roomVersion}")\n\n  // WorkManager\n  implementation("androidx.work:work-runtime-ktx:${s.workVersion}")\n\n  // Coroutines\n  implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.9.0")\n\n  // Serialization (JSON)\n  implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:${s.serializationVersion}")\n\n  // Tests\n  testImplementation("junit:junit:4.13.2")\n  androidTestImplementation("androidx.test.ext:junit:1.2.1")\n  androidTestImplementation("androidx.test.espresso:espresso-core:3.6.1")\n  androidTestImplementation("androidx.compose.ui:ui-test-junit4")\n\n  debugImplementation("androidx.compose.ui:ui-tooling")\n  debugImplementation("androidx.compose.ui:ui-test-manifest")\n}\n`,

      proguard: () => `# Keep it simple for v1\n`,

      manifest: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<manifest xmlns:android="http://schemas.android.com/apk/res/android">\n\n  <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />\n\n  <application\n    android:name=".${'App'}"\n    android:allowBackup="true"\n    android:dataExtractionRules="@xml/backup_rules"\n    android:fullBackupContent="@xml/backup_rules"\n    android:icon="@mipmap/ic_launcher"\n    android:label="@string/app_name"\n    android:roundIcon="@mipmap/ic_launcher_round"\n    android:supportsRtl="true"\n    android:theme="@style/Theme.TenderCRM">\n\n    <activity\n      android:name=".${'MainActivity'}"\n      android:exported="true">\n      <intent-filter>\n        <action android:name="android.intent.action.MAIN" />\n        <category android:name="android.intent.category.LAUNCHER" />\n      </intent-filter>\n    </activity>\n\n  </application>\n</manifest>\n`,

      strings: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<resources>\n  <string name="app_name">${escapeXml(s.appName)}</string>\n</resources>\n`,

      themes: (s) => `<?xml version="1.0" encoding="utf-8"?>\n<resources xmlns:tools="http://schemas.android.com/tools">\n  <style name="Theme.TenderCRM" parent="android:Theme.Material.Light.NoActionBar">\n    <item name="android:statusBarColor">@android:color/transparent</item>\n    <item name="android:navigationBarColor">@android:color/transparent</item>\n  </style>\n</resources>\n`,

      backupRules: () => `<?xml version="1.0" encoding="utf-8"?>\n<full-backup-content>\n  <exclude domain="cache" />\n</full-backup-content>\n`,

      launcherBg: () => `<?xml version="1.0" encoding="utf-8"?>\n<vector xmlns:android="http://schemas.android.com/apk/res/android"\n  android:width="108dp"\n  android:height="108dp"\n  android:viewportWidth="108"\n  android:viewportHeight="108">\n  <path android:fillColor="#0F172A" android:pathData="M0,0h108v108h-108z"/>\n</vector>\n`,
      launcherFg: () => `<?xml version="1.0" encoding="utf-8"?>\n<vector xmlns:android="http://schemas.android.com/apk/res/android"\n  android:width="108dp"\n  android:height="108dp"\n  android:viewportWidth="108"\n  android:viewportHeight="108">\n  <path\n    android:fillColor="#FFFFFF"\n    android:pathData="M54,20c-7.7,0-14,6.3-14,14v40c0,7.7 6.3,14 14,14s14-6.3 14-14V34c0-7.7-6.3-14-14-14zm0,10c2.2,0 4,1.8 4,4v40c0,2.2-1.8,4-4,4s-4-1.8-4-4V34c0-2.2 1.8-4 4-4z" />\n</vector>\n`,
      launcherXml: () => `<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@drawable/ic_launcher_background" />\n  <foreground android:drawable="@drawable/ic_launcher_foreground" />\n</adaptive-icon>\n`,
      launcherXmlRound: () => `<?xml version="1.0" encoding="utf-8"?>\n<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">\n  <background android:drawable="@drawable/ic_launcher_background" />\n  <foreground android:drawable="@drawable/ic_launcher_foreground" />\n</adaptive-icon>\n`,

      readme: (s) => `# ${s.appName}\n\nØªØ·Ø¨ÙŠÙ‚ Ø´Ø®ØµÙŠ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª/Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª/Ø§Ù„Ø¹Ù‚ÙˆØ¯/Ø§Ù„Ù…Ù‡Ø§Ù…/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª.\n\n## Ø§Ù„ØªØ´ØºÙŠÙ„\n1) ÙÙƒ Ø§Ù„Ø¶ØºØ·\n2) Ø§ÙØªØ­ Android Studio â†’ Open\n3) Gradle Sync\n4) Run\n\n## Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n- Room + WorkManager + Jetpack Compose\n- UI Ø¹Ø±Ø¨ÙŠØ© RTL (LayoutDirection.Rtl)\n- Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ¨Ø¯ÙˆÙ† Backend\n`,

      appKt: (s) => `package ${s.packageName}\n\nimport android.app.Application\nimport ${s.packageName}.di.AppContainer\n\nclass App : Application() {\n  lateinit var container: AppContainer\n    private set\n\n  override fun onCreate() {\n    super.onCreate()\n    container = AppContainer(this)\n  }\n}\n`,

      mainActivity: (s) => `package ${s.packageName}\n\nimport android.os.Bundle\nimport androidx.activity.ComponentActivity\nimport androidx.activity.compose.setContent\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Surface\nimport androidx.compose.runtime.CompositionLocalProvider\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.platform.LocalLayoutDirection\nimport androidx.compose.ui.unit.LayoutDirection\nimport ${s.packageName}.ui.navigation.AppNavHost\nimport ${s.packageName}.ui.theme.TenderCRMTheme\n\nclass MainActivity : ComponentActivity() {\n  override fun onCreate(savedInstanceState: Bundle?) {\n    super.onCreate(savedInstanceState)\n\n    setContent {\n      TenderCRMTheme {\n        CompositionLocalProvider(LocalLayoutDirection provides LayoutDirection.Rtl) {\n          Surface(modifier = Modifier.fillMaxSize(), color = MaterialTheme.colorScheme.background) {\n            AppNavHost()\n          }\n        }\n      }\n    }\n  }\n}\n`,

      appContainer: (s) => `package ${s.packageName}.di\n\nimport android.content.Context\nimport ${s.packageName}.data.local.AppDatabase\nimport ${s.packageName}.notify.NotificationScheduler\nimport ${s.packageName}.repo.CompanyRepository\nimport ${s.packageName}.repo.ContractRepository\nimport ${s.packageName}.repo.FollowUpRepository\nimport ${s.packageName}.repo.TaskRepository\nimport ${s.packageName}.repo.TenderRepository\n\nclass AppContainer(private val appContext: Context) {\n\n  private val db: AppDatabase by lazy {\n    AppDatabase.build(appContext)\n  }\n\n  val notificationScheduler: NotificationScheduler by lazy {\n    NotificationScheduler(appContext)\n  }\n\n  val companyRepository: CompanyRepository by lazy { CompanyRepository(db.companyDao()) }\n  val tenderRepository: TenderRepository by lazy { TenderRepository(db.tenderDao(), db.companyDao()) }\n  val contractRepository: ContractRepository by lazy { ContractRepository(db.contractDao(), db.companyDao()) }\n  val taskRepository: TaskRepository by lazy { TaskRepository(db.taskDao(), db.companyDao(), db.tenderDao(), db.contractDao()) }\n  val followUpRepository: FollowUpRepository by lazy { FollowUpRepository(db.followUpDao(), db.companyDao()) }\n}\n`,

      enumsKt: (s) => `package ${s.packageName}.data.model\n\nenum class TenderType { TENDER, PRACTICE, CONTRACT, DIRECT_SALE }\n\nenum class TenderStatus {\n  PREPARATION, OFFER_IN_PROGRESS, SUBMITTED, AWARDED, LOST, IN_PROGRESS, COMPLETED\n}\n\nenum class ContractStatus { ACTIVE, EXPIRED, SUSPENDED }\n\nenum class RelatedType { COMPANY, TENDER, CONTRACT }\n\nenum class TaskPriority { HIGH, MEDIUM, LOW }\n\nenum class TaskStatus { NEW, IN_PROGRESS, DONE, OVERDUE }\n\nenum class FollowUpType { CALL, VISIT, EMAIL, WHATSAPP, OTHER }\n`,

      converters: (s) => `package ${s.packageName}.data.local\n\nimport androidx.room.TypeConverter\nimport java.time.Instant\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.time.ZoneId\n\nobject Converters {\n\n  @TypeConverter\n  fun fromLocalDate(value: LocalDate?): Long? = value?.toEpochDay()\n\n  @TypeConverter\n  fun toLocalDate(value: Long?): LocalDate? = value?.let { LocalDate.ofEpochDay(it) }\n\n  @TypeConverter\n  fun fromLocalDateTime(value: LocalDateTime?): Long? = value?.atZone(ZoneId.systemDefault())?.toInstant()?.toEpochMilli()\n\n  @TypeConverter\n  fun toLocalDateTime(value: Long?): LocalDateTime? = value?.let {\n    LocalDateTime.ofInstant(Instant.ofEpochMilli(it), ZoneId.systemDefault())\n  }\n}\n`,

      database: (s) => `package ${s.packageName}.data.local\n\nimport android.content.Context\nimport androidx.room.Database\nimport androidx.room.Room\nimport androidx.room.RoomDatabase\nimport androidx.room.TypeConverters\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContactDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.dao.FollowUpDao\nimport ${s.packageName}.data.local.dao.TaskDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport ${s.packageName}.data.local.entity.ContactEntity\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\n\n@Database(\n  entities = [\n    CompanyEntity::class,\n    ContactEntity::class,\n    TenderEntity::class,\n    ContractEntity::class,\n    TaskEntity::class,\n    FollowUpEntity::class\n  ],\n  version = 1,\n  exportSchema = true\n)\n@TypeConverters(Converters::class)\nabstract class AppDatabase : RoomDatabase() {\n  abstract fun companyDao(): CompanyDao\n  abstract fun contactDao(): ContactDao\n  abstract fun tenderDao(): TenderDao\n  abstract fun contractDao(): ContractDao\n  abstract fun taskDao(): TaskDao\n  abstract fun followUpDao(): FollowUpDao\n\n  companion object {\n    fun build(context: Context): AppDatabase {\n      return Room.databaseBuilder(context, AppDatabase::class.java, "tender_crm.db")\n        .fallbackToDestructiveMigration()\n        .build()\n    }\n  }\n}\n`,

      companyEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.PrimaryKey\nimport java.time.LocalDateTime\n\n@Entity(tableName = "companies")\ndata class CompanyEntity(\n  @PrimaryKey val id: String,\n  val name: String,\n  val sector: String?,\n  val address: String?,\n  val phone1: String?,\n  val phone2: String?,\n  val email: String?,\n  val website: String?,\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      contactEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\n\n@Entity(\n  tableName = "contacts",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId")]\n)\ndata class ContactEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val name: String,\n  val role: String?,\n  val mobile: String?,\n  val email: String?,\n  val notes: String?\n)\n`,

      tenderEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.TenderStatus\nimport ${s.packageName}.data.model.TenderType\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "tenders",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("status"), Index("type")]\n)\ndata class TenderEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val title: String,\n  val refNumber: String?,\n  val type: TenderType,\n  val status: TenderStatus,\n\n  val docsPurchaseDeadline: LocalDate?,\n  val submissionDeadline: LocalDate,\n  val technicalOpeningDate: LocalDate?,\n  val financialOpeningDate: LocalDate?,\n  val awardDate: LocalDate?,\n\n  val expectedValue: Double?,\n  val finalValue: Double?,\n  val primaryGuarantee: Double?,\n  val finalGuarantee: Double?,\n  val margin: Double?,\n\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      contractEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.ContractStatus\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "contracts",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("status")]\n)\ndata class ContractEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val title: String,\n  val contractNumber: String?,\n  val startDate: LocalDate,\n  val endDate: LocalDate,\n  val value: Double,\n  val paymentTerms: String?,\n  val renewalDate: LocalDate?,\n  val status: ContractStatus,\n  val notes: String?,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      taskEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.RelatedType\nimport ${s.packageName}.data.model.TaskPriority\nimport ${s.packageName}.data.model.TaskStatus\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "tasks",\n  indices = [Index("relatedType"), Index("relatedId"), Index("status"), Index("dueDate")]\n)\ndata class TaskEntity(\n  @PrimaryKey val id: String,\n  val relatedType: RelatedType,\n  val relatedId: String,\n  val title: String,\n  val description: String?,\n  val dueDate: LocalDate,\n  val priority: TaskPriority,\n  val status: TaskStatus,\n  val reminderOffset: Int,\n  val createdAt: LocalDateTime,\n  val updatedAt: LocalDateTime\n)\n`,

      followUpEntity: (s) => `package ${s.packageName}.data.local.entity\n\nimport androidx.room.Entity\nimport androidx.room.ForeignKey\nimport androidx.room.Index\nimport androidx.room.PrimaryKey\nimport ${s.packageName}.data.model.FollowUpType\nimport java.time.LocalDate\nimport java.time.LocalDateTime\n\n@Entity(\n  tableName = "followups",\n  foreignKeys = [\n    ForeignKey(\n      entity = CompanyEntity::class,\n      parentColumns = ["id"],\n      childColumns = ["companyId"],\n      onDelete = ForeignKey.CASCADE\n    )\n  ],\n  indices = [Index("companyId"), Index("type"), Index("dateTime")]\n)\ndata class FollowUpEntity(\n  @PrimaryKey val id: String,\n  val companyId: String,\n  val tenderId: String?,\n  val contractId: String?,\n  val type: FollowUpType,\n  val dateTime: LocalDateTime,\n  val contactName: String?,\n  val summary: String,\n  val nextStep: String?,\n  val nextStepDate: LocalDate?\n)\n`,

      companyDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Delete\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport androidx.room.Update\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface CompanyDao {\n\n  @Query("SELECT * FROM companies ORDER BY name COLLATE NOCASE")\n  fun observeAll(): Flow<List<CompanyEntity>>\n\n  @Query("SELECT * FROM companies WHERE id = :id")\n  fun observeById(id: String): Flow<CompanyEntity?>\n\n  @Query("SELECT * FROM companies WHERE id = :id")\n  suspend fun getById(id: String): CompanyEntity?\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: CompanyEntity)\n\n  @Update\n  suspend fun update(entity: CompanyEntity)\n\n  @Delete\n  suspend fun delete(entity: CompanyEntity)\n\n  @Query("DELETE FROM companies WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      contactDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.ContactEntity\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface ContactDao {\n  @Query("SELECT * FROM contacts WHERE companyId = :companyId ORDER BY name COLLATE NOCASE")\n  fun observeByCompany(companyId: String): Flow<List<ContactEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: ContactEntity)\n\n  @Query("DELETE FROM contacts WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      tenderDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TenderStatus\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface TenderDao {\n\n  @Query("SELECT * FROM tenders ORDER BY submissionDeadline ASC")\n  fun observeAll(): Flow<List<TenderEntity>>\n\n  @Query("SELECT * FROM tenders WHERE id = :id")\n  fun observeById(id: String): Flow<TenderEntity?>\n\n  @Query("SELECT * FROM tenders WHERE companyId = :companyId ORDER BY submissionDeadline ASC")\n  fun observeByCompany(companyId: String): Flow<List<TenderEntity>>\n\n  @Query("SELECT * FROM tenders WHERE status = :status ORDER BY submissionDeadline ASC")\n  fun observeByStatus(status: TenderStatus): Flow<List<TenderEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: TenderEntity)\n\n  @Query("DELETE FROM tenders WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      contractDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.model.ContractStatus\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface ContractDao {\n\n  @Query("SELECT * FROM contracts ORDER BY endDate ASC")\n  fun observeAll(): Flow<List<ContractEntity>>\n\n  @Query("SELECT * FROM contracts WHERE id = :id")\n  fun observeById(id: String): Flow<ContractEntity?>\n\n  @Query("SELECT * FROM contracts WHERE companyId = :companyId ORDER BY endDate ASC")\n  fun observeByCompany(companyId: String): Flow<List<ContractEntity>>\n\n  @Query("SELECT * FROM contracts WHERE status = :status ORDER BY endDate ASC")\n  fun observeByStatus(status: ContractStatus): Flow<List<ContractEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: ContractEntity)\n\n  @Query("DELETE FROM contracts WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      taskDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.Flow\nimport java.time.LocalDate\n\n@Dao\ninterface TaskDao {\n\n  @Query("SELECT * FROM tasks ORDER BY dueDate ASC")\n  fun observeAll(): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE id = :id")\n  fun observeById(id: String): Flow<TaskEntity?>\n\n  @Query("SELECT * FROM tasks WHERE relatedType = :relatedType AND relatedId = :relatedId ORDER BY dueDate ASC")\n  fun observeByRelated(relatedType: String, relatedId: String): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE dueDate = :date AND status != :doneStatus ORDER BY dueDate ASC")\n  fun observeDueOn(date: LocalDate, doneStatus: TaskStatus = TaskStatus.DONE): Flow<List<TaskEntity>>\n\n  @Query("SELECT * FROM tasks WHERE dueDate < :today AND status != :doneStatus ORDER BY dueDate ASC")\n  fun observeOverdue(today: LocalDate, doneStatus: TaskStatus = TaskStatus.DONE): Flow<List<TaskEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: TaskEntity)\n\n  @Query("UPDATE tasks SET status = :status WHERE id = :id")\n  suspend fun setStatus(id: String, status: TaskStatus)\n\n  @Query("DELETE FROM tasks WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      followUpDao: (s) => `package ${s.packageName}.data.local.dao\n\nimport androidx.room.Dao\nimport androidx.room.Insert\nimport androidx.room.OnConflictStrategy\nimport androidx.room.Query\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.model.FollowUpType\nimport kotlinx.coroutines.flow.Flow\n\n@Dao\ninterface FollowUpDao {\n\n  @Query("SELECT * FROM followups ORDER BY dateTime DESC")\n  fun observeAll(): Flow<List<FollowUpEntity>>\n\n  @Query("SELECT * FROM followups WHERE companyId = :companyId ORDER BY dateTime DESC")\n  fun observeByCompany(companyId: String): Flow<List<FollowUpEntity>>\n\n  @Query("SELECT * FROM followups WHERE type = :type ORDER BY dateTime DESC")\n  fun observeByType(type: FollowUpType): Flow<List<FollowUpEntity>>\n\n  @Insert(onConflict = OnConflictStrategy.REPLACE)\n  suspend fun upsert(entity: FollowUpEntity)\n\n  @Query("DELETE FROM followups WHERE id = :id")\n  suspend fun deleteById(id: String)\n}\n`,

      companyRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.Flow\n\nclass CompanyRepository(private val dao: CompanyDao) {\n  fun observeAll(): Flow<List<CompanyEntity>> = dao.observeAll()\n  fun observeById(id: String): Flow<CompanyEntity?> = dao.observeById(id)\n  suspend fun upsert(entity: CompanyEntity) = dao.upsert(entity)\n  suspend fun deleteById(id: String) = dao.deleteById(id)\n}\n`,

      tenderRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class TenderRow(\n  val tender: TenderEntity,\n  val companyName: String\n)\n\nclass TenderRepository(\n  private val tenderDao: TenderDao,\n  private val companyDao: CompanyDao\n) {\n\n  fun observeAllRows(): Flow<List<TenderRow>> = tenderDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "â€”"\n    }\n    list.map { TenderRow(it, companies[it.companyId] ?: "â€”") }\n  }\n\n  fun observeById(id: String) = tenderDao.observeById(id)\n\n  suspend fun upsert(entity: TenderEntity) = tenderDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = tenderDao.deleteById(id)\n}\n`,

      contractRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class ContractRow(\n  val contract: ContractEntity,\n  val companyName: String\n)\n\nclass ContractRepository(\n  private val contractDao: ContractDao,\n  private val companyDao: CompanyDao\n) {\n\n  fun observeAllRows(): Flow<List<ContractRow>> = contractDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "â€”"\n    }\n    list.map { ContractRow(it, companies[it.companyId] ?: "â€”") }\n  }\n\n  fun observeById(id: String) = contractDao.observeById(id)\n\n  suspend fun upsert(entity: ContractEntity) = contractDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = contractDao.deleteById(id)\n}\n`,

      taskRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.ContractDao\nimport ${s.packageName}.data.local.dao.TaskDao\nimport ${s.packageName}.data.local.dao.TenderDao\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.RelatedType\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class TaskRow(\n  val task: TaskEntity,\n  val relatedTitle: String\n)\n\nclass TaskRepository(\n  private val taskDao: TaskDao,\n  private val companyDao: CompanyDao,\n  private val tenderDao: TenderDao,\n  private val contractDao: ContractDao\n) {\n\n  fun observeAllRows(): Flow<List<TaskRow>> = taskDao.observeAll().map { list ->\n    list.map { t ->\n      val title = when (t.relatedType) {\n        RelatedType.COMPANY -> companyDao.getById(t.relatedId)?.name\n        RelatedType.TENDER -> tenderDao.observeById(t.relatedId) // Flow; not ideal for sync\n          .let { null }\n        RelatedType.CONTRACT -> contractDao.observeById(t.relatedId)\n          .let { null }\n      }\n      TaskRow(t, title ?: "â€”")\n    }\n  }\n\n  fun observeAll(): Flow<List<TaskEntity>> = taskDao.observeAll()\n\n  fun observeById(id: String) = taskDao.observeById(id)\n\n  suspend fun upsert(entity: TaskEntity) = taskDao.upsert(entity)\n\n  suspend fun setStatus(id: String, status: ${s.packageName}.data.model.TaskStatus) = taskDao.setStatus(id, status)\n\n  suspend fun deleteById(id: String) = taskDao.deleteById(id)\n}\n`,

      followUpRepo: (s) => `package ${s.packageName}.repo\n\nimport ${s.packageName}.data.local.dao.CompanyDao\nimport ${s.packageName}.data.local.dao.FollowUpDao\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.map\n\ndata class FollowUpRow(\n  val followUp: FollowUpEntity,\n  val companyName: String\n)\n\nclass FollowUpRepository(\n  private val followUpDao: FollowUpDao,\n  private val companyDao: CompanyDao\n) {\n  fun observeAllRows(): Flow<List<FollowUpRow>> = followUpDao.observeAll().map { list ->\n    val companies = list.map { it.companyId }.distinct().associateWith { id ->\n      companyDao.getById(id)?.name ?: "â€”"\n    }\n    list.map { FollowUpRow(it, companies[it.companyId] ?: "â€”") }\n  }\n\n  fun observeAll(): Flow<List<FollowUpEntity>> = followUpDao.observeAll()\n\n  suspend fun upsert(entity: FollowUpEntity) = followUpDao.upsert(entity)\n\n  suspend fun deleteById(id: String) = followUpDao.deleteById(id)\n}\n`,

      themeKt: (s) => `package ${s.packageName}.ui.theme\n\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.lightColorScheme\nimport androidx.compose.runtime.Composable\n\nprivate val LightColors = lightColorScheme(\n  primary = androidx.compose.ui.graphics.Color(0xFF0F172A),\n  secondary = androidx.compose.ui.graphics.Color(0xFF334155),\n  background = androidx.compose.ui.graphics.Color(0xFFF8FAFC),\n  surface = androidx.compose.ui.graphics.Color(0xFFFFFFFF)\n)\n\n@Composable\nfun TenderCRMTheme(content: @Composable () -> Unit) {\n  MaterialTheme(\n    colorScheme = LightColors,\n    typography = androidx.compose.material3.Typography(),\n    content = content\n  )\n}\n`,

      uiComponents: (s) => `package ${s.packageName}.ui.components\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.OutlinedButton\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.ui.Modifier\n\n@Composable\nfun TopActions(\n  primaryText: String,\n  onPrimary: () -> Unit,\n  secondaryText: String? = null,\n  onSecondary: (() -> Unit)? = null\n) {\n  Row(\n    modifier = Modifier.fillMaxWidth(),\n    horizontalArrangement = Arrangement.spacedBy(8.dp)\n  ) {\n    Button(onClick = onPrimary) { Text(primaryText) }\n    if (secondaryText != null && onSecondary != null) {\n      OutlinedButton(onClick = onSecondary) { Text(secondaryText) }\n    }\n  }\n}\n`,

      routes: (s) => `package ${s.packageName}.ui.navigation\n\nobject Routes {\n  const val Dashboard = "dashboard"\n  const val Companies = "companies"\n  const val CompanyDetails = "company/{id}"\n  const val Tenders = "tenders"\n  const val TenderDetails = "tender/{id}"\n  const val Contracts = "contracts"\n  const val ContractDetails = "contract/{id}"\n  const val Tasks = "tasks"\n  const val FollowUps = "followups"\n  const val BackupRestore = "backup"\n}\n`,

      navHost: (s) => `package ${s.packageName}.ui.navigation\n\nimport androidx.compose.runtime.Composable\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.navigation.NavType\nimport androidx.navigation.compose.NavHost\nimport androidx.navigation.compose.composable\nimport androidx.navigation.compose.rememberNavController\nimport androidx.navigation.navArgument\nimport ${s.packageName}.App\nimport ${s.packageName}.ui.screens.*\n\n@Composable\nfun AppNavHost() {\n  val navController = rememberNavController()\n  val app = LocalContext.current.applicationContext as App\n\n  NavHost(navController = navController, startDestination = Routes.Dashboard) {\n    composable(Routes.Dashboard) {\n      DashboardScreen(\n        nav = navController,\n        container = app.container\n      )\n    }\n    composable(Routes.Companies) { CompaniesScreen(navController, app.container) }\n    composable(Routes.CompanyDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      CompanyDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Tenders) { TendersScreen(navController, app.container) }\n    composable(Routes.TenderDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      TenderDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Contracts) { ContractsScreen(navController, app.container) }\n    composable(Routes.ContractDetails, arguments = listOf(navArgument("id") { type = NavType.StringType })) { backStack ->\n      ContractDetailsScreen(navController, app.container, backStack.arguments?.getString("id") ?: "")\n    }\n    composable(Routes.Tasks) { TasksScreen(navController, app.container) }\n    composable(Routes.FollowUps) { FollowUpsScreen(navController, app.container) }\n    composable(Routes.BackupRestore) { BackupRestoreScreen(navController, app.container) }\n  }\n}\n`,

      dashboardScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.ui.navigation.Routes\nimport ${s.packageName}.vm.DashboardViewModel\n\n@Composable\nfun DashboardScreen(nav: NavController, container: AppContainer) {\n  val vm = DashboardViewModel(container)\n  val ui by vm.ui.collectAsState()\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text("Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", style = MaterialTheme.typography.titleLarge)\n      Text("Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      QuickNavCard {\n        nav.navigate(Routes.Companies)\n      }\n    }\n\n    item {\n      SectionCard(title = "Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…", subtitle = "${'$'}{ui.tasksDueToday.size} Ù…Ù‡Ù…Ø©") {\n        ui.tasksDueToday.take(5).forEach { Text("â€¢ ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©", subtitle = "${'$'}{ui.overdueTasks.size} Ù…Ù‡Ù…Ø©") {\n        ui.overdueTasks.take(5).forEach { Text("â€¢ ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù†Ø§Ù‚ØµØ§Øª Ù‚Ø±ÙŠØ¨Ø©", subtitle = "${'$'}{ui.upcomingTenderDeadlines.size} Ù…ÙˆØ¹Ø¯") {\n        ui.upcomingTenderDeadlines.take(5).forEach { Text("â€¢ ${'$'}{it.title}") }\n      }\n    }\n\n    item {\n      SectionCard(title = "Ø¹Ù‚ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/Ø§Ù„ØªØ¬Ø¯ÙŠØ¯", subtitle = "${'$'}{ui.upcomingContractDates.size} Ø¹Ù‚Ø¯") {\n        ui.upcomingContractDates.take(5).forEach { Text("â€¢ ${'$'}{it.title}") }\n      }\n    }\n  }\n}\n\n@Composable\nprivate fun QuickNavCard(onCompanies: () -> Unit) {\n  Card {\n    Column(modifier = Modifier.padding(16.dp)) {\n      Text("ØªÙ†Ù‚Ù„ Ø³Ø±ÙŠØ¹", style = MaterialTheme.typography.titleMedium)\n      Text("Ø§ÙØªØ­ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„", style = MaterialTheme.typography.bodySmall)\n    }\n  }\n}\n\n@Composable\nprivate fun SectionCard(title: String, subtitle: String, content: @Composable () -> Unit) {\n  Card {\n    Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n      Text(title, style = MaterialTheme.typography.titleMedium)\n      Text(subtitle, style = MaterialTheme.typography.bodySmall)\n      content()\n    }\n  }\n}\n`,

      companiesScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.Row\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.OutlinedButton\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.ui.navigation.Routes\nimport ${s.packageName}.vm.CompaniesViewModel\n\n@Composable\nfun CompaniesScreen(nav: NavController, container: AppContainer) {\n  val vm = CompaniesViewModel(container)\n  val companies by vm.companies.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween) {\n        Column {\n          Text("Ø§Ù„Ø´Ø±ÙƒØ§Øª", style = MaterialTheme.typography.titleLarge)\n          Text("Ø¨Ø­Ø«/ØªØµÙÙŠØ© Ø³ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹", style = MaterialTheme.typography.bodySmall)\n        }\n        Button(onClick = { vm.addSampleCompany() }) { Text("+ Ø¥Ø¶Ø§ÙØ©") }\n      }\n    }\n\n    items(companies, key = { it.id }) { c ->\n      Card(\n        modifier = Modifier.fillMaxWidth().clickable {\n          nav.navigate("company/${'$'}{c.id}")\n        }\n      ) {\n        Column(modifier = Modifier.padding(16.dp)) {\n          Text(c.name, style = MaterialTheme.typography.titleMedium)\n          Text(c.sector ?: "â€”", style = MaterialTheme.typography.bodySmall)\n          Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {\n            OutlinedButton(onClick = { vm.delete(c.id) }) { Text("Ø­Ø°Ù") }\n          }\n        }\n      }\n    }\n  }\n}\n`,

      companyDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.CompanyDetailsViewModel\n\n@Composable\nfun CompanyDetailsScreen(nav: NavController, container: AppContainer, companyId: String) {\n  val vm = CompanyDetailsViewModel(container, companyId)\n  val company by vm.company.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(company?.name ?: "Ø´Ø±ÙƒØ©", style = MaterialTheme.typography.titleLarge)\n      Text("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("Ø§Ù„Ù‚Ø·Ø§Ø¹: ${'$'}{company?.sector ?: "â€”"}")\n          Text("Ø§Ù„Ù‡Ø§ØªÙ: ${'$'}{company?.phone1 ?: "â€”"}")\n          Text("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${'$'}{company?.address ?: "â€”"}")\n          Text("Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${'$'}{company?.notes ?: "â€”"}")\n        }\n      }\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n          Text("Ù…Ù„Ø§Ø­Ø¸Ø©", style = MaterialTheme.typography.titleMedium)\n          Text("ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ù…Ø¨Ø³Ø·Ø©.\nØ£Ø¶Ù Tabs Ù„Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª/Ø§Ù„Ø¹Ù‚ÙˆØ¯/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª/Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹.")\n        }\n      }\n    }\n  }\n}\n`,

      tendersScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.TendersViewModel\n\n@Composable\nfun TendersScreen(nav: NavController, container: AppContainer) {\n  val vm = TendersViewModel(container)\n  val tenders by vm.tenders.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª", style = MaterialTheme.typography.titleLarge)\n        Text("Ø¨Ø­Ø«/ÙÙ„Ø§ØªØ± Ø³ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleTender() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ Ø¥Ø¶Ø§ÙØ©") }\n      }\n    }\n\n    items(tenders, key = { it.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(row.tender.title, style = MaterialTheme.typography.titleMedium)\n          Text("Ø§Ù„Ø´Ø±ÙƒØ©: ${'$'}{row.companyName}", style = MaterialTheme.typography.bodySmall)\n          Text("Ø§Ù„Ø­Ø§Ù„Ø©: ${'$'}{row.tender.status}")\n          Text("Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯: ${'$'}{row.tender.submissionDeadline}")\n        }\n      }\n    }\n  }\n}\n`,

      tenderDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.TenderDetailsViewModel\n\n@Composable\nfun TenderDetailsScreen(nav: NavController, container: AppContainer, tenderId: String) {\n  val vm = TenderDetailsViewModel(container, tenderId)\n  val tender by vm.tender.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(tender?.title ?: "Ù…Ù†Ø§Ù‚ØµØ©", style = MaterialTheme.typography.titleLarge)\n      Text("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("Ø§Ù„Ø­Ø§Ù„Ø©: ${'$'}{tender?.status ?: "â€”"}")\n          Text("Ø§Ù„Ù†ÙˆØ¹: ${'$'}{tender?.type ?: "â€”"}")\n          Text("Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯: ${'$'}{tender?.submissionDeadline ?: "â€”"}")\n          Text("Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${'$'}{tender?.notes ?: "â€”"}")\n        }\n      }\n    }\n  }\n}\n`,

      contractsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.ContractsViewModel\n\n@Composable\nfun ContractsScreen(nav: NavController, container: AppContainer) {\n  val vm = ContractsViewModel(container)\n  val contracts by vm.contracts.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("Ø§Ù„Ø¹Ù‚ÙˆØ¯", style = MaterialTheme.typography.titleLarge)\n        Text("Ø¨Ø­Ø«/ÙÙ„Ø§ØªØ± Ø³ØªÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleContract() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ Ø¥Ø¶Ø§ÙØ©") }\n      }\n    }\n\n    items(contracts, key = { it.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(row.contract.title, style = MaterialTheme.typography.titleMedium)\n          Text("Ø§Ù„Ø´Ø±ÙƒØ©: ${'$'}{row.companyName}", style = MaterialTheme.typography.bodySmall)\n          Text("Ø§Ù„Ø­Ø§Ù„Ø©: ${'$'}{row.contract.status}")\n          Text("Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${'$'}{row.contract.endDate}")\n        }\n      }\n    }\n  }\n}\n`,

      contractDetailsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.ContractDetailsViewModel\n\n@Composable\nfun ContractDetailsScreen(nav: NavController, container: AppContainer, contractId: String) {\n  val vm = ContractDetailsViewModel(container, contractId)\n  val contract by vm.contract.collectAsState(initial = null)\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text(contract?.title ?: "Ø¹Ù‚Ø¯", style = MaterialTheme.typography.titleLarge)\n      Text("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {\n          Text("Ø§Ù„Ø­Ø§Ù„Ø©: ${'$'}{contract?.status ?: "â€”"}")\n          Text("Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${'$'}{contract?.startDate ?: "â€”"}")\n          Text("Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${'$'}{contract?.endDate ?: "â€”"}")\n          Text("Ø§Ù„Ù‚ÙŠÙ…Ø©: ${'$'}{contract?.value ?: "â€”"}")\n          Text("Ø´Ø±ÙˆØ· Ø§Ù„Ø¯ÙØ¹: ${'$'}{contract?.paymentTerms ?: "â€”"}")\n        }\n      }\n    }\n  }\n}\n`,

      tasksScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.model.TaskStatus\nimport ${s.packageName}.vm.TasksViewModel\n\n@Composable\nfun TasksScreen(nav: NavController, container: AppContainer) {\n  val vm = TasksViewModel(container)\n  val tasks by vm.tasks.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("Ø§Ù„Ù…Ù‡Ø§Ù…", style = MaterialTheme.typography.titleLarge)\n        Text("ØªØ­Ø¯ÙŠØ¯ Ù…Ù†ØªÙ‡ÙŠØ©/Ù…ØªØ£Ø®Ø±Ø© Ø³ÙŠØªÙ… ØªØ­Ø³ÙŠÙ†Ù‡", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleTask() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ Ø¥Ø¶Ø§ÙØ©") }\n      }\n    }\n\n    items(tasks, key = { it.id }) { t ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text(t.title, style = MaterialTheme.typography.titleMedium)\n          Text("Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${'$'}{t.dueDate}")\n          Text("Ø§Ù„Ø­Ø§Ù„Ø©: ${'$'}{t.status}")\n          Button(onClick = { vm.markDone(t.id) }, enabled = t.status != TaskStatus.DONE) {\n            Text("ØªÙ…Øª")\n          }\n        }\n      }\n    }\n  }\n}\n`,

      followupsScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.fillMaxWidth\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.vm.FollowUpsViewModel\n\n@Composable\nfun FollowUpsScreen(nav: NavController, container: AppContainer) {\n  val vm = FollowUpsViewModel(container)\n  val followups by vm.followups.collectAsState(initial = emptyList())\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Column {\n        Text("Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª", style = MaterialTheme.typography.titleLarge)\n        Text("Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ø¢Ù†ØŒ Ø«Ù… ØªØ·ÙˆÙŠØ± ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹", style = MaterialTheme.typography.bodySmall)\n        Button(onClick = { vm.addSampleFollowUp() }, modifier = Modifier.padding(top = 8.dp)) { Text("+ Ø¥Ø¶Ø§ÙØ©") }\n      }\n    }\n\n    items(followups, key = { it.followUp.id }) { row ->\n      Card(modifier = Modifier.fillMaxWidth()) {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {\n          Text("${'$'}{row.followUp.type}", style = MaterialTheme.typography.titleMedium)\n          Text("Ø§Ù„Ø´Ø±ÙƒØ©: ${'$'}{row.companyName}")\n          Text("Ø§Ù„Ù…Ù„Ø®Øµ: ${'$'}{row.followUp.summary}")\n          Text("Ø§Ù„ØªØ§Ø±ÙŠØ®: ${'$'}{row.followUp.dateTime}")\n        }\n      }\n    }\n  }\n}\n`,

      backupRestoreScreen: (s) => `package ${s.packageName}.ui.screens\n\nimport android.net.Uri\nimport androidx.activity.compose.rememberLauncherForActivityResult\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.foundation.layout.Arrangement\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.PaddingValues\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Card\nimport androidx.compose.material3.MaterialTheme\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.remember\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavController\nimport ${s.packageName}.backup.BackupService\nimport ${s.packageName}.di.AppContainer\n\n@Composable\nfun BackupRestoreScreen(nav: NavController, container: AppContainer) {\n  val context = LocalContext.current\n  val backupService = remember { BackupService(context, container) }\n\n  val createJson = rememberLauncherForActivityResult(ActivityResultContracts.CreateDocument("application/json")) { uri: Uri? ->\n    if (uri != null) backupService.exportTo(uri)\n  }\n\n  val openJson = rememberLauncherForActivityResult(ActivityResultContracts.OpenDocument()) { uri: Uri? ->\n    if (uri != null) backupService.importFrom(uri)\n  }\n\n  LazyColumn(\n    modifier = Modifier.fillMaxSize(),\n    contentPadding = PaddingValues(16.dp),\n    verticalArrangement = Arrangement.spacedBy(12.dp)\n  ) {\n    item {\n      Text("Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ/Ø§Ø³ØªØ¹Ø§Ø¯Ø©", style = MaterialTheme.typography.titleLarge)\n      Text("ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON (Ù†Ø³Ø®Ø© Ø£ÙˆÙ„Ù‰)", style = MaterialTheme.typography.bodySmall)\n    }\n\n    item {\n      Card {\n        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {\n          Button(onClick = { createJson.launch("tender_crm_backup.json") }) { Text("ØªØµØ¯ÙŠØ± JSON") }\n          Button(onClick = { openJson.launch(arrayOf("application/json")) }) { Text("Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON") }\n          Text("Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ Upsert Ù„Ù„Ø¹Ù†Ø§ØµØ±.")\n        }\n      }\n    }\n  }\n}\n`,

      dashboardVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.MutableStateFlow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\n\ndata class DashboardUiState(\n  val tasksDueToday: List<TaskEntity> = emptyList(),\n  val overdueTasks: List<TaskEntity> = emptyList(),\n  val upcomingTenderDeadlines: List<TenderEntity> = emptyList(),\n  val upcomingContractDates: List<ContractEntity> = emptyList()\n)\n\nclass DashboardViewModel(private val container: AppContainer) : ViewModel() {\n\n  private val _ui = MutableStateFlow(DashboardUiState())\n  val ui: StateFlow<DashboardUiState> = _ui\n\n  init {\n    // Simple snapshot approach for v1\n    refresh()\n  }\n\n  private fun refresh() = viewModelScope.launch {\n    val today = LocalDate.now()\n    // For v1 we rely on flows in screens; here keep minimal
    container.taskRepository.observeAll().collect { tasks ->\n      val dueToday = tasks.filter { it.dueDate == today && it.status != TaskStatus.DONE }\n      val overdue = tasks.filter { it.dueDate.isBefore(today) && it.status != TaskStatus.DONE }\n      _ui.value = _ui.value.copy(tasksDueToday = dueToday, overdueTasks = overdue)\n    }\n  }\n}\n`,

      companiesVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass CompaniesViewModel(private val container: AppContainer) : ViewModel() {\n\n  val companies: StateFlow<List<CompanyEntity>> = container.companyRepository.observeAll()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleCompany() = viewModelScope.launch {\n    val now = LocalDateTime.now()\n    container.companyRepository.upsert(\n      CompanyEntity(\n        id = UUID.randomUUID().toString(),\n        name = "Ø´Ø±ÙƒØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©",\n        sector = "Ø®Ø§Øµ",\n        address = "â€”",\n        phone1 = "0500000000",\n        phone2 = null,\n        email = null,\n        website = null,\n        notes = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù„Ù„ØªØ¬Ø±Ø¨Ø©",\n        createdAt = now,\n        updatedAt = now\n      )\n    )\n  }\n\n  fun delete(id: String) = viewModelScope.launch {\n    container.companyRepository.deleteById(id)\n  }\n}\n`,

      companyDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.CompanyEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass CompanyDetailsViewModel(container: AppContainer, companyId: String) : ViewModel() {\n  val company: StateFlow<CompanyEntity?> = container.companyRepository.observeById(companyId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      tendersVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport ${s.packageName}.data.model.TenderStatus\nimport ${s.packageName}.data.model.TenderType\nimport ${s.packageName}.repo.TenderRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass TendersViewModel(private val container: AppContainer) : ViewModel() {\n\n  val tenders: StateFlow<List<TenderRow>> = container.tenderRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleTender() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val tender = TenderEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      title = "Ù…Ù†Ø§Ù‚ØµØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©",\n      refNumber = null,\n      type = TenderType.TENDER,\n      status = TenderStatus.PREPARATION,\n      docsPurchaseDeadline = null,\n      submissionDeadline = LocalDate.now().plusDays(7),\n      technicalOpeningDate = null,\n      financialOpeningDate = null,\n      awardDate = null,\n      expectedValue = null,\n      finalValue = null,\n      primaryGuarantee = null,\n      finalGuarantee = null,\n      margin = null,\n      notes = "â€”",\n      createdAt = now,\n      updatedAt = now\n    )\n    container.tenderRepository.upsert(tender)\n  }\n}\n`,

      tenderDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass TenderDetailsViewModel(container: AppContainer, tenderId: String) : ViewModel() {\n  val tender: StateFlow<TenderEntity?> = container.tenderRepository.observeById(tenderId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      contractsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.model.ContractStatus\nimport ${s.packageName}.repo.ContractRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass ContractsViewModel(private val container: AppContainer) : ViewModel() {\n\n  val contracts: StateFlow<List<ContractRow>> = container.contractRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleContract() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val contract = ContractEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      title = "Ø¹Ù‚Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠ",\n      contractNumber = null,\n      startDate = LocalDate.now(),\n      endDate = LocalDate.now().plusMonths(6),\n      value = 10000.0,\n      paymentTerms = "Ø´Ù‡Ø±ÙŠ",\n      renewalDate = null,\n      status = ContractStatus.ACTIVE,\n      notes = "â€”",\n      createdAt = now,\n      updatedAt = now\n    )\n    container.contractRepository.upsert(contract)\n  }\n}\n`,

      contractDetailsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\n\nclass ContractDetailsViewModel(container: AppContainer, contractId: String) : ViewModel() {\n  val contract: StateFlow<ContractEntity?> = container.contractRepository.observeById(contractId)\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), null)\n}\n`,

      tasksVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.model.RelatedType\nimport ${s.packageName}.data.model.TaskPriority\nimport ${s.packageName}.data.model.TaskStatus\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass TasksViewModel(private val container: AppContainer) : ViewModel() {\n\n  val tasks: StateFlow<List<TaskEntity>> = container.taskRepository.observeAll()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleTask() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n    val now = LocalDateTime.now()\n    val task = TaskEntity(\n      id = UUID.randomUUID().toString(),\n      relatedType = RelatedType.COMPANY,\n      relatedId = companies.first().id,\n      title = "Ù…Ù‡Ù…Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©",\n      description = "â€”",\n      dueDate = LocalDate.now().plusDays(1),\n      priority = TaskPriority.MEDIUM,\n      status = TaskStatus.NEW,\n      reminderOffset = 1,\n      createdAt = now,\n      updatedAt = now\n    )\n    container.taskRepository.upsert(task)\n\n    // schedule notification\n    container.notificationScheduler.scheduleTask(task)\n  }\n\n  fun markDone(id: String) = viewModelScope.launch {\n    container.taskRepository.setStatus(id, TaskStatus.DONE)\n    container.notificationScheduler.cancel("task_${'$'}id")\n  }\n}\n`,

      followupsVm: (s) => `package ${s.packageName}.vm\n\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport ${s.packageName}.di.AppContainer\nimport ${s.packageName}.data.local.entity.FollowUpEntity\nimport ${s.packageName}.data.model.FollowUpType\nimport ${s.packageName}.repo.FollowUpRow\nimport kotlinx.coroutines.flow.SharingStarted\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.stateIn\nimport kotlinx.coroutines.launch\nimport java.time.LocalDateTime\nimport java.util.UUID\n\nclass FollowUpsViewModel(private val container: AppContainer) : ViewModel() {\n\n  val followups: StateFlow<List<FollowUpRow>> = container.followUpRepository.observeAllRows()\n    .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), emptyList())\n\n  fun addSampleFollowUp() = viewModelScope.launch {\n    val companies = container.companyRepository.observeAll().stateIn(viewModelScope, SharingStarted.Eagerly, emptyList()).value\n    if (companies.isEmpty()) return@launch\n\n    val fu = FollowUpEntity(\n      id = UUID.randomUUID().toString(),\n      companyId = companies.first().id,\n      tenderId = null,\n      contractId = null,\n      type = FollowUpType.CALL,\n      dateTime = LocalDateTime.now(),\n      contactName = "â€”",\n      summary = "Ø§ØªØµØ§Ù„ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚",\n      nextStep = null,\n      nextStepDate = null\n    )\n    container.followUpRepository.upsert(fu)\n  }\n}\n`,

      notificationWorker: (s) => `package ${s.packageName}.notify\n\nimport android.app.NotificationChannel\nimport android.app.NotificationManager\nimport android.content.Context\nimport androidx.core.app.NotificationCompat\nimport androidx.core.app.NotificationManagerCompat\nimport androidx.work.CoroutineWorker\nimport androidx.work.WorkerParameters\nimport ${s.packageName}.R\n\nclass NotificationWorker(\n  appContext: Context,\n  params: WorkerParameters\n) : CoroutineWorker(appContext, params) {\n\n  override suspend fun doWork(): Result {\n    val title = inputData.getString(KEY_TITLE) ?: "ØªØ°ÙƒÙŠØ±"\n    val message = inputData.getString(KEY_MESSAGE) ?: ""\n\n    ensureChannel()\n\n    val notif = NotificationCompat.Builder(applicationContext, CHANNEL_ID)\n      .setSmallIcon(android.R.drawable.ic_dialog_info)\n      .setContentTitle(title)\n      .setContentText(message)\n      .setPriority(NotificationCompat.PRIORITY_HIGH)\n      .setAutoCancel(true)\n      .build()\n\n    NotificationManagerCompat.from(applicationContext).notify((System.currentTimeMillis() % Int.MAX_VALUE).toInt(), notif)\n    return Result.success()\n  }\n\n  private fun ensureChannel() {\n    val nm = applicationContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\n    val channel = NotificationChannel(CHANNEL_ID, "ØªØ°ÙƒÙŠØ±Ø§Øª", NotificationManager.IMPORTANCE_HIGH)\n    nm.createNotificationChannel(channel)\n  }\n\n  companion object {\n    const val CHANNEL_ID = "reminders"\n    const val KEY_TITLE = "title"\n    const val KEY_MESSAGE = "message"\n  }\n}\n`,

      notificationScheduler: (s) => `package ${s.packageName}.notify\n\nimport android.content.Context\nimport androidx.work.ExistingWorkPolicy\nimport androidx.work.OneTimeWorkRequestBuilder\nimport androidx.work.WorkManager\nimport androidx.work.workDataOf\nimport ${s.packageName}.data.local.entity.ContractEntity\nimport ${s.packageName}.data.local.entity.TaskEntity\nimport ${s.packageName}.data.local.entity.TenderEntity\nimport java.time.LocalDate\nimport java.time.LocalDateTime\nimport java.time.ZoneId\nimport java.util.concurrent.TimeUnit\n\nclass NotificationScheduler(private val context: Context) {\n\n  private val wm: WorkManager by lazy { WorkManager.getInstance(context) }\n\n  fun scheduleTask(task: TaskEntity) {\n    val reminderDays = task.reminderOffset\n    val triggerDate = task.dueDate.minusDays(reminderDays.toLong())\n    val title = "ØªØ°ÙƒÙŠØ± Ù…Ù‡Ù…Ø©"\n    val message = task.title\n    scheduleAt(workName = "task_${'$'}{task.id}", localDate = triggerDate, title = title, message = message)\n  }\n\n  fun scheduleTenderDeadline(tender: TenderEntity, daysBefore: Long = 2) {\n    val triggerDate = tender.submissionDeadline.minusDays(daysBefore)\n    scheduleAt(\n      workName = "tender_${'$'}{tender.id}",\n      localDate = triggerDate,\n      title = "Ù…ÙˆØ¹Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù†Ø§Ù‚ØµØ©",\n      message = "${'$'}{tender.title}"\n    )\n  }\n\n  fun scheduleContractRenewal(contract: ContractEntity, daysBefore: Long = 14) {\n    val next = contract.renewalDate ?: contract.endDate\n    val triggerDate = next.minusDays(daysBefore)\n    scheduleAt(\n      workName = "contract_${'$'}{contract.id}",\n      localDate = triggerDate,\n      title = "ØªØ¬Ø¯ÙŠØ¯/Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù‚Ø¯",\n      message = "${'$'}{contract.title}"\n    )\n  }\n\n  fun cancel(workName: String) {\n    wm.cancelUniqueWork(workName)\n  }\n\n  private fun scheduleAt(workName: String, localDate: LocalDate, title: String, message: String) {\n    val now = System.currentTimeMillis()\n    val triggerMillis = localDate.atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()\n    val delay = (triggerMillis - now).coerceAtLeast(0L)\n\n    val req = OneTimeWorkRequestBuilder<NotificationWorker>()\n      .setInitialDelay(delay, TimeUnit.MILLISECONDS)\n      .setInputData(workDataOf(\n        NotificationWorker.KEY_TITLE to title,\n        NotificationWorker.KEY_MESSAGE to message\n      ))\n      .build()\n\n    wm.enqueueUniqueWork(workName, ExistingWorkPolicy.REPLACE, req)\n  }\n}\n`,

      backupModels: (s) => `package ${s.packageName}.backup\n\nimport kotlinx.serialization.Serializable\nimport ${s.packageName}.data.local.entity.*\n\n@Serializable\ndata class BackupPayload(\n  val companies: List<CompanyEntitySer>,\n  val contacts: List<ContactEntitySer>,\n  val tenders: List<TenderEntitySer>,\n  val contracts: List<ContractEntitySer>,\n  val tasks: List<TaskEntitySer>,\n  val followups: List<FollowUpEntitySer>\n)\n\n// Serialization-friendly DTOs (Room entities contain java.time)\n@Serializable data class CompanyEntitySer(\n  val id: String,\n  val name: String,\n  val sector: String? = null,\n  val address: String? = null,\n  val phone1: String? = null,\n  val phone2: String? = null,\n  val email: String? = null,\n  val website: String? = null,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class ContactEntitySer(\n  val id: String,\n  val companyId: String,\n  val name: String,\n  val role: String? = null,\n  val mobile: String? = null,\n  val email: String? = null,\n  val notes: String? = null\n)\n\n@Serializable data class TenderEntitySer(\n  val id: String,\n  val companyId: String,\n  val title: String,\n  val refNumber: String? = null,\n  val type: String,\n  val status: String,\n  val docsPurchaseDeadlineEpochDay: Long? = null,\n  val submissionDeadlineEpochDay: Long,\n  val technicalOpeningDateEpochDay: Long? = null,\n  val financialOpeningDateEpochDay: Long? = null,\n  val awardDateEpochDay: Long? = null,\n  val expectedValue: Double? = null,\n  val finalValue: Double? = null,\n  val primaryGuarantee: Double? = null,\n  val finalGuarantee: Double? = null,\n  val margin: Double? = null,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class ContractEntitySer(\n  val id: String,\n  val companyId: String,\n  val title: String,\n  val contractNumber: String? = null,\n  val startDateEpochDay: Long,\n  val endDateEpochDay: Long,\n  val value: Double,\n  val paymentTerms: String? = null,\n  val renewalDateEpochDay: Long? = null,\n  val status: String,\n  val notes: String? = null,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class TaskEntitySer(\n  val id: String,\n  val relatedType: String,\n  val relatedId: String,\n  val title: String,\n  val description: String? = null,\n  val dueDateEpochDay: Long,\n  val priority: String,\n  val status: String,\n  val reminderOffset: Int,\n  val createdAtEpoch: Long,\n  val updatedAtEpoch: Long\n)\n\n@Serializable data class FollowUpEntitySer(\n  val id: String,\n  val companyId: String,\n  val tenderId: String? = null,\n  val contractId: String? = null,\n  val type: String,\n  val dateTimeEpoch: Long,\n  val contactName: String? = null,\n  val summary: String,\n  val nextStep: String? = null,\n  val nextStepDateEpochDay: Long? = null\n)\n`,

      backupService: (s) => `package ${s.packageName}.backup\n\nimport android.content.Context\nimport android.net.Uri\nimport android.widget.Toast\nimport androidx.core.net.toFile\nimport ${s.packageName}.di.AppContainer\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.launch\nimport kotlinx.serialization.encodeToString\nimport kotlinx.serialization.json.Json\n\nclass BackupService(\n  private val context: Context,\n  private val container: AppContainer\n) {\n\n  private val scope = CoroutineScope(Dispatchers.IO)\n  private val json = Json { prettyPrint = true; ignoreUnknownKeys = true }\n\n  fun exportTo(uri: Uri) {\n    scope.launch {\n      try {\n        // NOTE: For v1 we export only companies (extend to all tables)
        val companies = container.companyRepository.observeAll()\n          .stateIn(CoroutineScope(Dispatchers.IO), kotlinx.coroutines.flow.SharingStarted.Eagerly, emptyList()).value\n          .map { it.toSer() }\n\n        val payload = BackupPayload(\n          companies = companies,\n          contacts = emptyList(),\n          tenders = emptyList(),\n          contracts = emptyList(),\n          tasks = emptyList(),\n          followups = emptyList()\n        )\n        context.contentResolver.openOutputStream(uri)?.use { out ->\n          out.write(json.encodeToString(payload).toByteArray())\n        }\n        toast("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©")\n      } catch (t: Throwable) {\n        toast("ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: ${'$'}{t.message}")\n      }\n    }\n  }\n\n  fun importFrom(uri: Uri) {\n    scope.launch {\n      try {\n        val text = context.contentResolver.openInputStream(uri)?.use { it.readBytes().decodeToString() } ?: return@launch\n        val payload = json.decodeFromString(BackupPayload.serializer(), text)\n        // NOTE: for v1 import companies only
        payload.companies.forEach { ser ->\n          container.companyRepository.upsert(ser.toEntity())\n        }\n        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯")\n      } catch (t: Throwable) {\n        toast("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${'$'}{t.message}")\n      }\n    }\n  }\n\n  private fun toast(msg: String) {\n    CoroutineScope(Dispatchers.Main).launch {\n      Toast.makeText(context, msg, Toast.LENGTH_LONG).show()\n    }\n  }\n}\n\n// Mapping helpers\nprivate fun CompanyEntitySer.toEntity(): ${s.packageName}.data.local.entity.CompanyEntity {\n  val created = java.time.LocalDateTime.ofInstant(java.time.Instant.ofEpochMilli(createdAtEpoch), java.time.ZoneId.systemDefault())\n  val updated = java.time.LocalDateTime.ofInstant(java.time.Instant.ofEpochMilli(updatedAtEpoch), java.time.ZoneId.systemDefault())\n  return ${s.packageName}.data.local.entity.CompanyEntity(\n    id = id,\n    name = name,\n    sector = sector,\n    address = address,\n    phone1 = phone1,\n    phone2 = phone2,\n    email = email,\n    website = website,\n    notes = notes,\n    createdAt = created,\n    updatedAt = updated\n  )\n}\n\nprivate fun ${s.packageName}.data.local.entity.CompanyEntity.toSer(): CompanyEntitySer {\n  val created = this.createdAt.atZone(java.time.ZoneId.systemDefault()).toInstant().toEpochMilli()\n  val updated = this.updatedAt.atZone(java.time.ZoneId.systemDefault()).toInstant().toEpochMilli()\n  return CompanyEntitySer(\n    id = id,\n    name = name,\n    sector = sector,\n    address = address,\n    phone1 = phone1,\n    phone2 = phone2,\n    email = email,\n    website = website,\n    notes = notes,\n    createdAtEpoch = created,\n    updatedAtEpoch = updated\n  )\n}\n`,

      unitTest: (s) => `package ${s.packageName}\n\nimport org.junit.Test\n\nclass ExampleUnitTest {\n  @Test fun addition_isCorrect() {\n    assert(2 + 2 == 4)\n  }\n}\n`,

      instrumentedTest: (s) => `package ${s.packageName}\n\nimport androidx.test.ext.junit.runners.AndroidJUnit4\nimport org.junit.Test\nimport org.junit.runner.RunWith\n\n@RunWith(AndroidJUnit4::class)\nclass ExampleInstrumentedTest {\n  @Test fun useAppContext() {\n    // Placeholder\n  }\n}\n`
    };

    function escapeXml(s) {
      return (s ?? '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // =============================
    // Store operations
    // =============================
    function upsert(collection, obj) {
      state[collection] = state[collection] || [];
      const idx = state[collection].findIndex(x => x.id === obj.id);
      if (idx >= 0) state[collection][idx] = obj;
      else state[collection].push(obj);
    }

    // =============================
    // Boot
    // =============================
    mountShell();
  </script>
</body>

</html>